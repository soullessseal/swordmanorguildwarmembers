<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¹«æˆ°åå–®æ¯”å°å·¥å…· v18</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #ffffff;
      --line: #e2e8f0;
      --green: #dcfce7;
      --red: #fee2e2;
      --text: #0f172a;
      --radius: 0.75rem;
    }
    body {
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.25rem;
      font-size: 16px;
    }
    h1 { color: #fff; margin: 0 0 .75rem; }
    .layout {  display: grid;  grid-template-columns: 0.7fr 1.0fr 1.5fr 0.7fr; gap: 1rem;  align-items: flex-start;}
    .panel { background: var(--card); border-radius: var(--radius); padding: 1rem; border: 1px solid rgba(15, 23, 42, 0.05); box-shadow: 0 10px 30px rgba(0,0,0,.04); }
    #allMembersPanel { position: sticky; top: 1rem; z-index: 5; }
    .right-sticky-wrap { position: sticky; top: 1rem; z-index: 6; display: flex; flex-direction: column; gap: .6rem; }
    .right-actions-bar { display: flex; gap: .4rem; justify-content: flex-end; }
    .float-btn { background: #0ea5e9; border: none; color: #fff; padding: 0.35rem 0.75rem; border-radius: 999px; font-weight: 600; font-size: 0.78rem; cursor: pointer; white-space: nowrap; }
    .float-btn.secondary { background: #1f2937; }
    .float-btn.danger { background: #ef4444; }
    .member-search { width: 100%; padding: 0.4rem 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; margin-bottom: 0.5rem; font-size: 0.85rem; box-sizing: border-box; }
    .role-tabs { display: flex; flex-wrap: wrap; gap: .35rem; margin-bottom: .5rem; }
    .role-tab { padding: 0.25rem 0.6rem; border-radius: 999px; color: #0f172a; font-size: 0.73rem; cursor: pointer; border: 1px solid transparent; user-select: none; white-space: nowrap; }
    .role-tab.active { border: 1px solid #0f172a44; }
    .member-list { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.4rem; background: #f8fafc; }
    .member-item { display: flex; justify-content: space-between; gap: .35rem; align-items: center; background: #fff; border-radius: .35rem; padding: .3rem .35rem; margin-bottom: .3rem; border: 1px solid #e2e8f0; cursor: grab; }

/*V16.1æ–°å¢é¡¯ç¤ºç›®å‰å¹«çœ¾äººæ•¸*/
.guild-count {
  font-size: 0.78rem;
  color: #64748b;
  margin-left: 0.4rem;
}

    /* å·¦é‚Šï¼šåå­—ï¼‹æŠ€èƒ½æ”¹æˆå…©æ¬„å›ºå®šæ’ç‰ˆ */
.member-left {
  flex: 1 1 auto;
  min-width: 0;
  display: grid;
  grid-template-columns: 6.5em 1fr;   /* â† èª¿é€™å€‹å¯¬åº¦ï¼Œå¯ä»¥å¾®èª¿æŠ€èƒ½èµ·å§‹ä½ç½® */
  column-gap: .4rem;
  align-items: center;
}
/* åå­—ï¼šå¦‚æœå¤ªé•·å°±â€¦çœç•¥ */
.member-name {
  font-weight: 700;
  font-size: .9rem;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
/* æŠ€èƒ½æ–‡å­—é å·¦ã€ä¿æŒåŒä¸€è¡Œ */
.member-skill {
  font-size: .7rem;
  opacity: .7;
  white-space: nowrap;
}
/* V16.3åœ¨æŠ€èƒ½å‰é¢åŠ ä¸€å€‹ã€Œï½œã€ä½œç‚ºåˆ†éš” */
.member-skill::before {
  content: "ï½œ";
  margin: 0 .2rem 0 .2rem;   /* å·¦å³è·é›¢å¯ä»¥å†å¾®èª¿ */
  color: #cbd5e1;             /* æ·ºç°è‰²ï¼Œä¸æœƒå¤ªæ¶çœ¼ */
}

    .member-actions { display:flex; gap:.25rem; }
    .member-actions button { border:none; background:#e2e8f0; font-size:.65rem; border-radius:.35rem; padding:.25rem .45rem; cursor:pointer; }
    .pagination { display:flex; justify-content:center; gap:.35rem; margin-top:.4rem; }
    .pagination button { border:1px solid #cbd5e1; background:#fff; border-radius:.35rem; font-size:.65rem; padding:.25rem .45rem; cursor:pointer; }
    .pagination select { font-size:.7rem; }
    .add-member-form { margin-top: .35rem; display: none; flex-direction: column; gap: 0.3rem; width: 100%; }
    .add-member-form input, .add-member-form select { padding: 0.35rem 0.4rem; border: 1px solid #cbd5e1; border-radius: 0.4rem; font-size: 0.78rem; width: 100%; box-sizing: border-box; }

    .team-block { border: 1px solid var(--line); border-radius: 0.5rem; margin-bottom: 1rem; overflow: hidden; }
    .team-head { color: #fff; padding: 0.4rem 0.6rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; gap: .5rem; }
    .team-head-left { display:flex; align-items:center; gap:.4rem; }
    .team-tag-select { font-size: .78rem; font-weight: 700; border-radius: .35rem; border: none; padding: .2rem .45rem; background: rgba(255,255,255,0.95); color: #0f172a; line-height: 1.2; cursor: pointer; }
    .team-tag-select option { font-size: .78rem; font-weight: 600; color: #0f172a; }
    .team-tag-label { background: rgba(255,255,255,0.95); color: #0f172a; font-size: .78rem; font-weight: 700; border-radius: .35rem; padding: .2rem .55rem; }
    .head-add-btn { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.25); color: #fff; font-size: .65rem; border-radius: .35rem; padding: .2rem .45rem; cursor: pointer; }
    .head-add-btn.disabled { opacity:.35; cursor:not-allowed; }

    .squads { display: flex; flex-wrap: nowrap; border-top: 1px solid var(--line); width: 100%; }
    .squad { border-left: 1px solid var(--line); padding: 0.4rem 0.4rem 0.75rem; position: relative; flex: 1 1 auto; min-width: 0; }
    .squad:first-child { border-left: none; }
    .squad-title { background: #f8fafc; text-align: center; font-weight: 700; padding: 0.3rem; border-radius: 0.25rem; margin-bottom: 0.4rem; border: 1px solid #e2e8f0; font-size: 0.78rem; }
    .squad-del-btn { position: absolute; top: 6px; right: 6px; width: 22px; height: 22px; border: none; border-radius: 999px; background: #ef4444; color: #fff; font-size: 14px; line-height: 22px; text-align: center; cursor: pointer; padding: 0; }
    @media (max-width: 600px) { .squad-del-btn { top: 4px; right: 4px; width: 20px; height: 20px; line-height: 20px; font-size: 13px; } }

    /* V16.2æœ¬é€±åå–®åº•éƒ¨çš„åˆ‡æ›åœ“é»ï¼šæ¡Œæ©Ÿï¼‹æ‰‹æ©Ÿéƒ½é¡¯ç¤º */
    .team-dots {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: .5rem;
    }

    /*V16.2æ»‘å‹•å‹•ç•«*/
    /* å³é‚Šæ»‘é€²ä¾† */
@keyframes teamSlideFromRight {
  from {
    opacity: 0;
    transform: translateX(40px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
/* å·¦é‚Šæ»‘é€²ä¾† */
@keyframes teamSlideFromLeft {
  from {
    opacity: 0;
    transform: translateX(-40px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
/* æ ¹æ“š JS åŠ ä¸Šçš„ class æ’­æ”¾ä¸åŒæ–¹å‘çš„ slide */
#thisWeek .team-block.slide-from-right {
  animation: teamSlideFromRight .25s ease-out;
}
#thisWeek .team-block.slide-from-left {
  animation: teamSlideFromLeft .25s ease-out;
}



    /* V16è®“æ¨™é¡Œèˆ‡å„²å­˜æŒ‰éˆ•æ’åœ¨åŒä¸€è¡Œ */
.header-row {
  display: flex;
  align-items: center;
  gap: .75rem;           /* æ¨™é¡Œè·ŸæŒ‰éˆ•ä¹‹é–“ç•™ä¸€é»è·é›¢ */
  margin-bottom: 0.75rem;
  /* æŠŠé€™è¡Œæ‹¿æ‰ï¼šjustify-content: space-between; */
}
/* æ¡Œé¢ç‰ˆå„²å­˜æŒ‰éˆ•çš„æ¨£å¼ */
.save-btn-desktop {
  background: #ef4444;
  color: #fff;
  padding: 0.45rem 1.1rem;
  border-radius: 999rem;
  font-size: 0.95rem;
  margin-top: -0.73rem;
  cursor: pointer;
  border: none;
}
/* æ‰‹æ©Ÿç‰ˆä¸é¡¯ç¤ºæ¡Œé¢å„²å­˜æŒ‰éˆ• */
@media (max-width: 900px) {
  .save-btn-desktop {
    display: none;
  }
}
/* é›»è…¦ç‰ˆä¸é¡¯ç¤ºæ‰‹æ©Ÿå„²å­˜æŒ‰éˆ• */
@media (min-width: 901px) {
  .right-actions-bar {
    display: none !important;
  }
}

/*V16.1æ‰‹æ©Ÿç¿»é æ¢å¾©*/
   @media (max-width: 900px) {
  /* åªæ§åˆ¶æœ¬é€±åå–®çš„åœ˜éšŠç¿»é  */
  #thisWeek {
    overflow-x: visible;
    white-space: normal;
  }
  /* å¤–å±¤åŒ…åœ˜çš„å®¹å™¨ */
  #thisWeek .teams-wrap {
    position: relative;
    width: 100%;
  }
  /* æ¯ä¸€å€‹åœ˜ blockï¼šæ‰‹æ©Ÿæ™‚é è¨­éš±è— */
  #thisWeek .team-block {
    width: 100%;
    display: none;
  }
  /* åªæœ‰ active çš„é‚£ä¸€åœ˜æœƒé¡¯ç¤º */
  #thisWeek .team-block.active {
    display: block;
  }
  /* åœ˜è£¡é¢çš„éšŠä¼æ’ç‰ˆç¶­æŒåŸæœ¬çš„è¡Œç‚º */
  #thisWeek .team-block .squads {
    overflow-x: visible;
    width: 100%;
  }
  #thisWeek .team-block .squad {
    min-width: 0;
  }
}

/* âœ… V16.2æ‰€æœ‰è£ç½®å…±ç”¨çš„å°åœ“é»æ¨£å¼ï¼ˆæ¡Œæ©Ÿï¼‹æ‰‹æ©Ÿï¼‰ */
.team-dot {
  width: 10px;
  height: 10px;
  border-radius: 999px;
  border: none;
  padding: 0;
  opacity: 0.5;
  cursor: pointer;
  transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
}
.team-dot.active {
  opacity: 1;
  transform: scale(1.3);
  box-shadow: 0 0 0 1px rgba(15,23,42,.25);
}


    .member-row { display:flex; gap:.25rem; margin-bottom:.3rem; }
    /* é‡å°ã€Œæœ¬é€±åå–®ã€å…§çš„å°éšŠï¼Œå¾®èª¿æ¯ä¸€åˆ—çš„ä¸Šä¸‹è·é›¢ */
#thisWeek .squad .member-row:nth-child(odd) {
  margin-bottom: 0.2rem;  /* åå­—åˆ— â†’ è·ŸæŠ€èƒ½é è¿‘ä¸€é» */
}
#thisWeek .squad .member-row:nth-child(even) {
  margin-bottom: 0.5rem;  /* æŠ€èƒ½åˆ— â†’ å’Œä¸‹ä¸€ä½æˆå“¡ä¿æŒåŸæœ¬é–“è· */
}

    .member-row input { width: 100%; font-size: 0.78rem; padding: 0.3rem 0.35rem; border: 1px solid #cbd5f5; border-radius: 0.25rem; box-sizing: border-box; font-weight: 700; }
    .readonly-skill { background:#e2e8f0; }
    .locked-input { /*V14.8ä¿®æ”¹ï¼Œæ»‘é¼ å®Œå…¨ä¸èƒ½äº’å‹•*/
  background: #e2e8f0;
  pointer-events: none;     /* æ»‘é¼ é»ä¸åˆ° */
  user-select: none;        /* ä¸èƒ½é¸å–æ–‡å­— */
  caret-color: transparent; /* ä¸é¡¯ç¤ºè¼¸å…¥æ¸¸æ¨™ */
}

/* V17.4è·‘é¦¬ç‡ˆï¼šåªæœƒå¥—åœ¨è¢« JS åŠ ä¸Š .marquee çš„æ¬„ä½ */
#thisWeek .member-row input.marquee {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: clip;
  animation: tw-marquee 3s linear infinite;
}
/* V17.4åˆ©ç”¨ text-indent åšå·¦å³æ»‘å‹• */
@keyframes tw-marquee {
  0%   { text-indent: 0; }
  100% { text-indent: -100%; }
}
@keyframes tw-marquee {
  0%   { text-indent: 0; }
  10%  { text-indent: 0; }        /* åœä¸€ä¸‹ */
  100% { text-indent: -100%; }
}
#thisWeek .member-row input.marquee {
  animation: tw-marquee 5s linear infinite;
}

/* å¹«æœƒè·ä½æ¯”å°ï¼šå¹«çœ¾åœ¨è·ä½è£¡ï¼Œä½†æ²’å‡ºç¾åœ¨æœ¬é€± â†’ ç´…è‰²è† å›Š */
.position-tag.guild-missing-in-week {
  background: #fee2e2 !important;   /* æ·ºç´…åº• */
  color: #b91c1c !important;        /* æ·±ç´…å­— */
}

/* å¹«æœƒè·ä½æ¯”å°ï¼šæœ¬é€±æœ‰ä¸Šå ´ï¼Œä½†æ²’æ›å¹«çœ¾ â†’ ç¶ è‰²è† å›Šï¼ˆå‡ºç¾åœ¨å­¸å¾’æ¬„ä½ï¼‰ */
.position-tag.guild-from-week-only {
  background: #3A9267 !important;   /* æ·ºç¶ åº• */
  border-color: #14532d; /* å†æ·±ä¸€é»çš„é‚Šæ¡† */
  color: #ffffff !important;        /* æ·±ç¶ å­— */
  text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
}

/* V17æ–°å¢å­¸å¾’æ¨™ç±¤ç‹€æ…‹ icon */
.tag-status-icon {
  margin-left: .25rem;
  font-size: 0.78rem;
}
/* å­¸å¾’æ¬„ï¼šä¸ç¢ºå®šç‹€æ…‹çš„æ¨™ç±¤ä¹Ÿè¦é¡¯ç¤ºæˆå¯é»é¸ */
.position-tag.guild-from-week-unsure {
  cursor: pointer;
}
/* æœ¬é€±ç‹€æ…‹ï¼æœªä¸Šç·š â†’ å­¸å¾’æ¬„ç”¨ç™½è‰²æ¨™ç±¤ï¼Œä¸èƒ½é»é¸äº¤æ› */
.position-tag.guild-from-week-absent {
  background: #ffffff !important;
  cursor: pointer;   /* V17.2æ”¹æˆå¯é»é¸ */ 
}


/* ç´…ï¼ç¶ æ¨™ç±¤å¯ä»¥é»é¸ */
.position-tag.guild-missing-in-week,
.position-tag.guild-from-week-only {
  cursor: pointer;
}

/* è¢«é¸ä¸­çš„ç‹€æ…‹ */
.position-tag.guild-selected {
  box-shadow: 0 0 0 2px #0ea5e9;
  transform: translateY(-1px);
}

/*V16æ–°å¢å¹«çœ¾æ·»åŠ æˆå“¡æŒ‰éˆ•*/
.guild-add-btn {
  margin-left: .35rem;
  width: 1.2rem;
  height: 1.2rem;
  border-radius: 999px;
  border: none;
  background: #0ea5e9;
  color: #ffffff;
  font-weight: 900;
  font-size: .78rem;
  line-height: 0;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  /* ä¿éšªï¼šå°±ç®—æœ‰èª¤ä¸Šè·æ¥­è‰²ï¼Œä¹Ÿè“‹æ‰å·¦é‚Šè‰²æ¢ */
  border-left: none !important;
}
.guild-add-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 8px rgba(34,197,94,0.25);
}

/* V16.2æœ¬é€±åå–®ï¼šä¸€å¾‹ä¸€æ¬¡åªé¡¯ç¤ºä¸€åœ˜ï¼Œç”± .active æ§åˆ¶ */
#thisWeek .teams-wrap {
  position: relative;
  width: 100%;
}
#thisWeek .team-block {
  width: 100%;
  display: none;      /* é è¨­éƒ½éš±è— */
}
#thisWeek .team-block.active {
  display: block;     /* åªæœ‰ .active é‚£åœ˜é¡¯ç¤º */
}

/* V17.2æ–°å¢ï¼Œæœ¬é€±åå–®ä¸Šæ–¹ï¼šç‹€æ…‹èªªæ˜åˆ— */
.week-legend {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
  font-size: .78rem;
  color: #64748b;
  margin-bottom: 0.4rem;
}
/* å°ç¤ºæ„æ¡†ï¼Œé•·å¾—åƒç¸®å°ç‰ˆçš„æœ¬é€±æ¬„ä½ */
.week-pill {
  display: inline-flex;
  align-items: center;
  padding: 0.18rem 0.45rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  font-weight: 700;
  box-sizing: border-box;
}
/* å·²å…¥çµ„ï¼šæ²¿ç”¨ status-present çš„æ·±ç¶  */
.week-pill.week-present {
  background: #3A9267;
  border: 1px solid #14532d;
  color: #ffffff;
}
/* ä¸ç¢ºå®šï¼šæ²¿ç”¨ status-unsure çš„æ·ºç¶  + è‡ªå¸¶ ? åœ“åœˆ */
.week-pill.week-unsure {
  position: relative;
  background: #6CC499;
  border: 1px solid #46a769;
  color: #ffffff;
  padding-right: 1.6rem; /* å³é‚Šç•™ç©ºçµ¦ ? åœ“åœˆ */
}
.week-pill.week-unsure::after {
  content: "ï¼Ÿ";
  position: absolute;
  right: 4px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  background: #bbf7d0;
  color: #3A9267;
  border: 2px solid #3A9267;
}
/* æœªä¸Šç·šï¼šæ²¿ç”¨ status-absent çš„ç°è‰²æ¨£å¼ */
.week-pill.week-absent {
  background: #e5e7eb;
  border: 1px solid #d1d5db;
  color: #6b7280;
}
.week-legend-tip {
  margin-left: 4px;
}



    #subsList { display:flex; flex-direction:column; gap:.25rem; }
    .substitute-row { display: grid; grid-template-columns: 1fr 1fr auto; grid-template-rows: auto auto; gap: 0.25rem; align-items: center; border: 1px solid #e2e8f0; border-radius: 0.35rem; padding: 0.25rem; background: #f8fafc; }
    .substitute-row input { width: 100%; padding: 0.25rem 0.3rem; border-radius: 0.25rem; border: 1px solid #e2e8f0; font-size: 0.78rem; font-weight: 700; box-sizing: border-box; }
    .del-btn { background: #ef4444; color: #fff; border: none; border-radius: 0.35rem; padding: 0.22rem 0.45rem; font-size: 0.7rem; cursor: pointer; }
    .substitute-row span.sub-status { grid-column: 1 / span 3; font-size: 0.7rem; min-height: 1.2rem; }
    .drag-preview { position: fixed; pointer-events: none; z-index: 9999; padding: 0.2rem 0.5rem; background: #0f172a; color: #fff; font-size: 0.65rem; border-radius: 999px; }

    #thisWeek { position: relative; }
    #downloadBtn { position: absolute; top: 1rem; right: 1rem; background: #0f766e; }

    #loginModal { position: fixed; inset: 0; background: rgba(15,23,42,.5); display: none; align-items: center; justify-content: center; z-index: 99999; }
    #loginModal .modal-card { background: #fff; border-radius: .75rem; padding: 1.2rem 1.4rem; width: 280px; box-shadow: 0 20px 40px rgba(0,0,0,.12); }
    #loginModal h3 { margin: 0 0 .5rem; font-size: 1.05rem; }
    #loginModal input { width: 100%; margin-bottom: .5rem; padding: .35rem .4rem; border: 1px solid #cbd5e1; border-radius: .4rem; }

    .outline-dabai { outline: 2px solid #a855f7; outline-offset: 2px; }
    .outline-baoan { outline: 2px solid #ef4444; outline-offset: 2px; }
    .outline-stitch { outline: 2px solid #38bdf8; outline-offset: 2px; }

    #memberPicker { position: absolute; background: #fff; border: 1px solid #cbd5e1; border-radius: .5rem; box-shadow: 0 15px 30px rgba(15,23,42,.12); width: 220px; display: none; z-index: 9999; padding: .4rem; overflow: hidden; }
    #memberPicker input { width: 100%; margin-bottom: .35rem; padding: .3rem .4rem; border: 1px solid #cbd5e1; border-radius: .35rem; box-sizing: border-box; }
    #memberPicker .picker-list { max-height: 180px; overflow-y: auto; }
    #memberPicker .picker-item { padding: .25rem .2rem; border-radius: .35rem; cursor: pointer; font-size: .75rem; }
    #memberPicker .picker-item:hover { background: #e2e8f0; }

    @media (max-width: 1300px) {
      .layout { grid-template-columns: 1fr; }
      #allMembersPanel, #guildPositions, .right-sticky-wrap { position: static; }
      #downloadBtn { position: absolute; top: 1rem; right: 1rem; margin-bottom: 0; }
    }
    
    input.skill-has { background: #FFFFDB; color: #0f172a; font-weight: 600; }
/* âœ… V14.9é–å®šæœ¬é€±åå–®çš„æŠ€èƒ½æ¬„ä½ï¼šä¸èƒ½é»ã€ä¸èƒ½é¸å­—ã€æ²’æœ‰æ¸¸æ¨™ */
#thisWeek .member-row input[data-role="skill"] {
  pointer-events: none;
  user-select: none;
  caret-color: transparent;
}

/*V17å­¸å¾’ç‹€æ…‹æ¨™ç±¤*/
.position-tag .tag-status-icon {
  margin-left: .25rem;
  font-size: 0.7rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.1em;
  height: 1.1em;
  border-radius: 999px;
  border: 1px solid currentColor;
  line-height: 1;
}

/* â˜… å­¸å¾’æ¨™ç±¤ï¼šæœªä¸Šç·šï¼ˆabsentï¼‰ */
.position-tag.guild-from-week-absent .tag-status-icon {
  background: #959eaf;    /* æ·±è‰²åº• */
  color: #ffffff;         /* ç™½å­— */
  border: 2px solid #959eaf;
}
/* â˜… å­¸å¾’æ¨™ç±¤ï¼šä¸ç¢ºå®šï¼ˆunsureï¼‰ */
.position-tag.guild-from-week-unsure .tag-status-icon {
  background: #6CC499;    
  color: #ffffff;       
  border: 2px solid #6CC499;}



/* V17.1 æœ¬é€±åå–®ï¼šç¢ºèªåƒæˆ°ï¼ä¸ç¢ºå®šï¼æœªä¸Šç·š */
/* æœªä¸Šç·šï¼ˆabsentï¼‰ï¼ç°è‰²ã€åƒ disabled */
#thisWeek .member-row.status-absent input[data-role="name"],
#thisWeek .member-row.status-absent + .member-row input[data-role="skill"] {
  background: #e5e7eb; /* bg-gray-200 */
  border-color: #d1d5db; /* border-gray-300 */
  color: #6b7280; /* text-gray-500 */
  opacity: 0.6;
}
/* V17.2ä¿®æ”¹ç¢ºèªåƒæˆ°ï¼ˆpresentï¼‰ï¼è¼ƒæ·±çš„å¯¦å¿ƒç¶ è‰²ã€æœ‰é»æµ®èµ·ä¾†çš„æŒ‰éˆ•æ„Ÿ */
#thisWeek .member-row.status-present input[data-role="name"],
#thisWeek .member-row.status-present + .member-row input[data-role="skill"],
#thisWeek .member-row.status-late input[data-role="name"],
#thisWeek .member-row.status-late + .member-row input[data-role="skill"] {
  background: #3A9267;   /* æ¯”åŸæœ¬æ›´æ·±ä¸€éšçš„ç¶  */
  border-color: #14532d; /* å†æ·±ä¸€é»çš„é‚Šæ¡† */
  color: #ffffff;
  text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
}
/* V17.2ä¸ç¢ºå®šï¼ˆunsureï¼‰ï¼æ¯”ç¢ºèªåƒæˆ°æ›´æ·ºä¸€éšçš„ç¶ åº•ï¼‹ç™½å­— */
#thisWeek .member-row.status-unsure input[data-role="name"],
#thisWeek .member-row.status-unsure + .member-row input[data-role="skill"] {
  background: #6CC499;   /* æ·ºä¸€éšçš„å¯¦å¿ƒç¶  */
  border-color: #46a769; /* é‚Šæ¡†ç•¥æ·±ï¼Œä¿ç•™å±¤æ¬¡æ„Ÿ */
  color: #ffffff;        /* ç™½å­—ï¼Œè·Ÿã€Œä¿å®‰ã€é‚£é¡†ä¸€æ¨£è¦–è¦ºé‡é‡ */
  text-shadow: 0 0 5px rgba(6, 78, 11, 0.7);
}



/* ===============================
   V17.1 æœ¬é€±åå–®ç‹€æ…‹åœ–ç¤ºï¼ˆæœ€æ–°ç‰ˆï¼‰
   ä¿ç•™ã€Œåœ“åœˆåŒ…ç¬¦è™Ÿã€çš„é¢¨æ ¼
   =============================== */
/* åªæœ‰ late / unsure é¡¯ç¤ºåœ–ç¤ºï¼ˆabsent / present ä¸é¡¯ç¤ºï¼‰ */
#thisWeek .member-row.status-unsure {
  position: relative;
}
/* åœ“åœˆåŸºåº•ï¼ˆçµ±ä¸€æ¨£å¼ï¼‰ */
#thisWeek .member-row.status-unsure::after {
  content: "ï¼Ÿ";
  position: absolute;
  right: 6px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px;
  height: 14px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
  background: #bbf7d0;    /* æ·ºç¶ åº• */
  color: #3A9267;         /* æ·±ç¶ å­— */
  border: 2px solid #3A9267;
}

/* V17.4é¦¬ä¸ŠæŠŠã€Œä¸‹ä¸€åˆ—ã€çš„ ::after é—œæ‰ â†’ æŠ€èƒ½åˆ—ä¸é¡¯ç¤ºå•è™Ÿ */
#thisWeek .member-row.status-unsure + .member-row::after {
  content: none;
  display: none;
}

    
    /* V14.9 æ‰‹æ©Ÿç‰ˆï¼šæ¬„ä½å­—é«”ç¸®ä¸€é»ï¼Œè®“æœ€é•· 7 å€‹å­—ä¸è¢«åƒæ‰ */
@media (max-width: 900px) {
  /* æœ¬é€±æˆå“¡åç¨± */
  #thisWeek .member-row input[data-role="name"],
  #subsList .substitute-row .sub-name {
    font-size: 13px;
    padding: 0.24rem 0.24rem;
  }
  /* æœ¬é€±æŠ€èƒ½æ¬„ä½ */
  #thisWeek .member-row input[data-role="skill"],
  #subsList .substitute-row .sub-skill {
    font-size: 11px;
    padding: 0.20rem 0.24rem;
  }
  /* å·¦å´ã€Œå…¨éƒ¨æˆå“¡ã€æœå°‹ï¼†æµ®å±¤æœå°‹ï¼Œç¶­æŒåŸæœ¬è¦–è¦ºï¼‹16px é˜²æ­¢æ”¾å¤§ */
  #memberSearch,
  #pickerSearch {
    font-size: 0.8rem;
  }
  #memberSearch:focus,
  #pickerSearch:focus {
    font-size: 16px;
  }
    /* âœ… iOS å°ˆç”¨ï¼šèª¿æ•´ .ios-zoom-fixï¼Œè®“æ¡†æ¡†ä¸è¦ç¸®å° */
   #thisWeek .member-row input[data-role="name"].ios-zoom-fix,
  #subsList .substitute-row .sub-name.ios-zoom-fix {
    font-size: 16px !important;  /* åªé å­—é«” 16px ä¾†æ“‹ iOS æ”¾å¤§ */
  }

}

    /* æ‰‹æ©Ÿæ¿åº•éƒ¨æŒ‰éˆ• */
    @media (max-width: 900px) {
      .right-actions-bar {
        position: fixed;
        bottom: 1rem;
        left: 3rem;
        right: 3rem;
        background: rgba(15, 23, 42, 0.95);
        padding: .4rem .6rem;
        display: flex;
        gap: .5rem;
        justify-content: space-between;
        z-index: 9999;
        border-radius: 3rem;
        height: 2.5rem;
        align-items: center;
      }
      .right-actions-bar .float-btn { flex: 1; padding: .4rem .6rem; font-size: .85rem; font-weight: 600; border-radius: .999rem; }
      body { padding-bottom: 5.2rem; }
      .right-sticky-wrap { position: static; }
    }

    .panel-title-row { display: flex; align-items: center; justify-content: space-between; gap: .5rem; margin-bottom: .3rem; }
    #downloadBtn { position: static; }


/* V16å¹«æœƒè·ä½æ¬„ä½ï¼šä¹Ÿåšæˆ stickyï¼Œè·Ÿå·¦é‚Šä¸€æ¨£è²¼åœ¨é ‚éƒ¨ */
#guildPositions {
  position: sticky;
  top: 1rem;
  z-index: 5;
  display: flex;
  flex-direction: column;
  gap: .5rem;
}

@media (max-width: 1300px) {
  #guildPositions {
    position: static;
    top: auto;
  }
}
.guild-pos-note {
  font-size: .78rem;
  color: #64748b;
  margin: 0;
}
.guild-pos-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;  /* å·¦å¹«çœ¾ / ä¸­é–“æŒ‰éˆ• / å³å­¸å¾’ */
  gap: .75rem;
  align-items: stretch;
}
.guild-swap-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
}
.guild-swap-btn {
  width: 2.4rem;
  height: 2.4rem;
  border-radius: 999px;
  border: none;
  background: #0ea5e9;
  color: #fff;
  font-size: 1.2rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 10px 20px rgba(15,23,42,.25);
}
/*V17.4æ–°å¢ä¿®æ”¹äº¤æ›æŒ‰éˆ•å¤§å°*/
@media (max-width: 900px) {
  .guild-swap-btn {
    width: 1.7rem;
    height: 1.7rem;
    font-size: 1rem;   /* è£¡é¢çš„ â‡„ ä¸æœƒå¤ªå¤§ */
  }
}
.guild-swap-btn:disabled {
  opacity: .35;
  cursor: not-allowed;
  box-shadow: none;
}
.guild-col {
  display: flex;
  flex-direction: column;
  gap: .4rem;
}
.guild-col-title {
  font-size: 1rem;
  font-weight: 700;
  color: #0f172a;
}

/* â˜… ä¸€å€‹å¤§æ¡†ï¼Œè£¡é¢è‡ªå‹•æ’æ¨™ç±¤ */
.guild-box {
  min-height: 96px;
  border-radius: .75rem;
  border: 1px dashed #cbd5e1;
  padding: .4rem .55rem;
  box-sizing: border-box;
  background: #f8fafc;
  /* ç›´å‘æ’ç‰ˆï¼šä¸€åˆ—ä¸€å€‹æ¨™ç±¤ */
  display: flex;
  flex-direction: column;
  flex-wrap: nowrap;
  align-items: stretch;
  gap: .25rem;
}
/* å¹«çœ¾æ¬„ï¼šæœ€å¤šé¡¯ç¤ºç´„ 15 å€‹é«˜åº¦ï¼Œå…¶é¤˜ç”¨æ»¾è¼ª */
#guildBattleBox {
  max-height: 28rem;   /* å¯è‡ªè¡Œå¾®èª¿ï¼Œç´„ 15 å€‹æ¨™ç±¤é«˜åº¦ */
  overflow-y: auto;
}

/* ç©ºçš„å¤§æ¡†é¡¯ç¤ºæ·¡æ·¡æç¤ºæ–‡å­—ï¼ˆå¯é¸ï¼‰ */
.guild-box.empty::before {
  content: " ";
  font-size: .75rem;
  color: #94a3b8;
}

/* æˆå“¡æ¨™ç±¤ */
.position-tag {
  display: inline-flex;
  align-items: center;
  padding: .18rem .45rem;
  border-radius: 999px;
  background: #ffffff;
  border: 1px solid #cbd5e1;
  font-size: .85rem;
  font-weight: 700;
  max-width: 100%;
  box-sizing: border-box;
  letter-spacing: -0.02em;
  width: 100%;                 /* æ’æ»¿æ•´åˆ— */
  justify-content: space-between;/* æ–‡å­—åœ¨å·¦ï¼Œå‰å‰é å³ */
}
/* åˆªé™¤æŒ‰éˆ•ï¼ˆå‰å‰ï¼‰ */
.position-tag-remove {
  margin-left: auto;           /* å¾€æœ€å³é‚Šè²¼ */
  border: none;
  background: transparent;
  width: 1.1rem;
  height: 1.1rem;
  font-size: 1rem;             /* å‰å‰è®Šå¤§ */
  line-height: 1;
  cursor: pointer;
  padding: 0;
  color: #64748b;
  display: flex;
  align-items: center;
  justify-content: center;
}
.position-tag-remove:hover {
  color: #ef4444;
}

/* RWDï¼šæ‰‹æ©Ÿç‰ˆå¹«æœƒè·ä½æ¬„ä½æ”¹æˆä¸Šä¸‹æ’åˆ— */
@media (max-width: 900px) {
  /* æ‰‹æ©Ÿç‰ˆå¹«æœƒè·ä½ï¼šå…è¨±æ¨™ç±¤ä¸¦æ’ */
  .guild-box {
    flex-direction: row;
    flex-wrap: wrap;
    align-items: flex-start;
  }
  .position-tag {
    width: auto;          /* ä¸è¦æ’æ»¿æ•´åˆ—ï¼Œæ”¹æˆè† å›Š */
    flex: 0 1 auto;
  }
  /*V17.4ä¿®æ”¹æ‰‹æ©Ÿæ¨™ç±¤å­—å¤§å°*/
  .position-tag,
  .position-tag .tag-name {
    font-size: 0.7rem;  /* ä½ å¯ä»¥æ”¹æˆ 0.7remã€0.65rem ç­‰ */
  }
  /* å¦‚æœè¦ºå¾— X æŒ‰éˆ•ä¹Ÿå¤ªå¤§ï¼Œå¯ä»¥ä¸€èµ·ç¸® */
  .position-tag .tag-close {
    font-size: 0.7rem;
  }
}

/* â˜… è®“å…¨éƒ¨æˆå“¡åå–®çš„æŠ€èƒ½å‰é¢å‡ºç¾ï½œ */
#allMembersPanelOuter .member-row .skill-hint::before,
.all-members-list .member-row .skill-hint::before {
  content: "ï½œ";             /* åˆ†éš”ç¬¦è™Ÿ */
  color: #94a3b8;            /* æ·ºç°è‰² */
  margin-right: 6px;         /* èˆ‡æŠ€èƒ½è·é›¢ */
  font-weight: 500;
}

/*V17.2å­¸å¾’æ—è¨»è§£*/
/* V17.4è®“å¹«çœ¾ / å­¸å¾’ æ¨™é¡Œï¼‹èªªæ˜åˆ†æˆå…©è¡Œ */
.guild-apprentice-title-row {
  display: flex;
  flex-direction: column; /* â† é‡é»ï¼šä¸Šä¸‹æ’åˆ—ï¼Œè€Œä¸æ˜¯å·¦å³ */
  gap: 0.3rem;
}
.guild-title-subrow {
  display: flex;
  align-items: center;
  gap: .4rem;
  flex-wrap: nowrap;
}

.guild-apprentice-title {
  font-size: 18px;
  font-weight: 600;
  color: #0f172a;
}
/* å­¸å¾’æ—é‚Šçš„å°åœ–ç¤ºèªªæ˜ï¼Œç”¨è·Ÿæ¨™ç±¤ä¸€æ¨£çš„ ! / ï¼Ÿ åœ“åœˆ */
.appr-legend {
  display: flex;
  align-items: center;
  gap: 4px; /*å­¸å¾’:ä¸ç¢ºå®šèˆ‡ç‚ºä¸Šç·šä¹‹é–“çš„è·é›¢*/
  font-size: 13px;
  color: #475569;
  flex-wrap: nowrap;   /* â— å¼·åˆ¶ä¸æ›è¡Œ */
  white-space: nowrap; /* â— ä¿è­‰æ–‡å­—ä¸æœƒæ–·è¡Œ */
}
.appr-status {
  display: inline-flex;
  align-items: center;
  gap: 1px; /*ä¸ç¢ºå®šèˆ‡æœªä¸Šç·šç‹€æ…‹èˆ‡åœ–ç¤ºä¹‹é–“çš„è·é›¢*/
}
/* è®“ legend å…§çš„ icon è·Ÿæ¨™ç±¤ä¸Šé‚£é¡†ä¸€æ¨£å¤§å° */
.appr-legend .tag-status-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.1em;
  height: 1.1em;
  border-radius: 999px;
  font-size: 0.7rem;
  font-weight: 700;
  border: 2px solid currentColor;
  line-height: 1;
}
/* æœªå‡ºå¸­ï¼ˆåŒ guild-from-week-absent æ¨£å¼ï¼‰ */
.appr-legend .tag-status-icon.appr-absent {
  background: #959eaf;
  color: #ffffff;
  border-color: #959eaf;
}
/* ä¸ç¢ºå®šï¼ˆåŒ guild-from-week-unsure æ¨£å¼ï¼‰ */
.appr-legend .tag-status-icon.appr-unsure {
  background: #6CC499;
  color: #ffffff;
  border-color: #6CC499;
}

/* V17.4æ‰‹æ©Ÿç‰ˆèª¿æ•´ã€Œä¸ç¢ºå®šã€å•è™Ÿå¤§å°èˆ‡ä½ç½® */
@media (max-width: 900px) {
  /* æ‰‹æ©Ÿï¼šä¸ç¢ºå®šçš„å•è™Ÿè²¼åœ¨å³ä¸Šè§’ã€ç¸®å°ä¸€é» */
  #thisWeek .member-row.status-unsure::after {
    width: 8px;
    height: 8px;
    font-size: 0.5rem;
    top: 1px;          /* è²¼è¿‘æ¬„ä½ä¸Šç·£ï¼Œä¸æœƒæ’åˆ°ä¸Šé¢åˆ†éš”ç·š */
    right: 1px;        /* ç¨å¾®å¾€å…§ç¸®ä¸€é» */
    transform: none;   /* å–æ¶ˆ 50% ä½ç§»ï¼Œæ”¹ç”¨å›ºå®š top */
  }
  /* è®“æ–‡å­—ä¸è¦è¢«å³ä¸Šè§’å•è™Ÿè“‹åˆ°ï¼Œå³å´å¤šç•™ä¸€é» padding */
  #thisWeek .member-row.status-unsure input[data-role="name"] {
    padding-right: 0.3rem;
  }
}

/* V18æ‰‹æ©Ÿç‰ˆï¼šæŠŠå¹«æœƒè·ä½æ”¹æˆåº•éƒ¨æŠ½å±œ */
@media (max-width: 900px) {
  /* æŠ½å±œæœ¬é«” */
  #guildSection {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    max-height: 80vh;
    transform: translateY(100%);
    transition: transform .25s ease-out;
    z-index: 30;
    margin: 0;
    border-radius: 16px 16px 0 0;
    background: #ffffff;
    overflow: hidden;
    border: none !important;        /* â­ æŠŠåŸæœ¬å¡ç‰‡é‚Šæ¡†é—œæ‰ */
    box-shadow: 0 -8px 24px rgba(15,23,42,.45);
    padding-bottom: 2rem !important;   /* â­ å¯è‡ªè¡Œèª¿æ•´ 2remï½4rem */
  }
  #guildSection.is-open {
    transform: translateY(0);
  }
  /* ä¸Šæ–¹ handle å€ */
  #guildSection .guild-drawer-header {
    position: sticky;
    top: 0;
    padding: 1.2rem 0 .4rem;
    display: flex;
    justify-content: center;
    z-index: 2;
    background: transparent;
    border: none;
    box-shadow: none;
  }
  #guildSection .guild-drawer-grip {
    width: 44px;
    height: 4px;
    border-radius: 999px;
    background: #9aa0a3;
    box-shadow: 0 1px 0 rgba(0,0,0,.08);
    cursor: pointer;
  }
  /* æŠ½å±œå…§éƒ¨å®¹å™¨ï¼šæŠŠåº•è‰²ã€åœ“è§’ã€é‚Šæ¡†ã€é™°å½±å…¨éƒ¨æ¸…æ‰ */
  #guildSection .card-body,
  #guildSection > .inner,
  #guildSection > div {
    padding: .75rem 1rem 1rem;
    background: transparent !important;
    border-radius: 0 !important;
    border: none !important;        /* â­ é¿å…é‚„æœ‰ border-top ä¹‹é¡çš„ç·š */
    box-shadow: none !important;
  }
  /* æ¨™é¡Œå¾€ä¸Šé è¿‘æ‹‰æ¢ä¸€é» */
  #guildSection h3 {
    margin-top: .1rem !important;
  }
  /* èƒŒæ™¯é®ç½© */
  .guild-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(15,23,42,.35);
    z-index: 20;
  }
}



  </style>
</head>
<body>
  <div class="header-row">
    <h1>å¹«æˆ°åå–®æ¯”å°å·¥å…· v18</h1>
    <button id="saveBtn" class="save-btn-desktop" onclick="requestSave()">å„²å­˜</button>
  </div>

  <div class="layout">
    <!-- å·¦å´ï¼šå…¨éƒ¨æˆå“¡ -->
    <div class="panel" id="allMembersPanel">
      <h3>å…¨éƒ¨æˆå“¡åå–®</h3>
      <input id="memberSearch" class="member-search" placeholder="æœå°‹æˆå“¡åæˆ–æŠ€èƒ½..." oninput="renderMemberList(); saveState();" />
      <div class="role-tabs" id="roleTabs"></div>
      <div class="member-list" id="memberList"></div>
      <div class="pagination">
        <button onclick="prevPage()">â—€</button>
        <select id="pageSelect" onchange="jumpPage(this.value)"></select>
        <button onclick="nextPage()">â–¶</button>
      </div>
      <div style="margin-top:.5rem;">
        <button class="float-btn secondary" style="background:#475569;" onclick="toggleAddMember()">ï¼‹ æ–°å¢æˆå“¡</button>
        <div class="add-member-form" id="addMemberForm">
          <input id="newName" placeholder="æˆå“¡åç¨±" />
          <select id="newJob">
            <option value="">é¸æ“‡è·æ¥­</option>
            <option value="ä¹éˆ">ä¹éˆ</option>
            <option value="éµè¡£">éµè¡£</option>
            <option value="ç´ å•">ç´ å•</option>
            <option value="é¾åŸ">é¾åŸ</option>
            <option value="ç¥ç›¸">ç¥ç›¸</option>
            <option value="ç¢å¤¢">ç¢å¤¢</option>
            <option value="è¡€æ²³">è¡€æ²³</option>
          </select>
          <input id="newSkill" placeholder="æˆå“¡æŠ€èƒ½ï¼ˆå¯ä¸å¡«ï¼‰" />
          <button class="float-btn" style="width:100%;text-align:center;" onclick="addMember()">ç¢ºèªæ–°å¢</button>
        </div>
        <!-- â˜… æ–°å¢ï¼šæ»¿å“¡æç¤ºæ–‡å­— -->
  <p id="memberLimitMsg" style="display:none;font-size:.7rem;color:#b91c1c;margin-top:.25rem;">
    ç›®å‰å·²æ»¿å“¡ï¼Œè«‹ç§»é™¤é›¢é–‹çš„æˆå“¡å¾Œå†æ–°å¢ã€‚
      </div>
    </div>

<section id="guildSection" class="card">
  <!-- V18ğŸ”½ æ–°å¢ï¼šæŠ½å±œä¸Šæ–¹æ‹‰æ¢å€å¡Š -->
  <div class="guild-drawer-header">
  <div class="guild-drawer-grip"></div>
  </div>
 <!-- V16â˜… æ–°å¢ï¼šå¹«æœƒè·ä½æ¬„ä½ -->
  <div class="panel" id="guildPositions">
    <h3>å¹«æœƒè·ä½</h3>
    <p class="guild-pos-note">æ¯”å°å°šæœªæ›´æ›è·ä½çš„æˆå“¡ã€‚</p>
    <div class="guild-pos-grid">
  <!-- V17.4å¯åƒæˆ°å¹«çœ¾ -->
  <div class="guild-col" data-type="battle">
    <div class="guild-apprentice-title-row">
  <div class="guild-col-title">å¹«çœ¾</div>
  <div class="guild-title-subrow">
    <button class="guild-add-btn" onclick="openGuildAddPicker(this)">ï¼‹</button>
    <span id="guildCountLabel" class="guild-count">0/60</span>
  </div>
</div>
  <div class="guild-box" id="guildBattleBox"
       ondragover="allowDrop(event)"
       ondrop="dropMember(event)"></div>
</div>

  <!-- ä¸­é–“äº¤æ›æŒ‰éˆ• -->
  <div class="guild-swap-wrap">
    <button id="guildSwapBtn"
            type="button"
            class="guild-swap-btn"
            onclick="swapSelectedGuildMembers()"
            disabled>â‡„</button>
  </div>
  <!-- å¾…ä¸Šæ¶å­¸å¾’ -->
  <div class="guild-col" data-type="pending">
    
    <div class="guild-apprentice-title-row">
  <div class="guild-col-title">å­¸å¾’</div>

  <div class="guild-title-subrow appr-legend">
    <span class="appr-status">
      <span class="tag-status-icon appr-unsure">ï¼Ÿ</span> ä¸ç¢ºå®š
    </span>
    <span class="appr-status">
      <span class="tag-status-icon appr-absent">ï¼</span> æœªä¸Šç·š
    </span>
  </div>
</div>

    <div class="guild-box" id="guildPendingBox"
         ondragover="allowDrop(event)"
         ondrop="dropMember(event)"></div>
  </div>
</div>
  </div>
  
  </section>

    <!-- æœ¬é€± -->
    <div class="panel" id="thisWeek">
      <div class="panel-title-row">
        <h3>æœ¬é€±åå–®</h3>
        <button id="downloadBtn" class="float-btn secondary" onclick="downloadThisWeekImage()">ä¸‹è¼‰åœ–ç‰‡</button>
      </div>
      
      <div class="week-legend">
      <span class="week-pill week-present">å·²å…¥çµ„</span>
      <span class="week-pill week-unsure">ä¸ç¢ºå®š</span>
      <span class="week-pill week-absent">æœªä¸Šç·š</span>
      <span class="week-legend-tip">ï¼ˆé»æ“Šæˆå“¡æ¬„ä½å¯åˆ‡æ›ç‹€æ…‹ï¼‰</span>
      </div>

    </div>

    <!-- æ‰‹æ©Ÿå„²å­˜æŒ‰éˆ• -->
    <div class="right-sticky-wrap">
      <div class="right-actions-bar">
        <button id="guildToggleBtn" type="button" class="float-btn">å¹«æœƒè·ä½</button>
        <button class="float-btn danger" onclick="requestSave()">å„²å­˜</button>
      </div>

      <div class="panel" id="subs">
        <h3>æ›¿è£œåå–®</h3>
        <p style="font-size:0.7rem;margin-top:0;">å¯æ‹–é€²æœ¬é€±ï¼›æ‹–é€²å·²æœ‰æˆå“¡æ¬„ä½æœƒäº¤æ›ã€‚</p>
        <div id="subsList"></div>
        <div class="pagination" id="subsPager">
          <button onclick="subsPrev()">â—€</button>
          <select id="subsPageSelect" onchange="subsJump(this.value)"></select>
          <button onclick="subsNext()">â–¶</button>
        </div>
        <button class="float-btn secondary" style="margin-top:.5rem;" onclick="addSub()">æ–°å¢æ›¿è£œåˆ—</button>
      </div>

    </div>
  </div>

  <!-- æˆå“¡æœå°‹æµ®å±¤ -->
  <div id="memberPicker">
    <input id="pickerSearch" placeholder="æœå°‹æˆå“¡..." oninput="filterPickerList()" />
    <div class="picker-list" id="pickerList"></div>
  </div>

  <!-- ç™»å…¥ modal -->
  <div id="loginModal">
    <div class="modal-card">
      <h3>è«‹å…ˆç™»å…¥</h3>
      <input id="loginUser" placeholder="å¸³è™Ÿ" />
      <input id="loginPass" placeholder="å¯†ç¢¼" type="password" />
      <div style="display:flex;gap:.5rem;justify-content:flex-end;">
        <button class="float-btn secondary" onclick="closeLogin()">å–æ¶ˆ</button>
        <button class="float-btn" onclick="doLogin()">ç™»å…¥</button>
      </div>
      <p id="loginMsg" style="color:#b91c1c;font-size:.7rem;margin-top:.4rem;"></p>
    </div>
  </div>



  <script>
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const STORAGE_KEY = "guildCompareV12State";
    const LOGIN_STORAGE_KEY = "guildCompareLogin";
    const REMOTE_API = "https://script.google.com/macros/s/AKfycbyi96XOIYv7ff_gJO8IG-fGpGWfEE_ZQbKmFYMJQeuP9sbyf4gbrbnZIM-wO83cniYk/exec";
    const LOGIN_TTL = 60 * 60 * 1000;
    // è®“ã€Œæœ€è¿‘ä¿®æ”¹æ¡†ç·šã€åœ¨ç·¨è¼¯æœŸé–“æš«æ™‚éš±è—
    let outlinesSuppressed = false;
    
    function suppressOutlinesOnEdit(){
    if (!outlinesSuppressed) {
    outlinesSuppressed = true;
    clearAllOutlines(); // ç«‹åˆ»æŠŠç¾æœ‰æ¡†ç·šæ¸…æ‰
      }
    }
    
    let currentUser = null;
    let lastLoginTime = 0;

    const OUTLINE_CLASS = { dabai: "outline-dabai", baoan: "outline-baoan", stitch: "outline-stitch", unknown: "outline-dabai" };

    let lastKnownUpdatedAt = null;

    const teams = ["é€²æ”»","æ‹†å¡”","æ©Ÿå‹•","é˜²å®ˆ"];
    const roleColors = {
      "ä¹éˆ": "#d8b4fe","éµè¡£": "#fdba74","ç´ å•": "#f9a8d4","é¾åŸ": "#92d46d","ç¥ç›¸": "#3b82f6","ç¢å¤¢": "#7dd3fc","è¡€æ²³": "#f43f5e"
    };

    let allMembers = [
      {id:1, name: "å››å­£æ˜¥æ›‰å·", job: "ä¹éˆ", skill: "å·¦éˆå¤©æµ©æ„"},
      {id:2, name: "ç‹æˆ€é›ª", job: "ç´ å•", skill: "å¤ªæ¥µåœ–"},
      {id:3, name: "ç¿¼æ­Œ", job: "é¾åŸ", skill: "å¤ªæ¥µåœ–"},
      {id:4, name: "æœ¨å­ç¶­", job: "éµè¡£", skill: ""},
      {id:5, name: "çµ¦é›€å¿ƒè£¹", job: "ç¥ç›¸", skill: ""},
      {id:6, name: "ç–é¨", job: "è¡€æ²³", skill: ""},
      {id:7, name: "é˜¿å¦™", job: "ç´ å•", skill: ""},
      {id:8, name: "å°è‘‰é’", job: "ç¢å¤¢", skill: ""},
      {id:9, name: "ç ´é¢¨", job: "è¡€æ²³", skill: "çˆ†ç™¼"},
      {id:10, name: "é’ç‚", job: "é¾åŸ", skill: ""},
      {id:11, name: "ç…™é›¨", job: "ä¹éˆ", skill: ""}
    ];

/* V16æ–°å¢ å¹«æœƒè·ä½ç”¨çš„è·æ¥­æ’åºï¼ˆä½ æƒ³è¦çš„è·æ¥­é †åºï¼‰ */
const guildJobOrder = ["ä¹éˆ","éµè¡£","ç´ å•","é¾åŸ","ç¥ç›¸","ç¢å¤¢","è¡€æ²³"];
// å»ºç«‹è·æ¥­æ’åºå°ç…§è¡¨
const guildJobOrderMap = {
  "ä¹éˆ": 1,
  "éµè¡£": 2,
  "ç´ å•": 3,
  "é¾åŸ": 4,
  "ç¥ç›¸": 5,
  "ç¢å¤¢": 6,
  "è¡€æ²³": 7
};


// V16å¹«çœ¾ï¼‹è™Ÿï¼šé–‹å•Ÿæˆå“¡æœå°‹æµ®å±¤
function openGuildAddPicker(btn) {
  window.guildAddMode = true;
  // ç”¨æŒ‰éˆ•æœ¬èº«ç•¶ä½œå®šä½å…ƒç´ ï¼ˆåªæ‹¿ä¾†ç®—ä½ç½®ï¼‰
  const target = btn || document.getElementById("guildBattleBox");
  if (!target) return;
  openMemberPicker(target);
}



// â˜… ä¾ç›®å‰é¸å–ç‹€æ…‹ï¼Œæ±ºå®šäº¤æ›æŒ‰éˆ•æ˜¯å¦å¯æŒ‰
function updateGuildSwapButtonState() {
  const btn = document.getElementById("guildSwapBtn");
  if (!btn) return;
  const battleSelected = guildBattleBox
    ? guildBattleBox.querySelectorAll(".position-tag.guild-selected").length
    : 0;
  const pendingSelected = guildPendingBox
    ? guildPendingBox.querySelectorAll(".position-tag.guild-selected").length
    : 0;
  const total = battleSelected + pendingSelected;
  btn.disabled = total === 0;   // æ²’æœ‰é¸ä»»ä½•ç´…ï¼ç¶ æ¨™ç±¤å°±ä¸èƒ½æŒ‰
}


/* â˜… ä¾è·æ¥­é‡æ’æŸä¸€å€‹ guildBoxï¼ˆå¹«çœ¾æˆ–å­¸å¾’ï¼‰
   ç´…ï¼ç¶ æ¨™ç±¤ä¸€å¾‹æ’åœ¨æœ€å‰é¢ï¼Œå†ä¾è·æ¥­é †åºèˆ‡åå­—æ’åº */
function sortGuildBoxByJob(box) {
  if (!box) return;
  const tags = Array.from(box.querySelectorAll(".position-tag"));
  if (!tags.length) {
    box.classList.add("empty");
    return;
  }
  function rank(tag) {
    if (tag.dataset.placeholder === "1") return 0; // ç©ºä½æœ€å‰
    if (tag.classList.contains("guild-missing-in-week")) return 1; // ç´…
    if (tag.classList.contains("guild-from-week-only")) return 2; // ç¶ 
    if (tag.classList.contains("guild-from-week-absent")) return 3; // ç™½ï¼ˆæœªä¸Šç·šï¼‰
    // å…¶ä»–ä¸€èˆ¬å­¸å¾’
    return 4;
  }
  tags.sort((a, b) => {
    const ra = rank(a);
    const rb = rank(b);
    if (ra !== rb) return ra - rb;
    // å†ä¾è·æ¥­é †åº
    const jobA = guildJobOrderMap[a.dataset.job] || 99;
    const jobB = guildJobOrderMap[b.dataset.job] || 99;
    if (jobA !== jobB) return jobA - jobB;
    // åŒè·æ¥­æŒ‰åå­—
    return (a.dataset.memberName || "").localeCompare(
      b.dataset.memberName || "",
      "zh-Hant"
    );
  });
  box.innerHTML = "";
  tags.forEach(t => box.appendChild(t));
  box.classList.remove("empty");
}



    let nextMemberId = 12;
    let activeRoleFilter = "";
    let lastSnapshot = null;
    let memberPage = 1;
    const pageSize = 8;
    let subCounter = 0;

    const thisWeekPanel = document.getElementById("thisWeek");
    const subsList = document.getElementById("subsList");
    const memberList = document.getElementById("memberList");
    const searchInput = document.getElementById("memberSearch");
    const roleTabs = document.getElementById("roleTabs");
    //V16æ–°å¢ä»¥ä¸‹å…©å€‹
    const guildBattleBox = document.getElementById("guildBattleBox");
    const guildPendingBox = document.getElementById("guildPendingBox");

    let weekStatusMap = {};   // V17.1å…¨åŸŸï¼šè¨˜éŒ„æ¯å€‹åå­—ç›®å‰çš„ç‹€æ…‹
    let draggingPanelInput = null;
    let draggingPanelSide = null;
    let dragSuccess = false;
    let dragPreviewEl = null;
    let dragSourceSide = "";

    let pickerTargetInput = null;
    const memberPicker = document.getElementById("memberPicker");
    const pickerList = document.getElementById("pickerList");
    const pickerSearch = document.getElementById("pickerSearch");    


// V16 åœ¨æŒ‡å®šçš„å¤§æ¡†è£¡æ–°å¢ä¸€å€‹è·ä½æ¨™ç±¤ï¼ˆå«ï¼šå»é‡ï¼‹ä¸Šé™æª¢æŸ¥ï¼‹ç©ºä½ç®¡ç†ï¼‰
function addGuildTag(box, member, options) {
  const isPendingBox = (box === guildPendingBox);
  const opts = options || {};
  const bypassRules = !!opts.bypassRules; // true = ä¸æª¢æŸ¥ï¼ˆçµ¦é‚„åŸèˆŠè³‡æ–™ç”¨ï¼‰
  const name = (member && member.name ? member.name : "").trim();
  if (!box || !name) return;
  // â”€â”€ ä¸€èˆ¬æ“ä½œæ™‚æ‰æª¢æŸ¥è¦å‰‡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (!bypassRules) {
    // âœ… åªæª¢æŸ¥ã€Œå¹«çœ¾æ¬„ä½ã€è£¡ä¸èƒ½é‡è¤‡
    if (box === guildBattleBox) {
      const battleTags = guildBattleBox.querySelectorAll(".position-tag");
      for (const t of battleTags) {
        // è·³éç©ºä½æ¨™ç±¤
        if (t.dataset.placeholder === "1") continue;
        if ((t.dataset.name || "").trim() === name) {
          alert(name + " å·²ç¶“åœ¨å¹«çœ¾åå–®è£¡äº†");
          return;
        }
      }

      // â· å¯åƒæˆ°è·ä½ï¼ˆå¹«çœ¾ï¼‰æœ€å¤š 60 äººï¼šåªç®—çœŸæ­£æˆå“¡ï¼Œä¸ç®—ç©ºä½
      const currentRealCount = Array.from(
        guildBattleBox.querySelectorAll(".position-tag")
      ).filter(t => t.dataset.placeholder !== "1").length;

      if (currentRealCount >= 60) {
        alert("å¯åƒæˆ°è·ä½ï¼ˆå¹«çœ¾ï¼‰æœ€å¤šåªèƒ½æ”¾ 60 äºº");
        return;
      }
    }
    // âœ… å­¸å¾’æ¬„ä½ï¼šä¸åšã€Œä¸å¯é‡è¤‡ã€æª¢æŸ¥ï¼Œè®“ä½ è‡ªç”±æ”¾
  }
  // â”€â”€ å»ºç«‹æ¨™ç±¤ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  box.classList.remove("empty");
  const tag = document.createElement("div");
  tag.className = "position-tag";
  tag.dataset.name = name;
  tag.dataset.job = member.job || getJobByName(name) || "";
  const job = tag.dataset.job;
  if (job && roleColors[job]) {
    const dark = darkenHex(roleColors[job], 0.25);
    tag.style.borderLeft = "4px solid " + dark;
    tag.style.color = dark;
  }
  const nameSpan = document.createElement("span");
  nameSpan.textContent = name;
  tag.appendChild(nameSpan);

 
  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "position-tag-remove";
  btn.textContent = "Ã—";

   if (!isPendingBox) {
  btn.onclick = function (e) {
    e.stopPropagation();
    tag.remove();
    if (!box.querySelector(".position-tag")) {
      box.classList.add("empty");
    }
    // â˜… åˆªæˆå“¡å¾Œè¦é‡æ–°è£œç©ºä½
    if (box === guildBattleBox) {
      maintainGuildBattlePlaceholders();
      updateGuildBattleAndWeekComparison();
    }
    saveState();
  };
  tag.appendChild(btn);}

  box.appendChild(tag);
  // â˜… æ–°å¢æˆå“¡å¾Œä¹Ÿè¦ç¶­æŒ 60 æ ¼
  if (box === guildBattleBox) {
    maintainGuildBattlePlaceholders();
    updateGuildBattleAndWeekComparison();
  }



  // â˜… ç´…ï¼ç¶ æ¨™ç±¤å¯é»é¸æˆã€Œé¸ä¸­ç‹€æ…‹ã€
  tag.addEventListener("click", function (e) {
    // é»åˆ°å‰å‰ä¸ç®—é¸å–
    if (e.target.closest(".position-tag-remove")) return;
    // åªæœ‰ç´…ï¼ç¶ æ¨™ç±¤æ‰èƒ½è¢«é¸å–
    if (
      !tag.classList.contains("guild-missing-in-week") &&
      !tag.classList.contains("guild-from-week-only") &&
      !tag.classList.contains("guild-from-week-absent") &&
      !tag.classList.contains("guild-from-week-unsure")
    ) {
      return;
    }
    tag.classList.toggle("guild-selected");
    updateGuildSwapButtonState();
  });

  // â˜… æ‰¾åˆ°ã€Œæœ€å¾Œä¸€å€‹åŒè·æ¥­æ¨™ç±¤ã€ï¼Œè®“åŒè·æ¥­æ’åœ¨ä¸€èµ·
  let insertBefore = null;
  if (job) {
    const siblings = Array.from(box.querySelectorAll(".position-tag"));
    let lastSameJob = null;
    siblings.forEach(t => {
      if ((t.dataset.job || "") === job) {
        lastSameJob = t;
      }
    });
    if (lastSameJob) {
      insertBefore = lastSameJob.nextSibling;
    }
  }

  if (insertBefore) {
    box.insertBefore(tag, insertBefore);
  } else {
    box.appendChild(tag);
  }
}

// V16â˜… ç¶­æŒã€Œå¯åƒæˆ°å¹«çœ¾ã€å›ºå®š 60 æ ¼ï¼šä¸è¶³ç”¨ç©ºä½ç´…æ¨™ç±¤è£œé½Š
function maintainGuildBattlePlaceholders() {
  if (!guildBattleBox) return;
  const MAX = 60;
  const allTags = Array.from(
    guildBattleBox.querySelectorAll(".position-tag")
  );
  // çœŸå¯¦å¹«çœ¾ï¼ˆæœ‰åå­—çš„ï¼‰
  const realTags = allTags.filter(t => t.dataset.placeholder !== "1");
  // ç©ºä½æ¨™ç±¤
  let placeholders = allTags.filter(t => t.dataset.placeholder === "1");
  const realCount = realTags.length;
  let needPlaceholders = Math.max(0, MAX - realCount);
  // å¤šé¤˜çš„ç©ºä½æ¨™ç±¤ç§»é™¤
  if (placeholders.length > needPlaceholders) {
    const extra = placeholders.slice(needPlaceholders);
    extra.forEach(t => t.remove());
    placeholders = placeholders.slice(0, needPlaceholders);
  }
  // ä¸è¶³çš„ç©ºä½æ¨™ç±¤è£œé½Š
  if (placeholders.length < needPlaceholders) {
    const toAdd = needPlaceholders - placeholders.length;
    for (let i = 0; i < toAdd; i++) {
      const tag = document.createElement("div");
      // â˜… ç©ºä½ = ç´…æ¨™ç±¤ï¼ˆè·Ÿç¼ºå¸­å¹«çœ¾åŒä¸€ç¨®ï¼‰
      tag.className = "position-tag guild-missing-in-week";
      tag.dataset.placeholder = "1";     // æ¨™è¨˜é€™é¡†æ˜¯ã€Œç©ºä½ã€

      const span = document.createElement("span");
      span.textContent = "å°šæœ‰ç©ºé–’ä½ç½®";     // æƒ³æ”¹ã€Œç©ºé–’ä½ç½®ã€ä¹Ÿå¯ä»¥
      tag.appendChild(span);

      // â˜… ç©ºä½ä¹Ÿå¯ä»¥è¢«é¸å–ï¼Œåƒèˆ‡äº¤æ›
      tag.addEventListener("click", function (e) {
        // é›–ç„¶ç©ºä½æ²’æœ‰å‰å‰ï¼Œé€™è¡Œæ˜¯é˜²å‘†
        if (e.target.closest(".position-tag-remove")) return;
        // é€™é¡†æœ¬èº«å°±æ˜¯ç´…æ¨™ç±¤ â†’ åˆ‡æ›é¸å–ç‹€æ…‹
        tag.classList.toggle("guild-selected");
        updateGuildSwapButtonState();
      });
      guildBattleBox.appendChild(tag);
      placeholders.push(tag);
    }
  }
  // â˜… è®“ã€Œç©ºä½ç´…æ¨™ç±¤ã€æ’åœ¨æœ€å‰é¢ï¼Œå†æ’çœŸå¯¦å¹«çœ¾
  const ordered = [...placeholders, ...realTags];
  ordered.forEach(tag => guildBattleBox.appendChild(tag));

  if (ordered.length === 0) {
    guildBattleBox.classList.add("empty");
  } else {
    guildBattleBox.classList.remove("empty");
  }
/*V16.1 æ›´æ–°å¹«çœ¾æ•¸å­—*/
    const label = document.getElementById("guildCountLabel");
  if (label) {
    label.textContent = realCount + "/60";
  }

}




// V16 æ¯”å°ï¼šå¹«çœ¾ vs æœ¬é€±åå–®
function updateGuildBattleAndWeekComparison() {
  if (!guildBattleBox || !guildPendingBox) return;
  // 1. æ”¶é›†ã€Œæœ¬é€±åå–®ã€æ‰€æœ‰æˆå“¡åç¨±ï¼‹ç‹€æ…‹
  const weekNames = new Set();
  weekStatusMap = {};   // â† V17.1æŠŠ const æ‹¿æ‰ï¼Œæ”¹æˆé‡æ–°æŠŠå…¨åŸŸç‰©ä»¶æ¸…ç©º  // name -> ç‹€æ…‹ï¼ˆabsent / late / unsure / presentï¼‰
  thisWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp => {
    const n = (inp.value || "").trim();
    if (!n) return;
    weekNames.add(n);
    const st = inp.dataset.status || "present";
    const prev = weekStatusMap[n];
    if (!prev) {
      weekStatusMap[n] = st;
    } else {
      // åŒåå¤šæ ¼æ™‚ï¼Œç”¨ã€Œå„ªå…ˆç´šã€æœ€é«˜çš„é‚£ä¸€å€‹ï¼ˆæœªä¸Šç·š > ä¸ç¢ºå®š > æœƒæ™šåˆ° > å·²å‡ºå¸­ï¼‰
      const curP = MEMBER_STATUS_PRIORITY[st] || 0;
      const prevP = MEMBER_STATUS_PRIORITY[prev] || 0;
      if (curP > prevP) weekStatusMap[n] = st;
    }
  });
  // 2. æ”¶é›†ã€Œå¹«çœ¾ã€ç›®å‰æœ‰å“ªäº›äºº
  maintainGuildBattlePlaceholders();   // å…ˆç¢ºä¿å¹«çœ¾ç©ºä½æ­£ç¢º
  const battleTags = Array.from(
    guildBattleBox.querySelectorAll(".position-tag")
  ).filter(tag => tag.dataset.placeholder !== "1"); // â˜… æ’é™¤ç©ºä½
  const pendingTags = Array.from(
    guildPendingBox.querySelectorAll(".position-tag")
  );

  const battleNames = new Set();
  battleTags.forEach(tag => {
    const n = (tag.dataset.name || "").trim();
    if (n) battleNames.add(n);
  });
  const pendingBox = guildPendingBox;
  // 2-1. å¹«çœ¾è£¡ã€Œæ²’å‡ºç¾åœ¨æœ¬é€±åå–®ã€çš„ â†’ ç´…è‰²æ¨™ç±¤
  battleTags.forEach(tag => {
    const n = (tag.dataset.name || "").trim();
    if (n && !weekNames.has(n)) {
      tag.classList.add("guild-missing-in-week");
    } else {
      tag.classList.remove("guild-missing-in-week");
    }
  });
  // 3. å…ˆæ¸…æ‰ä¹‹å‰ã€è‡ªå‹•ç”¢ç”Ÿã€‘çš„å­¸å¾’æ¨™ç±¤ï¼ˆé¿å…è¶Šç–Šè¶Šå¤šï¼‰
  pendingBox
    .querySelectorAll(".position-tag[data-auto='1']")
    .forEach(tag => tag.remove());
  // é‡æ–°è®€ä¸€æ¬¡å­¸å¾’æ¬„ä½ç¾æœ‰çš„äººï¼ˆåªç®—æ‰‹å‹•æ”¾çš„ï¼‰
  const pendingNames = new Set();
  pendingBox.querySelectorAll(".position-tag").forEach(tag => {
    const n = (tag.dataset.name || "").trim();
    if (n) pendingNames.add(n);
  });
    // V17ä¿®æ”¹ 4. æœ¬é€±åå–®è£¡ã€Œæ²’æœ‰å‡ºç¾åœ¨å¹«çœ¾ã€çš„ â†’ å­¸å¾’æ¬„ä½çš„æ¨™ç±¤
  weekNames.forEach(name => {
    if (battleNames.has(name)) return;   // å·²ç¶“æ˜¯å¹«çœ¾
    if (pendingNames.has(name)) return;  // å­¸å¾’åŸæœ¬å°±æœ‰äººï¼Œä¸é‡è¤‡
    const job = getJobByName(name) || "";
    const status = weekStatusMap[name] || "present";
    addGuildTag(
      pendingBox,
      { name, job },
      { bypassRules: true }
    );
    const tag = Array.from(
      pendingBox.querySelectorAll(".position-tag")
    ).find(t => (t.dataset.name || "").trim() === name && !t.dataset.auto);
    if (tag) {
      tag.dataset.auto = "1";
      tag.dataset.weekStatus = status;
      tag.classList.remove("guild-missing-in-week");
      tag.classList.remove("guild-selected");
      if (status === "absent") { //v17æ–°å¢
  tag.classList.add("guild-from-week-absent");
  tag.classList.remove("guild-from-week-only");
  tag.classList.remove("guild-from-week-late");
  tag.classList.remove("guild-from-week-unsure");
} else if (status === "late") {
  tag.classList.add("guild-from-week-late");
  tag.classList.remove("guild-from-week-absent");
  tag.classList.remove("guild-from-week-only");
  tag.classList.remove("guild-from-week-unsure");
} else if (status === "unsure") {
  tag.classList.add("guild-from-week-unsure");
  tag.classList.remove("guild-from-week-absent");
  tag.classList.remove("guild-from-week-only");
  tag.classList.remove("guild-from-week-late");
} else {
  /* presentï¼ˆå·²å‡ºå¸­ï¼‰â†’ ç¶ æ¨™ç±¤ */
  tag.classList.add("guild-from-week-only");
  tag.classList.remove("guild-from-week-absent");
  tag.classList.remove("guild-from-week-late");
  tag.classList.remove("guild-from-week-unsure");
}

      applyWeekStatusIconToTag(tag, status);
    }
  });
  // 5. æ’é †åºï¼ˆåŒè·æ¥­æ“ºä¸€èµ·ï¼‰
  sortGuildBoxByJob(guildBattleBox);
  sortGuildBoxByJob(guildPendingBox);
  // 6. æ›´æ–°äº¤æ›æŒ‰éˆ•æ˜¯å¦å¯æŒ‰
  updateGuildSwapButtonState();
}

/*V16.1é¡¯ç¤ºè¨Šæ¯*/
let guildNoteTimer = null;
function showGuildSwapMessage(msg, color) {
  const note = document.querySelector(".guild-pos-note");
  if (!note) return;
  note.textContent = msg;
  note.style.color = color || "#2563eb"; // é è¨­è—è‰²
  if (guildNoteTimer) clearTimeout(guildNoteTimer);
  guildNoteTimer = setTimeout(() => {
    note.textContent = "æ¯”å°å°šæœªæ›´æ›è·ä½çš„æˆå“¡ã€‚";
    note.style.color = "#64748b";
  }, 2500);
}


 // â˜… äº¤æ›é¸ä¸­çš„ç´…ï¼ç¶ æ¨™ç±¤ï¼šå¹«çœ¾ â†” å­¸å¾’
function swapSelectedGuildMembers() {
  if (!guildBattleBox || !guildPendingBox) return;

  const redSelected = Array.from(
    guildBattleBox.querySelectorAll(
      ".position-tag.guild-missing-in-week.guild-selected"
    )
  );
    const greenSelected = Array.from(
    guildPendingBox.querySelectorAll(
      ".position-tag.guild-from-week-only.guild-selected, " +
      ".position-tag.guild-from-week-absent.guild-selected, " +
      ".position-tag.guild-from-week-unsure.guild-selected"
    )
  );

  const redCount = redSelected.length;
  const greenCount = greenSelected.length;
  if (redCount === 0 && greenCount === 0) {
    return;   // ç†è«–ä¸Šæ­¤æ™‚æŒ‰éˆ•å·² disabled
  }
  if (redCount !== greenCount) {
    // æ•¸é‡ä¸ä¸€æ¨£ â†’ é¡¯ç¤ºæ˜¯å“ªé‚Šå°‘é¸äº†å¹¾å€‹
    let msg = "ç„¡æ³•äº¤æ›ï¼š";
    if (redCount < greenCount) {
      msg += "å¹«çœ¾å°‘é¸äº† " + (greenCount - redCount) + " å€‹ã€‚";
    } else {
      msg += "å­¸å¾’å°‘é¸äº† " + (redCount - greenCount) + " å€‹ã€‚";
    }
    alert(msg);
    return;
  }
  // å…ˆç¢ºèªäº¤æ›å¾Œå¹«çœ¾ä¸æœƒè¶…é 60 äºº
  const currentBattleCount = guildBattleBox.querySelectorAll(".position-tag").length;
  const afterBattle = currentBattleCount - redCount + greenCount;
  if (afterBattle > 60) {
    alert("å¯åƒæˆ°è·ä½ï¼ˆå¹«çœ¾ï¼‰æœ€å¤š 60 äººï¼Œäº¤æ›å¾Œæœƒè¶…é 60 äººï¼Œè«‹å°‘é¸å¹¾å€‹ã€‚");
    return;
  }
  // å…ˆè¨˜éŒ„è¦å¾å­¸å¾’å‡ä¸Šä¾†çš„äºº
  const promoteList = greenSelected.map(tag => {
    const name = (tag.dataset.name || "").trim();
    const job  = tag.dataset.job || getJobByName(name) || "";
    return { name, job };
  });
  // æŠŠå­¸å¾’ä¸­é¸ä¸­çš„ç¶ æ¨™ç±¤ç§»é™¤
  greenSelected.forEach(tag => {
    const box = tag.parentElement;
    tag.remove();
    if (box && !box.querySelector(".position-tag")) {
      box.classList.add("empty");
    }
  });
  // æŠŠå¹«çœ¾ä¸­é¸ä¸­çš„ç´…æ¨™ç±¤ç§»é™¤ï¼ˆç­‰æ–¼ç§»å‡ºå¹«çœ¾åå–®ï¼‰
  redSelected.forEach(tag => {
    const box = tag.parentElement;
    tag.remove();
    if (box && !box.querySelector(".position-tag")) {
      box.classList.add("empty");
    }
  });
  // æŠŠåŸæœ¬å­¸å¾’çš„ç¶ æ¨™ç±¤ï¼Œæ–°å¢æˆå¹«çœ¾ï¼ˆè¦–ç‚ºæ­£å¼å¹«çœ¾ï¼‰
  promoteList.forEach(m => {
    addGuildTag(guildBattleBox, m, { bypassRules: true });
  });
  // æ¸…æ‰æ‰€æœ‰é¸å–ç‹€æ…‹
  document
    .querySelectorAll(".position-tag.guild-selected")
    .forEach(t => t.classList.remove("guild-selected"));
   // é‡æ–°æ¯”å°ç´…ï¼ç¶ ã€é‡æ’é †åº
  updateGuildBattleAndWeekComparison();
  // å…ˆå­˜åˆ° localStorage
  saveState();
  // â˜… å†å‘¼å«é ç«¯å„²å­˜ï¼ˆæœƒè‡ªå‹•æª¢æŸ¥ç™»å…¥ & æ‰“åˆ° GASï¼‰
  requestSave();
  // æ›´æ–°äº¤æ›æŒ‰éˆ•å¯æŒ‰ç‹€æ…‹
  updateGuildSwapButtonState();
  // V16.1æ–°å¢ï¼Œéœé»˜å„²å­˜åˆ°å¾Œå°ï¼ŒæˆåŠŸå¾Œé¡¯ç¤ºè¨Šæ¯
requestSave({
  silent: true,
  onSuccess() {
    showGuildSwapMessage("äº¤æ›å®Œæˆï¼Œå·²åŒæ­¥ç”Ÿæ•ˆ", "#2563eb");
  }
});
}


    function sameJSON(a,b){return JSON.stringify(a)===JSON.stringify(b);}

    function teamColorByName(name){
      if(name==="æ‹†å¡”") return "#7f1d1d";
      if(name==="æ©Ÿå‹•") return "#4c1d95";
      if(name==="é˜²å®ˆ") return "#1e3a8a";
      return "#0f172a";
    }
    function hexToRgb(hex){const s=hex.replace('#','');const n=parseInt(s,16);return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
    function rgbToHsl(r,g,b){r/=255; g/=255; b/=255; const max=Math.max(r,g,b),min=Math.min(r,g,b); let h,s,l=(max+min)/2; if(max===min){h=s=0;} else{const d=max-min; s=l>0.5?d/(2-max-min):d/(max+min); switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;} h/=6;} return {h,s,l};}
    function hslToHex(h,s,l){function f(n){const k=(n+h*12)%12; const a=s*Math.min(l,1-l); const c=l-a*Math.max(-1, Math.min(k-3, Math.min(9-k,1))); return Math.round(255*c).toString(16).padStart(2,'0');} return "#"+f(0)+f(8)+f(4);}
    function darkenHex(hex, amt=0.25){ const {r,g,b} = hexToRgb(hex); const {h,s,l} = rgbToHsl(r,g,b); const nl = Math.max(0, l - amt); return hslToHex(h,s,nl); }
    /*V16.2æ–°å¢*/
    function lightenHex(hex, amt = 0.25) {
    const { r, g, b } = hexToRgb(hex);
    const { h, s, l } = rgbToHsl(r, g, b);
    const nl = Math.min(1, l + amt);
    return hslToHex(h, s, nl);
    }


    /* ä¾æ“šå¯¬åº¦èª¿æ•´å°éšŠæ¬„å¯¬ */
    function adjustSquadWidths(block) {
      const squadsContainer = block.querySelector('.squads');
      if (!squadsContainer) return;
      const squads = squadsContainer.querySelectorAll('.squad');
      const count = squads.length || 1;
      const width = window.innerWidth;

      if (width <= 768) {
        if (count <= 4) squads.forEach(sq => { sq.style.flex = "0 0 calc(21.5% - 6px)"; });
        else { const pct = 100 / count; squads.forEach(sq => { sq.style.flex = "0 0 calc(" + (pct - 4.8) + "%)"; }); }
        return;
      }
      if (width <= 1024) {
        if (count <= 4) squads.forEach(sq => { sq.style.flex = "0 0 calc(22.5% - 6px)"; });
        else { const pct = 100 / count; squads.forEach(sq => { sq.style.flex = "0 0 calc(" + (pct - 3.6) + "%)"; }); }
        return;
      }
      if (count <= 4) squads.forEach(sq => { sq.style.flex = "0 0 calc(23.5% - 6px)"; });
      else { const pct = 100 / count; squads.forEach(sq => { sq.style.flex = "0 0 calc(" + (pct - 2.3) + "%)"; }); }
    }
    window.addEventListener("resize", () => {
      document.querySelectorAll(".team-block").forEach(adjustSquadWidths);
    });

    /*V17ä¿®æ”¹ï¼Œåœ¨æ‰‹å‹•è¼¸å…¥æ™‚ç¶­æŒç‹€æ…‹åˆç†*/
    function handlePanelInputChange(input){ 
  input.dataset.dirty = "1"; 
  clearHighlightOnEdit(input); 
  // â˜… æœ¬é€±åå­—æ ¼ï¼šå¦‚æœæœ‰åå­—ä½†æ²’æœ‰ statusï¼Œå°±çµ¦é è¨­ã€Œæœªä¸Šç·šã€
  if (input.dataset.side === "this" && input.dataset.role === "name") {
    const hasName = (input.value || "").trim() !== "";
    if (!hasName) {
      resetCellStatus(input);
    } else if (!input.dataset.status) {
      resetCellStatus(input);  // æ–°è¼¸å…¥çš„äººï¼Œé è¨­ç•¶ä½œæœªä¸Šç·š
    } else {
      setCellStatus(input, input.dataset.status);
    }
  }
  saveState(); 
  if (input.dataset.side === "this" && input.dataset.role === "name") {
    updateGuildBattleAndWeekComparison();
  }
}


    function markDirty(el){ if (el) el.dataset.dirty = "1"; }


// â˜… V17.1æœ¬é€±åå–®ç”¨çš„å‡ºå¸­ç‹€æ…‹
// absent = æœªä¸Šç·š, present = ç¢ºèªåƒæˆ°, unsure = ä¸ç¢ºå®š
const MEMBER_STATUS_ORDER = ["present", "unsure", "absent"]; // é»ä¸€ä¸‹å¾€ä¸‹ä¸€å€‹ç‹€æ…‹
const MEMBER_STATUS_PRIORITY = {
  absent: 3,
  unsure: 2,
  present: 1,
};
const WEEK_STATUS_LABELS = {
  present: "ç¢ºèªåƒæˆ°", // å·²é€²çµ„ã€æˆ–ç¢ºå®šæœƒæ™šåˆ°ä½†æœƒä¾†
  unsure: "ä¸ç¢ºå®š",   // ç‹€æ³ä¸æ˜ã€æ›æ©Ÿã€èªªæœƒä¾†ä½†æ™‚é–“åˆ°äº†é‚„æ²’é€²çµ„
  absent: "æœªä¸Šç·š",   // æ ¹æœ¬æ²’ä¸Šç·š
};


// V17.2 çµ¦æœ¬é€±æ¬„ä½è¨­å®šç‹€æ…‹ï¼ˆæœƒå½±éŸ¿è¦–è¦ºï¼‰
function setCellStatus(input, status) {
  if (!input) return;
  const nameRow = input.closest(".member-row");
  if (!nameRow) return;
  const skillRow = nameRow.nextElementSibling;
  const pairRows = [nameRow, skillRow].filter(Boolean);
  const oldStatus = input.dataset.status || "absent";
  // å…ˆæŠŠèˆŠç‹€æ…‹ class æ‹¿æ‰
  pairRows.forEach(row => {
    row.classList.remove("status-absent", "status-late", "status-unsure", "status-present");
  });
  // è¨˜éŒ„æ–°ç‹€æ…‹
  input.dataset.status = status;
  // æ¨™è¨˜æ–°ç‹€æ…‹
  const cls = "status-" + status;
  pairRows.forEach(row => row.classList.add(cls));
  // æ¸…æ‰èˆŠ inline styleï¼ˆä½†ä¿ç•™ border-leftï¼‰
  pairRows.forEach(row => {
    row.querySelectorAll("input").forEach(el => {
      el.style.background = "";
      el.style.borderColor = "";
      el.style.color = "";
    });
  });
  // â˜… èª¿æ•´è·æ¥­æ¢é‚è¼¯
  if (input.dataset.side === "this" && input.dataset.role === "name") {
    const memberName = (input.value || "").trim();
    const job = input.dataset.job || getJobByName(memberName) || "";

      //V17.2 â˜… èª¿æ•´è·æ¥­æ¢é‚è¼¯ï¼šæ‰€æœ‰ç‹€æ…‹éƒ½ç”¨è·æ¥­è‰²
  if (input.dataset.side === "this" && input.dataset.role === "name") {
    const memberName = (input.value || "").trim();
    const job = input.dataset.job || getJobByName(memberName) || "";

    if (job && roleColors[job]) {
      const dark = darkenHex(roleColors[job], 0.25);
      // ä¸è«– present / late / unsure / absentï¼Œéƒ½ç”¨è·æ¥­è‰²æ¢
      input.style.borderLeft = "6px solid " + dark;
    } else {
      // æ²’è·æ¥­è³‡æ–™å°±æ¸…ç©º
      input.style.borderLeft = "";
    }
  }
  }
  // æ›´æ–°è³‡æ–™
  const name = (input.value || "").trim();
  if (name) {
    weekStatusMap[name] = status;
  } else if (weekStatusMap[name] === oldStatus) {
    delete weekStatusMap[name];
  }
  updateGuildBattleAndWeekComparison();
}




/*V17ä¿®æ”¹ç©ºæ ¼ï¼å®Œå…¨æ²’ç‹€æ…‹ï¼Œæœ‰åå­—ï¼æœªä¸Šç·š*/
function resetCellStatus(input) {
  if (!input) return;
  const hasName = (input.value || "").trim() !== "";
  if (!hasName) {
    // ç©ºæ¬„ä½ï¼šä¸å¥—ä»»ä½•ç‹€æ…‹ï¼é¡è‰²
    clearCellStatus(input);
    return;
  }
  // æœ‰åå­—ä½†æ²’ç‰¹åˆ¥æŒ‡å®š â†’ é è¨­ç‚ºã€Œæœªä¸Šç·šã€
  setCellStatus(input, "absent");
}


/*V17æ–°å¢æ¸…æ‰é¡è‰²*/
function clearCellStatus(input) {
  if (!input) return;
  delete input.dataset.status;
  const nameRow = input.closest(".member-row");
  if (!nameRow) return;
  const all = ["status-absent", "status-present", "status-late", "status-unsure"];
  nameRow.classList.remove(...all);
  const skillRow = nameRow.nextElementSibling;
  if (skillRow && skillRow.classList.contains("member-row")) {
    skillRow.classList.remove(...all);
  }
}

/*17.1ä¿®æ”¹*/
function cycleCellStatus(input) {
  if (!input) return;
  const current = input.dataset.status || "absent"; // é è¨­è¦–ç‚ºã€Œæœªä¸Šç·šã€
  const idx = MEMBER_STATUS_ORDER.indexOf(current);
  const next = MEMBER_STATUS_ORDER[(idx + 1) % MEMBER_STATUS_ORDER.length];
  setCellStatus(input, next);
  // ç‹€æ…‹æœƒå½±éŸ¿å­¸å¾’è‡ªå‹•ç”¢ç”Ÿ â†’ é‡æ–°æ¯”å°
  if (input.dataset.side === "this" && input.dataset.role === "name") {
    updateGuildBattleAndWeekComparison();
    saveState();
  }
}

/*V17.3å¾…åˆªï¼Œç§»é™¤å³éµåˆ‡æ›åŠŸèƒ½ // â˜… v17æœ¬é€±åå–®ï¼šå³éµåå­—æ¬„ â†’ åˆ‡æ›ç‹€æ…‹
function onNameCellContextMenu(e, input) {
  e.preventDefault();
  e.stopPropagation();
  // åªè®“ã€Œæœ¬é€±åå–®ã€çš„åå­—æ¬„æ”¯æ´å³éµåˆ‡æ›ç‹€æ…‹
  if (!input || input.dataset.side !== "this" || input.dataset.role !== "name") {
    return;
  }
  const hasName = (input.value || "").trim() !== "";
  if (!hasName) {
    // ç©ºæ ¼ï¼šç¶­æŒåŸæœ¬æ¸…ç©ºé‚è¼¯ä¹Ÿå¯ä»¥ï¼Œä½†é€šå¸¸å³éµç©ºæ ¼å°±ä¸åšäº‹
    return;
  }
  // ç”¨ä½ å·²ç¶“å¯«å¥½çš„ cycleCellStatus ä¾†è¼ªæµåˆ‡æ› present / late / unsure / absent
  cycleCellStatus(input);
  // åˆ‡æ›å®Œè¦æ›´æ–°å­¸å¾’æ¬„æ¨™ç±¤ + å­˜æª”
  updateGuildBattleAndWeekComparison();
  saveState();
} */


/*V17ä¿®æ”¹*/
function createMemberInputs(side) {
  const isThisWeek = side === "this";
  let html = "";
  for (let i = 1; i <= 6; i++) {
    html += `
      <div class="member-row">
        <input
          data-role="name"
          data-side="${side}"
          draggable="true"
          ondragstart="dragFromPanel(event)"
          ondragover="allowDrop(event)"
          ondrop="dropMember(event)"
          oncontextmenu="return false"
          oninput="handlePanelInputChange(this)"
          onclick="onNameCellClick(event, this)"
          placeholder="æˆå“¡${i}"
        >
      </div>
      <div class="member-row">
        <input
          data-role="skill"
          class="readonly-skill"
          placeholder=""
          readonly
        >
      </div>
    `;
  }
  return html;
}


    function createGroupTagSelect(selected="ä¸€åœ˜") {
      const opts = ["ä¸€åœ˜","äºŒåœ˜","ä¸‰åœ˜","å››åœ˜"];
      return `
        <select class="team-tag-select" onchange="markDirty(this); saveState()">
          ${opts.map(o => `<option value="${o}" ${o===selected?'selected':''}>${o}</option>`).join("")}
        </select>
      `;
    }

    function createSquad(idx, side, teamName){
      const sq = document.createElement("div");
      sq.className = "squad";
      sq.dataset.squad = idx;
      sq.innerHTML = `
        <div class="squad-title">ç¬¬${idx}å°éšŠ</div>
        ${side==="this" ? `<button class="squad-del-btn" onclick="deleteThisSquad(this)">Ã—</button>` : ""}
        ${createMemberInputs(side)}
      `;
      return sq;
    }

function createTeamBlock(side, teamName, tag = "ä¸€åœ˜") {
  const block = document.createElement("div");
  block.className = "team-block";
  block.dataset.team = teamName;
  block.dataset.side = side;        // ç¾åœ¨å¯¦éš›åªæœƒæ˜¯ "this"
  const headColor = teamColorByName(teamName);

  block.innerHTML = `
    <div class="team-head" style="background:${headColor}">
      <div class="team-head-left">
        <!-- å›ºå®šå°±æ˜¯æœ¬é€± -->
        <span class="th-title">æœ¬é€±ï¼${teamName}</span>
        <!-- ä¸€å¾‹ç”¨ä¸‹æ‹‰é¸æ“‡åœ˜åˆ¥ -->
        ${createGroupTagSelect(tag)}
      </div>
      <div class="head-actions">
        <!-- ä¸€å¾‹å¯æ–°å¢å°éšŠ -->
        <button class="head-add-btn" onclick="addSquadToTeamFromHead(this)">ï¼‹ æ–°å¢å°éšŠ</button>
      </div>
    </div>
    <div class="squads"></div>
  `;

  const sqs = block.querySelector(".squads");
  for (let s = 1; s <= 3; s++) {
    sqs.appendChild(createSquad(s, side, teamName));
  }
  block.dataset.lastSquadCount = "3";
  adjustSquadWidths(block);
  return block;
}

teams.forEach(t => {
  thisWeekPanel.appendChild(createTeamBlock("this", t));
  // V17â˜… å»ºå¥½æœ¬é€±åå–®å¾Œï¼Œåˆå§‹åŒ–ç‹€æ…‹ç‚ºã€Œæœªä¸Šç·šã€
  thisWeekPanel
  .querySelectorAll("input[data-role='name'][data-side='this']")
  .forEach(inp => resetCellStatus(inp));

});


    function setupPanelCarousel(panelId) {
      const panel = document.getElementById(panelId);
      if (!panel) return;

      const blocks = Array.from(panel.querySelectorAll(".team-block"));
      if (!blocks.length) return;

      const wrap = document.createElement("div");
      wrap.className = "teams-wrap";
      blocks.forEach(b => wrap.appendChild(b));
      panel.appendChild(wrap);

      const dots = document.createElement("div");
      dots.className = "team-dots";
      panel.appendChild(dots);

      /*V16.2æ»‘å‹•å‹•ç•«*/
      let current = 0;
  function show(index) {
  if (index < 0 || index >= blocks.length) return;
  // â˜… å…ˆæ±ºå®šæ˜¯å¾€å·¦é‚„æ˜¯å¾€å³
  let dir = null;
  if (index > current) dir = "right";
  else if (index < current) dir = "left";
  current = index;
  blocks.forEach((b, i) => {
    const willActive = (i === index);
    b.classList.toggle("active", willActive);
    // åªæœ‰è¦é¡¯ç¤ºçš„é‚£ä¸€åœ˜æ‰å¥—å‹•ç•«
    if (willActive) {
      b.classList.remove("slide-from-left", "slide-from-right");
      // å¼·åˆ¶ reflowï¼Œè®“å‹•ç•«å¯ä»¥é‡æ’­
      void b.offsetWidth;
      if (dir === "right") {
        b.classList.add("slide-from-right");
      } else if (dir === "left") {
        b.classList.add("slide-from-left");
      }
    }
  });
  const allDots = dots.querySelectorAll(".team-dot");
  allDots.forEach((d, i) => { d.classList.toggle("active", i === index); });
  // ä¿ç•™ä½ åŸæœ¬çš„ thisWeekCarousel é‚è¼¯
  if (panelId === "thisWeek") {
    if (!window.thisWeekCarousel) window.thisWeekCarousel = {};
    window.thisWeekCarousel._show = show;
    window.thisWeekCarousel.index = index;
    window.thisWeekCarousel.count = blocks.length;
  }
}



  /*V16.2ä¿®æ”¹åœ“é»é¡è‰²*/
  blocks.forEach((b, idx) => {
  const dot = document.createElement("button");
  dot.type = "button";
  dot.className = "team-dot" + (idx === 0 ? " active" : "");
  // â˜… ä½ å¯ä»¥è‡ªç”±æ”¹é€™è£¡çš„é¡è‰²ï¼ˆåœ“é»ç”¨ï¼‰
const teamDotColors = {
  "é€²æ”»": "#27374D", // é»‘
  "æ‹†å¡”": "#D84040", // ç´…
  "æ©Ÿå‹•": "#9B5DE0", // ç´«
  "é˜²å®ˆ": "#40679E"  // è—
};
  // â˜… ç”¨åœ˜éšŠåç¨±æ±ºå®šåœ“é»åº•è‰²
  const teamName = b.dataset.team || "";
  // å…ˆçœ‹æœ‰æ²’æœ‰ä½ è‡ªå·±æŒ‡å®šçš„åœ“é»é¡è‰²
  const customDotColor = teamDotColors[teamName];
  if (customDotColor) {
  dot.style.background = customDotColor;
  } else {
  // æ²’è¨­å®šæ™‚æ‰é€€å›åŸæœ¬é‚è¼¯
  const baseColor = teamColorByName(teamName);
  if (baseColor) {
    dot.style.background = lightenHex(baseColor, 0.35);
  } else {
    dot.style.background = "#e2e8f0";
  }
}

  dot.onclick = () => show(idx);
  dots.appendChild(dot);
});


      let startX = 0, startY = 0, locked = false, isHorizontal = false;
      wrap.addEventListener("touchstart", function (e) {
        if (!e.touches || e.touches.length === 0) return;
        startX = e.touches[0].clientX; startY = e.touches[0].clientY; locked = false; isHorizontal = false;
      }, { passive: true });

      wrap.addEventListener("touchmove", function (e) {
        const t = e.touches && e.touches[0]; if (!t) return;
        const diffX = t.clientX - startX; const diffY = t.clientY - startY;
        if (!locked) { if (Math.abs(diffX) > 8 || Math.abs(diffY) > 8) { locked = true; isHorizontal = Math.abs(diffX) > Math.abs(diffY); } }
        if (locked && isHorizontal) e.preventDefault();
      }, { passive: false });

      wrap.addEventListener("touchend", function (e) {
        if (!locked || !isHorizontal) return;
        const endTouch = e.changedTouches && e.changedTouches[0]; if (!endTouch) return;
        const diffX = endTouch.clientX - startX; if (Math.abs(diffX) < 40) return;
        if (diffX < 0) { if (current < blocks.length - 1) show(current + 1); }
        else { if (current > 0) show(current - 1); }
      });

      /*V16.2æ–°å¢åœ˜éšŠåˆ‡æ›æ§åˆ¶å™¨*/
      if (panelId === "thisWeek") {
  window.thisWeekCarousel = window.thisWeekCarousel || {};
  window.thisWeekCarousel._show = show;
  window.thisWeekCarousel.index = 0;
  window.thisWeekCarousel.count = blocks.length;
  window.thisWeekCarousel.next = function () {
    if (this.index < this.count - 1) {
      this._show(this.index + 1);
    }
  };
  window.thisWeekCarousel.prev = function () {
    if (this.index > 0) {
      this._show(this.index - 1);
    }
  };
}
  show(0);
      
    }
    setupPanelCarousel("thisWeek");

  // â˜…â˜… V16.2 æ»‘é¼ æ»¾è¼ªåˆ‡æ›åœ˜éšŠï¼ˆæ¡Œæ©Ÿç”¨ï¼‰â˜…â˜…
  (function enableWheelSwitchOnThisWeek() {
  if (!thisWeekPanel) return;
  let lastSwitch = 0;
  const COOL_DOWN = 400; // å…©æ¬¡åˆ‡æ›é–“éš”ï¼ˆæ¯«ç§’ï¼‰ï¼Œé¿å…ä¸€æ»¾è·³å¾ˆå¤šåœ˜
  thisWeekPanel.addEventListener("wheel", function (e) {
    if (!window.thisWeekCarousel) return;
    // åˆ¤æ–·ä¸»è¦æ˜¯ä¸Šä¸‹é‚„æ˜¯å·¦å³çš„æ»¾å‹•
    const delta = Math.abs(e.deltaX) > Math.abs(e.deltaY) ? e.deltaX : e.deltaY;
    if (Math.abs(delta) < 10) return; // å¤ªå°çš„è®ŠåŒ–å°±å¿½ç•¥
    const now = Date.now();
    if (now - lastSwitch < COOL_DOWN) return; // ç¯€æµï¼Œé¿å…ä¸€æ¬¡æ»¾å¥½å¹¾åœ˜
    // åœ¨æœ¬é€±åå–®ä¸Šæ»¾è¼ªæ™‚ï¼Œå°±ä¸è¦è®“æ•´é ä¸€èµ·æ»¾å‹•
    e.preventDefault();
    if (delta > 0) {
      // å¾€ä¸‹æˆ–å¾€å³æ»¾ â†’ ä¸‹ä¸€åœ˜
      window.thisWeekCarousel.next && window.thisWeekCarousel.next();
    } else {
      // å¾€ä¸Šæˆ–å¾€å·¦æ»¾ â†’ ä¸Šä¸€åœ˜
      window.thisWeekCarousel.prev && window.thisWeekCarousel.prev();
    }
    lastSwitch = now;
  }, { passive: false });
})();



/*V117.2ä¿®æ”¹æ–°å¢ç›£è½ï¼Œåªè¦åœ¨æ‹–æ›³æ™‚æ»‘é€²åœ˜éšŠå€åŸŸé‚Šç·£ï¼Œå°±å‘¼å«åˆ‡æ›é é¢*/
    let lastTeamAutoSwitchTime = 0;
  function handleThisWeekDragOver(e) {
  // â˜… æ¡Œæ©Ÿç‰ˆï¼šå¦‚æœæ‹–æ›³ä¾†æºä¸æ˜¯ã€Œæœ¬é€±åå–®ã€ï¼Œå°±ä¸è¦è‡ªå‹•åˆ‡æ›åœ˜
  if (window.innerWidth > 1300 && dragSourceSide !== "this") {
    return;
  }
  if (!window.thisWeekCarousel || !window.thisWeekCarousel._show) return;
  const panel = thisWeekPanel;
  if (!panel) return;
  // è®“é€™å€‹å€åŸŸå¯ä»¥ç•¶ drop ç›®æ¨™
  e.preventDefault();
  const rect = panel.getBoundingClientRect();
  const x = e.clientX;
  const edge = 48; // è·é›¢é‚Šç·£ 48px å…§å°±ç®—é é‚Š
  let dir = null;
  if (x - rect.left < edge) {
    dir = "prev";
  } else if (rect.right - x < edge) {
    dir = "next";
  }
  if (!dir) return;
  const now = Date.now();
  // ç¯€æµï¼š0.6 ç§’å…§æœ€å¤šåˆ‡ä¸€æ¬¡ï¼Œé¿å…ç‹‚è·³
  if (now - lastTeamAutoSwitchTime < 600) return;
  if (dir === "prev") {
    window.thisWeekCarousel.prev();
  } else {
    window.thisWeekCarousel.next();
  }
  lastTeamAutoSwitchTime = now;
}
// â˜… ä¸å†åˆ¤æ–·å¯¬åº¦ï¼Œæ°¸é ç¶å®šï¼Œåˆ¤æ–·äº¤çµ¦ handler æœ¬èº«
thisWeekPanel.addEventListener("dragover", handleThisWeekDragOver);




    function renumberSquads(block){
      const sqs = block.querySelectorAll(".squad");
      sqs.forEach((sq,idx)=>{ sq.dataset.squad = idx+1; const title = sq.querySelector(".squad-title"); if(title) title.textContent = `ç¬¬${idx+1}å°éšŠ`; });
    }

    function addSquadToTeamFromHead(btn){
      const block = btn.closest(".team-block");
      const sqs = block.querySelector(".squads");
      const side = block.dataset.side;
      const teamName = block.dataset.team;
      const count = sqs.children.length;
      const newSq = createSquad(count + 1, side, teamName);
      newSq.dataset.newlyAdded = "1";
      sqs.appendChild(newSq);
      adjustSquadWidths(block);
      markDirty(block);
      saveState();
    }

    function deleteThisSquad(btn){
      const squad = btn.closest(".squad");
      const block = btn.closest(".team-block");
      const parent = squad.parentElement;
      if(confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹å°éšŠå—ï¼Ÿ")){
        parent.removeChild(squad);
        renumberSquads(block);
        adjustSquadWidths(block);
        markDirty(block);
        block.dataset.lastSquadCount = String(parent.children.length);
        saveState();
      }
    }

function clearPanelCell(e) {
  e.preventDefault();
  const input = e.target;
  if (input.dataset.role === "name") {
    clearInputAndSkill(input);
    markDirty(input);
    saveState();
    // â˜… è‹¥æ˜¯æœ¬é€±åå–® â†’ é‡æ–°æ¯”å°
    if (input.dataset.side === "this") {
      updateGuildBattleAndWeekComparison();
    }
  }
}



    function clearInputAndSkill(input){
      input.value = "";
      input.style.borderLeft = "";
      input.style.color = "";
      input.dataset.job = "";
      resetCellStatus(input);   // V17æ–°å¢â˜… æ¸…ç©ºæ™‚åŒæ­¥æŠŠç‹€æ…‹æ”¹å›æœªä¸Šç·š
      const skillRow = input.parentElement.nextElementSibling;
      if (skillRow && skillRow.querySelector("input[data-role='skill']")) {
        const skillInput = skillRow.querySelector("input[data-role='skill']");
        setSkillInputValue(skillInput, "");
      }
      input.classList.remove("highlight-new","highlight-missing");
    }

    function clearHighlightOnEdit(input){ input.classList.remove("highlight-new","highlight-missing"); }

    let subsPage = 1;
    const subsPerPage = 3;

    function createSubRow(name = "", skill = "", markDirty = false) {
      const row = document.createElement("div");
      row.className = "substitute-row";
      row.draggable = true;
      row.dataset.subIndex = subCounter++;
      if (markDirty) row.dataset.dirty = "1";
      row.ondragstart = dragFromSub;
      row.innerHTML = `
  <input class="sub-name" placeholder="æ›¿è£œæˆå“¡" value="${name}"
    onclick="maybeOpenMemberPicker(event, this)"
    ondragover="allowDrop(event)" ondrop="dropMember(event)"
    onblur="applyColorByName(this); markDirty(this); saveState();">
  <input class="sub-skill" placeholder="æŠ€èƒ½" value="${skill}" oninput="markDirty(this); saveState()">
  <button class="del-btn" onclick="deleteSub(this)">åˆª</button>
  <span class="sub-status"></span>
`;  /*V15.1æ–°å¢æ“‹é»æ“Š*/

      // â­ å–å¾—æ›¿è£œåå­—æ¬„
  const nameInput = row.querySelector(".sub-name");
  // å¥—é¡è‰²ï¼ˆåŸæœ¬å°±æœ‰çš„é‚è¼¯ï¼‰
  applyColorByName(nameInput);
  // â­ æ–°å¢ï¼šä¸€å»ºç«‹å°±å…ˆç®—ä¸€æ¬¡å­—é«”å¤§å°
  /*fitNameFont(nameInput);*/
      subsList.appendChild(row);
    } 

  /*V15.1æ–°å¢ æ›¿è£œä¹Ÿé–é»æ“Š*/
function onSubNameClick(e, input) {
  const val = (input.value || "").trim();
  // âœ… æ¬„ä½è£¡å·²ç¶“æœ‰åå­—ï¼šä¸è®“å®ƒé€²å…¥ç·¨è¼¯ï¼Œåªèƒ½ç•¶æ‹–æ›³çš„é‚£ä¸€åˆ—
  if (val) {
    e.preventDefault();
    e.stopPropagation();
    input.blur();  // æŠŠæ¸¸æ¨™æ”¶æ‰ï¼Œé¿å…è·³å‡ºéµç›¤
    return;
  }
  // âœ… ç©ºç™½æ¬„ä½ï¼šä¿ç•™åŸæœ¬è¡Œç‚ºï¼Œå¯ä»¥é»é€²å»æ‰“å­—æˆ–ç•¶ drop ç›®æ¨™
}

    
    function refreshSubsView() {
      const rows = Array.from(subsList.children);
      const totalPages = Math.max(1, Math.ceil(rows.length / subsPerPage));
      if (subsPage > totalPages) subsPage = totalPages;
      rows.forEach((row, idx) => {
        const pageOfRow = Math.floor(idx / subsPerPage) + 1;
        row.style.display = (pageOfRow === subsPage) ? "grid" : "none";
      });
      const sel = document.getElementById("subsPageSelect");
      if (sel) {
        sel.innerHTML = "";
        for (let p = 1; p <= totalPages; p++) {
          const opt = document.createElement("option");
          opt.value = p;
          opt.textContent = "ç¬¬ " + p + " é ";
          if (p === subsPage) opt.selected = true;
          sel.appendChild(opt);
        }
      }
    }
    function subsPrev() { if (subsPage > 1) { subsPage--; refreshSubsView(); } }
    function subsNext() {
      const rows = Array.from(subsList.children);
      const totalPages = Math.max(1, Math.ceil(rows.length / subsPerPage));
      if (subsPage < totalPages) { subsPage++; refreshSubsView(); }
    }
    function subsJump(p) { subsPage = parseInt(p, 10) || 1; refreshSubsView(); }

    function addSub() { createSubRow("", "", true); saveState(); refreshSubsView(); }
    function deleteSub(btn) { subsList.removeChild(btn.parentElement); saveState(); refreshSubsView(); }

    function renderRoleTabs(){
      roleTabs.innerHTML = "";
      const allTab = document.createElement("div");
      allTab.className = "role-tab" + (activeRoleFilter==="" ? " active" : "");
      allTab.textContent = "å…¨éƒ¨";
      allTab.style.background = "#e2e8f0";
      allTab.onclick = ()=>{activeRoleFilter=""; memberPage=1; renderMemberList();};
      roleTabs.appendChild(allTab);
      Object.keys(roleColors).forEach(r=>{
        const tab = document.createElement("div");
        tab.className = "role-tab" + (activeRoleFilter===r ? " active" : "");
        tab.textContent = r;
        tab.style.background = roleColors[r];
        tab.onclick = ()=>{activeRoleFilter=r; memberPage=1; renderMemberList();};
        roleTabs.appendChild(tab);
      });
    }

    function getFilteredMembers(){
      const keyword = searchInput.value.trim();
      return allMembers.filter(m=>{
        const matchRole = !activeRoleFilter || m.job===activeRoleFilter;
        const matchText = !keyword || m.name.includes(keyword) || (m.skill && m.skill.includes(keyword));
        return matchRole && matchText;
      });
    }

    function renderMemberList(){
      const filtered = getFilteredMembers();
      const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
      if(memberPage>totalPages) memberPage = totalPages;
      const start = (memberPage-1)*pageSize;
      const pageItems = filtered.slice(start, start+pageSize);

      memberList.innerHTML = "";
      pageItems.forEach(m=>{
        const item = document.createElement("div");
        item.className = "member-item";
        item.draggable = true;
        item.ondragstart = e => dragFromMemberList(e, m);
        const darkColor = m.job && roleColors[m.job] ? darkenHex(roleColors[m.job],0.25) : "#e2e8f0";
        item.style.borderLeft = "4px solid " + darkColor;
        item.innerHTML = `
          <div class="member-left" data-id="${m.id}">
            <div class="member-name" style="color:${darkColor}">${m.name}</div>
            <div class="member-skill">${m.skill || ""}</div>
          </div>
          <div class="member-actions" id="member-actions-${m.id}">
            <button onclick="startInlineEdit(${m.id})">ç·¨</button>
            <button onclick="deleteMember(${m.id})">åˆª</button>
          </div>
        `;
        memberList.appendChild(item);
      });

      const sel = document.getElementById("pageSelect");
      sel.innerHTML = "";
      for(let p=1;p<=totalPages;p++){
        const opt = document.createElement("option");
        opt.value = p;
        opt.textContent = "ç¬¬ " + p + " é ";
        if(p===memberPage) opt.selected = true;
        sel.appendChild(opt);
      }
    }
    function prevPage(){ if(memberPage>1){ memberPage--; renderMemberList(); } }
    function nextPage(){
      const totalPages = Math.max(1, Math.ceil(getFilteredMembers().length / pageSize));
      if(memberPage<totalPages){ memberPage++; renderMemberList(); }
    }
    function jumpPage(p){ memberPage = parseInt(p,10); renderMemberList(); }
    
    /*V16æ–°å¢æª¢æŸ¥äººæ•¸*/
    function toggleAddMember() {
  const form = document.getElementById("addMemberForm");
  const limitMsg = document.getElementById("memberLimitMsg");
  if (allMembers.length >= 80) {
    // æ»¿å“¡ï¼šä¸æ‰“é–‹è¡¨å–®ï¼Œåªé¡¯ç¤ºæç¤ºæ–‡å­—
    if (form) form.style.display = "none";
    if (limitMsg) limitMsg.style.display = "block";
    return;
  }
  if (limitMsg) limitMsg.style.display = "none";
  form.style.display = form.style.display === "flex" ? "none" : "flex";
}


    /*V16æ›´æ–°æª¢æŸ¥äººæ•¸*/
    function addMember() {
  const limitMsg = document.getElementById("memberLimitMsg");
  // â˜… å…ˆæª¢æŸ¥ä¸Šé™ 80 äºº
  if (allMembers.length >= 80) {
    if (limitMsg) limitMsg.style.display = "block";
    // ä¸æ–°å¢
    return;
  }
  const name = document.getElementById("newName").value.trim();
  const job = document.getElementById("newJob").value;
  const skill = document.getElementById("newSkill").value.trim();
  if (!name || !job) {
    alert("æˆå“¡åç¨±èˆ‡è·æ¥­å¿…å¡«");
    return;
  }
  allMembers.push({ id: ++nextMemberId, name, job, skill });
  document.getElementById("newName").value = "";
  document.getElementById("newJob").value = "";
  document.getElementById("newSkill").value = "";
  renderMemberList();
  document.getElementById("addMemberForm").style.display = "none";
  if (limitMsg) limitMsg.style.display = "none";
  saveState();
}


    function startInlineEdit(id){
      const item = [...memberList.querySelectorAll(".member-left")].find(div=>parseInt(div.dataset.id,10)===id);
      if(!item) return;
      const m = allMembers.find(x=>x.id===id);
      const actionArea = document.getElementById(`member-actions-${id}`);
      if(actionArea) actionArea.style.display = "none";
      item.innerHTML = `
        <input class="edit-input" id="edit-name-${id}" value="${m.name}">
        <select class="edit-input" id="edit-job-${id}">
          <option value="ä¹éˆ" ${m.job==="ä¹éˆ"?"selected":""}>ä¹éˆ</option>
          <option value="éµè¡£" ${m.job==="éµè¡£"?"selected":""}>éµè¡£</option>
          <option value="ç´ å•" ${m.job==="ç´ å•"?"selected":""}>ç´ å•</option>
          <option value="é¾åŸ" ${m.job==="é¾åŸ"?"selected":""}>é¾åŸ</option>
          <option value="ç¥ç›¸" ${m.job==="ç¥ç›¸"?"selected":""}>ç¥ç›¸</option>
          <option value="ç¢å¤¢" ${m.job==="ç¢å¤¢"?"selected":""}>ç¢å¤¢</option>
          <option value="è¡€æ²³" ${m.job==="è¡€æ²³"?"selected":""}>è¡€æ²³</option>
        </select>
        <input class="edit-input" id="edit-skill-${id}" value="${m.skill||""}">
        <div style="display:flex;gap:.3rem;">
          <button class="float-btn" style="margin-top:.3rem;font-size:.65rem;padding:.2rem .4rem;" onclick="saveInlineEdit(${id})">å„²å­˜</button>
          <button class="float-btn secondary" style="margin-top:.3rem;font-size:.65rem;padding:.2rem .4rem;" onclick="renderMemberList()">å–æ¶ˆ</button>
        </div>
      `;
    }

// V16âœ… ç•¶å…¨éƒ¨æˆå“¡åå–®è¢«ç·¨è¼¯å¾Œï¼ŒåŒæ­¥æ›´æ–°ï¼šæœ¬é€±ï¼‹æ›¿è£œï¼‹å¹«æœƒè·ä½
function syncEditedMemberEverywhere(oldMember, newMember) {
  if (!oldMember) return;
  const oldName = (oldMember.name || "").trim();
  const newName = (newMember.name || "").trim();
  // 1. æœ¬é€±åå–®
  thisWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp => {
    if (inp.value.trim() === oldName) {
      inp.value = newName;
      applyJobColor(inp, newMember.job);

      const skillRow = inp.parentElement.nextElementSibling;
      if (skillRow && skillRow.querySelector("input[data-role='skill']")) {
        setSkillInputValue(
          skillRow.querySelector("input[data-role='skill']"),
          newMember.skill || ""
        );
      }
      inp.dataset.dirty = "1";
    }
  });
  // 2. æ›¿è£œåå–®
  subsList.querySelectorAll(".substitute-row").forEach(row => {
    const nameInput  = row.querySelector(".sub-name");
    const skillInput = row.querySelector(".sub-skill");
    if (!nameInput) return;

    if (nameInput.value.trim() === oldName) {
      nameInput.value = newName;
      applyJobColor(nameInput, newMember.job);
      if (skillInput) skillInput.value = newMember.skill || "";
      nameInput.dataset.dirty = "1";
    }
  });
  // 3. å¹«æœƒè·ä½ï¼ˆå¹«çœ¾ï¼å­¸å¾’æ¨™ç±¤ï¼‰
  document.querySelectorAll(".guild-box .position-tag").forEach(tag => {
    const tagName = (tag.dataset.name || "").trim();
    if (tagName === oldName) {
      // æ›´æ–°åå­—
      tag.dataset.name = newName;
      const span = tag.querySelector("span");
      if (span) span.textContent = newName;
      // æ›´æ–°è·æ¥­èˆ‡é¡è‰²
      const job = newMember.job || getJobByName(newName) || "";
      tag.dataset.job = job;
      if (job && roleColors[job]) {
        const dark = darkenHex(roleColors[job], 0.25);
        tag.style.borderLeft = "4px solid " + dark;
        tag.style.color = dark;
      } else {
        tag.style.borderLeft = "1px solid #cbd5e1";
        tag.style.color = "#0f172a";
      }
    }
  });
  // â˜… æ”¹å®Œè·æ¥­å¾Œï¼Œå¹«çœ¾ï¼å­¸å¾’å„è‡ªé‡æ–°æ’åºä¸€æ¬¡
  sortGuildBoxByJob(guildBattleBox);
  sortGuildBoxByJob(guildPendingBox);
  // åŒæ­¥å­˜æª”
  saveState();
}


    /*V14.8ä¿®æ”¹*/
    function saveInlineEdit(id){
  const name  = document.getElementById("edit-name-"+id).value.trim();
  const job   = document.getElementById("edit-job-"+id).value.trim();
  const skill = document.getElementById("edit-skill-"+id).value.trim();
  const idx   = allMembers.findIndex(x=>x.id===id);
  if (idx > -1) {
    const oldMember = { ...allMembers[idx] };           // â† èˆŠè³‡æ–™å…ˆç•™è‘—
    const newMember = { id, name, job, skill };
    allMembers[idx] = newMember;                        // æ›´æ–° master
    renderMemberList();                                 // é‡ç•«å·¦å´æ¸…å–®
    syncEditedMemberEverywhere(oldMember, newMember);   // âœ… åŒæ­¥åˆ°æœ¬é€±ï¼‹æ›¿è£œ
    updateGuildBattleAndWeekComparison();   // â˜… ç·¨è¼¯å®Œï¼Œé‡æ¯”å°
  }
}

    
// V16æ›´æ–° åˆªé™¤ã€Œå…¨éƒ¨æˆå“¡ã€ä¸­çš„æŸå€‹æˆå“¡ï¼Œå…¨éƒ¨æ›´å‹•
function deleteMember(id) {
  const m = allMembers.find(x => x.id === id);
  if (!m) return;
  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${m.name}ã€å—ï¼Ÿ`)) return;
  const name = m.name;
  // 1) å¾ allMembers ä¸­ç§»é™¤
  allMembers = allMembers.filter(x => x.id !== id);
  // 2) æŠŠæœ¬é€±åå–®èˆ‡æ›¿è£œåå–®è£¡åŒåæˆå“¡æ¸…ç©º
  const nameInputs = document.querySelectorAll(
    '#thisWeek input[data-role="name"], #subsList .sub-name'
  );
  nameInputs.forEach(input => {
    if ((input.value || "").trim() === name) {
      // æ¸…åç¨±
      input.value = "";
      // æ‰¾åˆ°å°æ‡‰æŠ€èƒ½æ¬„ä¸€èµ·æ¸…ç©º
      const row = input.closest(".member-row") || input.closest(".substitute-row");
      if (row) {
        const skillInput = row.querySelector('input[data-role="skill"]') ||
                           row.querySelector(".sub-skill");
        if (skillInput) skillInput.value = "";
      }
    }
  });
  // 3) å¾å¹«æœƒè·ä½æ¬„ä½ç§»é™¤è©²æˆå“¡æ¨™ç±¤
  const guildTags = document.querySelectorAll(".guild-box .position-tag");
  guildTags.forEach(tag => {
    if ((tag.dataset.name || "").trim() === name) {
      tag.remove();
    }
  });
  // é‡æ–°è£œå¹«çœ¾ç©ºä½
  maintainGuildBattlePlaceholders();
  // 4) é‡ç•«å·¦å´å…¨éƒ¨æˆå“¡åˆ—è¡¨ & æ›¿è£œåˆ†é 
  renderMemberList();
  updateSubsPager();
  // 5) é‡è·‘å¹«çœ¾ vs æœ¬é€±åå–®æ¯”å°
  updateGuildBattleAndWeekComparison();
  // 6) å­˜æª”
  saveState();
}

// V17â˜… çµ±ä¸€å¹«ã€Œå­¸å¾’æ¨™ç±¤ã€åŠ ä¸Šåœ“å½¢ç‹€æ…‹åœ–ç¤º
// â˜… åœ¨å­¸å¾’æ¨™ç±¤ä¸ŠåŠ ä¸Šå°æ‡‰ç‹€æ…‹çš„åœ“å½¢åœ–ç¤º
function applyWeekStatusIconToTag(tag, status) {
  if (!tag) return;
  // å…ˆæ¸…æ‰èˆŠçš„åœ–ç¤º
  const old = tag.querySelector(".tag-status-icon");
  if (old) old.remove();
  // æ²’æœ‰ç‹€æ…‹ æˆ– æ˜¯ presentï¼Œå°±ä¸ç”¨åŠ åœ–ç¤º
  if (!status || status === "present") return;
  const span = document.createElement("span");
  span.className = "tag-status-icon";
  if (status === "absent") {
    span.textContent = "ï¼";
  } else if (status === "unsure") {
    span.textContent = "ï¼Ÿ";
  }
  // æ’åˆ°æ¨™ç±¤çš„æœ€å¾Œï¼ˆæˆ–ä½ æœ‰ remove æŒ‰éˆ•å¯ä»¥æ’åœ¨å‰é¢ï¼‰
  tag.appendChild(span);
}



    function showDragPreview(text, color){
      dragPreviewEl = document.createElement("div");
      dragPreviewEl.className = "drag-preview";
      dragPreviewEl.textContent = text;
      dragPreviewEl.style.background = color || "#0f172a";
      document.body.appendChild(dragPreviewEl);
      document.addEventListener("dragover", movePreview);
    }
    function movePreview(e){ if(dragPreviewEl){ dragPreviewEl.style.left = e.pageX + 10 + "px"; dragPreviewEl.style.top = e.pageY + 10 + "px"; } }
    function hideDragPreview(){
      if(dragPreviewEl){
        document.body.removeChild(dragPreviewEl);
        dragPreviewEl = null;
        document.removeEventListener("dragover", movePreview);
      }
    }

    function dragFromMemberList(e, m){
      e.dataTransfer.setData("text/plain", JSON.stringify(m));
      const color = m.job && roleColors[m.job] ? darkenHex(roleColors[m.job],0.25) : "#0f172a";
      showDragPreview(`${m.name} (${m.job||""})`, color);
      blockNextClick = true;  // v15æ–°å¢ âœ… æ–¹æ¡ˆ Aï¼šé€™æ¬¡æ‹–æ›³çµæŸå¾Œè‹¥ç€è¦½å™¨è£œæ‰“ä¸€å€‹ clickï¼Œå°±æŠŠé‚£æ¬¡ click æ“‹æ‰
    }
    
    function dragFromSub(e){
      const row = e.currentTarget;
      const name = row.querySelector(".sub-name").value.trim();
      const skill = row.querySelector(".sub-skill").value.trim();
      if(!name){ e.preventDefault(); return; }
      const job = getJobByName(name) || row.querySelector(".sub-name").dataset.job || "";
      e.dataTransfer.setData("text/plain", JSON.stringify({name, skill, job, fromSub: row.dataset.subIndex}));
      const color = job && roleColors[job] ? darkenHex(roleColors[job],0.25) : "#0f172a";
      showDragPreview(`${name} (${job||""})`, color);
      blockNextClick = true;  // v15æ–°å¢ âœ… æ‹–å®Œé€™æ ¼ä¹‹å¾Œï¼Œä¸‹ä¸€å€‹ click ä¸è¦è§¸ç™¼ input çš„ onclick
    }


function dragFromPanel(e) {
  closeMemberPicker(); // â˜…é–‹å§‹æ‹–æ›³æ™‚å…ˆé—œæ‰æœå°‹æ¡†
  const input = e.target;
  // â˜… è¨˜éŒ„æ‹–æ›³ä¾†æºæ˜¯å“ªä¸€å€‹å€å¡Š
  dragSourceSide = input.dataset.side || "";
  // ç¾åœ¨åªæœ‰æœ¬é€±é¢æ¿ï¼Œç›´æ¥å– sideï¼ˆå¯¦éš›åªæœƒæ˜¯ "this"ï¼‰
  const side = input.dataset.side;
  const name = input.value.trim();
  // åŒåˆ—ä¸‹ä¸€è¡Œæ˜¯æŠ€èƒ½åˆ—ï¼ŒæŠŠæŠ€èƒ½ä¸€èµ·å¸¶å‡ºå»
  let skill = "";
  const skillRow = input.parentElement.nextElementSibling;
  if (skillRow) {
    const skillInput = skillRow.querySelector('input[data-role="skill"]');
    if (skillInput) {
      skill = skillInput.value;
    }
  }
  // v15 æ–°å¢ï¼šæ‹–æ‹‰å¾Œæ“‹æ‰ä¸‹ä¸€æ¬¡ clickï¼Œé¿å… iOS èª¤é»æ”¾å¤§
  blockNextClick = true;
  const job = input.dataset.job || getJobByName(name) || "";
  draggingPanelInput = input;
  draggingPanelSide = side;
  dragSuccess = false;

  e.dataTransfer.setData(
    "text/plain",
    JSON.stringify({ name, skill, job, fromPanel: true, side })
  );
  const color =
    job && roleColors[job] ? darkenHex(roleColors[job], 0.25) : "#0f172a";
  showDragPreview(
    `${name || "ç©ºæ¬„ä½"} ${job ? "(" + job + ")" : ""}`,
    color
  );
}

/*V16æ–°å¢æ¯”å°åµæ¸¬*/
    document.addEventListener("dragend", function(){
  hideDragPreview();
  if (draggingPanelInput && !dragSuccess) {
    clearInputAndSkill(draggingPanelInput);
    saveState();
    // â˜… è‹¥æ˜¯æœ¬é€±åå–®æ¬„ä½ â†’ é‡æ–°æ¯”å°
    if (draggingPanelInput.dataset.side === "this" &&
        draggingPanelInput.dataset.role === "name") {
      updateGuildBattleAndWeekComparison();
    }
  }
  draggingPanelInput = null;
  draggingPanelSide = null;
});


    
    /*ä¸‹æ–¹v15æ“‹æ‰é»æ“Šé¿å…zoom in*/
    // âœ… æ–¹æ¡ˆ Aï¼šé˜»æ­¢ã€Œé»æ“Šã€ï¼Œä¸é˜»æ­¢æ‹–æ›³
    // æ‹–æ›³é–‹å§‹æ™‚æŠŠé€™å€‹ flag æ‰“é–‹ï¼Œä¸‹ä¸€æ¬¡ click å…ˆè¢«æˆ‘å€‘æ””æˆªæ‰ï¼Œæ‰ä¸æœƒèª¤è§¸æœå°‹æ¡† / èšç„¦
    let blockNextClick = false;
document.addEventListener(
  "click",
  function (e) {
    if (!blockNextClick) return;
    const t = e.target;
    // ç”¨æ‰é€™æ¬¡æ©Ÿæœƒï¼Œä¸‹ä¸€æ¬¡ click æ¢å¾©æ­£å¸¸
    blockNextClick = false;
    // åªè™•ç†ã€Œæœ¬é€±åå–® / æ›¿è£œã€çš„åå­—æ¬„ä½
    if (
      t.matches('#thisWeek input[data-role="name"]') ||
      t.matches('#subsList .sub-name')
    ) {
      const val = (t.value || "").trim();
      // âœ… åªæœ‰ã€Œå·²ç¶“æœ‰åå­—ã€çš„æ¬„ä½æ‰æ“‹æ‰é€™æ¬¡ click
      if (val) {
        e.preventDefault();
        e.stopPropagation();
      }
      // âœ… å¦‚æœæ˜¯ç©ºæ¬„ä½ï¼Œå°±è®“é€™æ¬¡ click æ­£å¸¸é€šé
      //ï¼ˆé€™æ¨£ç©ºæ ¼é»ä¸€ä¸‹å°±èƒ½æ‰“å­—æˆ–é–‹æµ®å±¤ï¼‰
    }
  },
  true
);
/*ä¸Šæ–¹v15æ“‹æ‰é»æ“Šé¿å…zoom in*/
    
    function allowDrop(ev){ ev.preventDefault(); }

    function getJobByName(name){
      const m = allMembers.find(x=>x.name===name);
      return m ? m.job : "";
    }
    function applyJobColor(input, job){
      if(!input) return;
      if(job && roleColors[job]){
        const dark = darkenHex(roleColors[job],0.25);
        input.style.borderLeft = "6px solid " + dark;
        input.style.color = dark;
        input.style.fontWeight = "700";
        input.dataset.job = job;
      } else {
        input.style.borderLeft = "";
        input.style.color = "";
        input.dataset.job = "";
        input.style.fontWeight = "700";
      }
    }
    function applyColorByName(input){
      const name = input.value.trim();
      const job = getJobByName(name);
      applyJobColor(input, job);
    }

    function setSkillInputValue(input, val) {
      if (!input) return;
      input.value = val || "";
      if (val && val.trim() !== "") input.classList.add("skill-has");
      else input.classList.remove("skill-has");
    }

    function clearDuplicateInPanel(panelEl, name, exceptInput){
      panelEl.querySelectorAll("input[data-role='name']").forEach(inp=>{
        if(inp !== exceptInput && inp.value.trim() === name){
          clearInputAndSkill(inp);
        }
      });
    }

    function collectDirtyMarks() {
      const marks = [];
      thisWeekPanel.querySelectorAll("[data-dirty='1']").forEach(el => {
        const teamBlock = el.closest(".team-block");
        if (teamBlock) {
          const team = teamBlock.dataset.team;
          if (el.classList.contains("team-tag-select")) {
            marks.push({type:"team-tag", team});
          } else {
            const squadEl = el.closest(".squad");
            if (squadEl) {
              const squadIdx = Array.from(squadEl.parentElement.children).indexOf(squadEl);
              const nameInputs = squadEl.querySelectorAll("input[data-role='name']");
              const memberIdx = Array.from(nameInputs).indexOf(el);
              if (memberIdx !== -1) marks.push({type:"member", team, squad: squadIdx, member: memberIdx});
            }
          }
        }
      });
      thisWeekPanel.querySelectorAll(".team-block").forEach(block => {
        const team = block.dataset.team;
        const squads = block.querySelectorAll(".squad");
        squads.forEach((sqEl, idx) => {
          if (sqEl.dataset.newlyAdded === "1") {
            marks.push({ type: "squadNew", team, squad: idx });
            delete sqEl.dataset.newlyAdded;
          }
        });
        block.dataset.lastSquadCount = String(squads.length);
      });
      subsList.querySelectorAll("[data-dirty='1']").forEach(el => {
        const row = el.closest(".substitute-row");
        if (row) {
          const idx = Array.from(subsList.children).indexOf(row);
          marks.push({type:"sub", index: idx});
        }
      });
      return marks;
    }

// æ”¶é›†ã€Œæœ€è¿‘æ¨™è¨˜ã€è³‡æ–™ï¼šæ²¿ç”¨èˆŠç‰ˆçµæ§‹ { user, marks }
function collectRecentMarks() {
  const marks = collectDirtyMarks();
  return {
    user: currentUser || "unknown",
    marks
  };
}

    function renderRecentMarks(recentMarks) {
  clearAllOutlines();
  // ç·¨è¼¯æœŸé–“å…ˆä¸é¡¯ç¤ºæ¡†ç·šï¼Œç­‰ä¸‹ä¸€æ¬¡å„²å­˜æ‰ç•«
  if (outlinesSuppressed) return;
  if (!recentMarks || !recentMarks.user || !recentMarks.marks) return;
  const cls = OUTLINE_CLASS[recentMarks.user] || "outline-dabai";
  recentMarks.marks.forEach(m => {
    if (m.type === "member") {
      const block = thisWeekPanel.querySelector(`.team-block[data-team="${m.team}"]`);
      if (!block) return;
      const sq = block.querySelectorAll(".squads .squad")[m.squad];
      if (!sq) return;
      const inp = sq.querySelectorAll("input[data-role='name']")[m.member];
      if (inp) inp.classList.add(cls);
    } else if (m.type === "team-tag") {
      const block = thisWeekPanel.querySelector(`.team-block[data-team="${m.team}"]`);
      const sel = block && block.querySelector(".team-tag-select");
      if (sel) sel.classList.add(cls);
    } else if (m.type === "sub") {
      const row = subsList.children[m.index];
      if (row) row.classList.add(cls);
    } else if (m.type === "squadNew") {
      const block = thisWeekPanel.querySelector(`.team-block[data-team="${m.team}"]`);
      const newsq = block && block.querySelectorAll(".squad")[m.squad];
      if (newsq) {
        const title = newsq.querySelector(".squad-title");
        if (title) title.classList.add(cls);
      }
    }
  });
}


    function clearAllOutlines(){
      document.querySelectorAll(".outline-dabai, .outline-baoan, .outline-stitch").forEach(el=>{
        el.classList.remove("outline-dabai","outline-baoan","outline-stitch");
      });
    }

  function dropMember(ev) {
  ev.preventDefault();
  dragSuccess = true;

  const data = ev.dataTransfer.getData("text/plain");
  if (!data) return;
  const member = JSON.parse(data);
  const target = ev.target;

  // V16â˜… å…ˆåˆ¤æ–·æ˜¯ä¸æ˜¯ä¸Ÿåˆ°å¹«æœƒè·ä½å¤§æ¡†
    const guildBox = ev.target.closest(".guild-box");
  if (guildBox) {
    // â˜… å­¸å¾’æ¬„ä½ä¸æ¥å—æ‹–æ›³
    if (guildBox === guildPendingBox) {
      // æƒ³è¦æœ‰æç¤ºå°±é–‹å•Ÿä¸‹é¢é€™è¡Œ
      // alert("å­¸å¾’æ¬„ä½ç›®å‰ä¸é–‹æ”¾æ‹–æ›³è¨­å®š");
      return;
    }
    addGuildTag(guildBox, {
      name: member.name,
      job: member.job || getJobByName(member.name) || ""
    });
    saveState();
    updateGuildBattleAndWeekComparison();   // â˜… ç·¨è¼¯å®Œï¼Œé‡æ¯”å°
    return;
  }

    // â‘¡ æ›¿è£œå€ï¼šsub-name
  if (target.classList.contains("sub-name")) {
    const subRow = target.parentElement;
    const subSkillInput = subRow.querySelector(".sub-skill");

    const prevName  = target.value.trim();
    const prevSkill = subSkillInput ? subSkillInput.value.trim() : "";

    // é¢æ¿ â†’ æ›¿è£œï¼ˆäº’æ›ï¼‰
    if (member.fromPanel && draggingPanelInput) {
      const oldName  = prevName;
      const oldSkill = prevSkill;
      const oldJob   = getJobByName(oldName) || target.dataset.job || "";

      // æŠŠæ‹–ä¾†çš„æ”¾åˆ°æ›¿è£œ
      target.value = member.name;
      applyJobColor(target, member.job);
      if (subSkillInput) {
        subSkillInput.value = member.skill || "";
      }
      markDirty(target);
      fitNameFont(target);

      // åŸæœ¬æ›¿è£œä¸Šçš„äººï¼ˆå¦‚æœæœ‰ï¼‰æ›å›åˆ°åŸ panel æ ¼å­
      draggingPanelInput.value = oldName;
      applyJobColor(draggingPanelInput, oldJob);
      const panelSkillRow = draggingPanelInput.parentElement.nextElementSibling;
      if (panelSkillRow) {
        const panelSkillInput = panelSkillRow.querySelector("input[data-role='skill']");
        if (panelSkillInput) {
          setSkillInputValue(panelSkillInput, oldSkill || "");
        }
      }
      markDirty(draggingPanelInput);

      // æ¸…æ‰æœ¬é€±é¢æ¿ä¸­çš„é‡è¤‡åå­—ï¼ˆä¿ç•™å‰›å‰›äº’æ›çš„é‚£ä¸€æ ¼ï¼‰
      clearDuplicateInPanel(thisWeekPanel, oldName, draggingPanelInput);
      saveState();
      updateGuildBattleAndWeekComparison();   // â˜… ç·¨è¼¯å®Œï¼Œé‡æ¯”å°
      return;
    }

    // å…¶ä»–ä¾†æº â†’ æ›¿è£œï¼ˆè¦†è“‹ï¼‰
    target.value = member.name;
    applyJobColor(target, member.job);
    if (subSkillInput) {
      subSkillInput.value = member.skill ? member.skill : "";
    }
    markDirty(target);

    // è‹¥åŸæœ¬è©²æ›¿è£œæ ¼æœ‰åå­—ï¼Œå¾æœ¬é€±åå–®ä¸­æ¸…æ‰èˆŠåå­—
    if (prevName) {
      clearDuplicateInPanel(thisWeekPanel, prevName, null);
    }
    saveState();
    updateGuildBattleAndWeekComparison();   // â˜… ç·¨è¼¯å®Œï¼Œé‡æ¯”å°
    return;
  }

  // â‘¢ é¢æ¿æ ¼ï¼šæœ¬é€±åå–®ï¼ˆname æ¬„ä½ï¼‰
  if (target.dataset && target.dataset.role === "name") {
    const targetSide = target.dataset.side;   // ç¾åœ¨å¯¦éš›åªæœƒæ˜¯ "this"

    // åŒé¢æ¿äº’æ›ï¼ˆæœ¬é€±å…§éƒ¨äº’æ›ï¼‰
    if (member.fromPanel && member.side === targetSide && draggingPanelInput) {
      const src = draggingPanelInput;
      if (src === target) return;

      const srcName = src.value.trim();
      const srcJob  = src.dataset.job || getJobByName(srcName) || "";
      let srcSkill  = "";
      const srcSkillRow = src.parentElement.nextElementSibling;
      if (srcSkillRow) {
        const srcSkillInput = srcSkillRow.querySelector("input[data-role='skill']");
        if (srcSkillInput) {
          srcSkill = srcSkillInput.value;
        }
      }

      const tgtName = target.value.trim();
      const tgtJob  = target.dataset.job || getJobByName(tgtName) || "";
      let tgtSkill  = "";
      const tgtSkillRow = target.parentElement.nextElementSibling;
      if (tgtSkillRow) {
        const tgtSkillInput = tgtSkillRow.querySelector("input[data-role='skill']");
        if (tgtSkillInput) {
          tgtSkill = tgtSkillInput.value;
        }
      }

      // äº’æ›åå­— & é¡è‰²
      src.value = tgtName;
      applyJobColor(src, tgtJob);
      target.value = srcName;
      applyJobColor(target, srcJob);

      // äº’æ›æŠ€èƒ½
      if (srcSkillRow) {
        const srcSkillInput = srcSkillRow.querySelector("input[data-role='skill']");
        if (srcSkillInput) {
          setSkillInputValue(srcSkillInput, tgtSkill || "");
        }
      }
      if (tgtSkillRow) {
        const tgtSkillInput = tgtSkillRow.querySelector("input[data-role='skill']");
        if (tgtSkillInput) {
          setSkillInputValue(tgtSkillInput, srcSkill || "");
        }
      }

      // æ¸…æ‰æ¯”å°ç”¨æ¨™ç¤º
      src.classList.remove("highlight-new", "highlight-missing");
      target.classList.remove("highlight-new", "highlight-missing");

      markDirty(src);
      markDirty(target);
      saveState();
      updateGuildBattleAndWeekComparison();   // â˜… ç·¨è¼¯å®Œï¼Œé‡æ¯”å°
      return;
    }

    // æ›¿è£œ â†’ é¢æ¿ä¸”ç›®æ¨™æ ¼åŸæœ¬æœ‰å€¼ï¼šæŠŠèˆŠå€¼æ”¾å›æ›¿è£œ
    if (member.fromSub !== undefined && target.value.trim() !== "") {
      const oldName = target.value.trim();
      const oldJob  = target.dataset.job || getJobByName(oldName) || "";
      let oldSkill  = "";
      const skillRow = target.parentElement.nextElementSibling;
      if (skillRow) {
        const skillInput = skillRow.querySelector("input[data-role='skill']");
        if (skillInput) {
          oldSkill = skillInput.value;
        }
      }

      const subRow = subsList.querySelector(`[data-sub-index="${member.fromSub}"]`);
      if (subRow) {
        const subNameInput  = subRow.querySelector(".sub-name");
        const subSkillInput = subRow.querySelector(".sub-skill");
        if (subNameInput) {
          subNameInput.value = oldName;
          applyJobColor(subNameInput, oldJob);
          markDirty(subNameInput);
        }
        if (subSkillInput) {
          subSkillInput.value = oldSkill;
        }
      }
    }

    // çœŸæ­£æ”¾é€²é¢æ¿
    target.value = member.name;
    applyJobColor(target, member.job);

    const srow = target.parentElement.nextElementSibling;
    if (srow) {
      const skillInput = srow.querySelector("input[data-role='skill']");
      if (skillInput) {
        setSkillInputValue(skillInput, member.skill ? member.skill : "");
      }
    }

    // æ¸…æ‰æœ¬é€±é¢æ¿è£¡é‡è¤‡çš„åå­—ï¼ˆä¿ç•™é€™å€‹ targetï¼‰
    clearDuplicateInPanel(thisWeekPanel, member.name, target);

    // æ¸…æ‰æ¯”å°æ¨™ç¤º
    target.classList.remove("highlight-new", "highlight-missing");

    markDirty(target);
    saveState();
    updateGuildBattleAndWeekComparison();   // â˜… ç·¨è¼¯å®Œï¼Œé‡æ¯”å°
  }
}

    function getPanelData(panelEl){
      const data = [];
      panelEl.querySelectorAll(".team-block").forEach(block=>{
        const team = block.dataset.team;
        const tagSelect = block.querySelector(".team-tag-select");
        const label = block.querySelector(".team-tag-label");
        const groupTag = tagSelect ? tagSelect.value : (label ? label.textContent.trim() : "ä¸€åœ˜");
        const squads = [];
        block.querySelectorAll(".squads .squad").forEach(sq=>{
          const members = [];
          sq.querySelectorAll("input[data-role='name']").forEach(nameInput=>{
            const skillRow = nameInput.parentElement.nextElementSibling;
            const skillInput = skillRow ? skillRow.querySelector("input[data-role='skill']") : null;
            members.push({
              name: nameInput.value.trim(),
              job: nameInput.dataset.job || "",
              skill: skillInput ? (skillInput.value.trim() || "") : "",
              status: nameInput.dataset.status || ""   // â˜… æ–°å¢
            });
          });
          squads.push({members});
        });
        data.push({team, tag: groupTag, squads});
      });
      return data;
    }

function setPanelData(panelEl, data, side) {
  if (!panelEl || !data) return;
  data.forEach(teamData => {
    const block = panelEl.querySelector(`.team-block[data-team="${teamData.team}"]`);
    if (!block) return;
    // åœ˜åˆ¥ä¸‹æ‹‰é¸å–®ï¼ˆé€²æ”» / æ‹†å¡” / é˜²å®ˆ ...ï¼‰
    const tagSelect = block.querySelector(".team-tag-select");
    if (tagSelect && teamData.tag) {
      tagSelect.value = teamData.tag;
    }
    const squadsContainer = block.querySelector(".squads");
    const neededCount = teamData.squads.length;
    let currentCount = squadsContainer.children.length;
    // å°éšŠæ•¸é‡ä¸è¶³å°±è£œ
    while (currentCount < neededCount) {
      squadsContainer.appendChild(
        createSquad(currentCount + 1, side, teamData.team)
      );
      currentCount++;
    }
    // å°éšŠå¤ªå¤šå°±ç æ‰å°¾å·´
    while (squadsContainer.children.length > neededCount) {
      squadsContainer.removeChild(squadsContainer.lastElementChild);
    }
    // å¥—å…¥æ¯ä¸€éšŠã€æ¯ä¸€æ ¼æˆå“¡è³‡æ–™
    teamData.squads.forEach((sqData, idx) => {
      const sqEl = squadsContainer.children[idx];   // â˜… ä¸€å®šè¦åœ¨é€™è£¡å®£å‘Š sqEl
      if (!sqEl) return;
      const nameInputs = sqEl.querySelectorAll('input[data-role="name"]');
      nameInputs.forEach((inp, mIdx) => {
        const member = sqData.members[mIdx];
        if (member && (member.name || "").trim() !== "") {
          // åå­—
          inp.value = member.name || "";

          // è·æ¥­é¡è‰²
          const job = member.job || getJobByName(member.name) || "";
          if (job) {
            applyJobColor(inp, job);
          } else {
            applyColorByName(inp);
          }
          // æŠ€èƒ½æ¬„
          const skillRow = inp.parentElement.nextElementSibling;
          if (skillRow) {
            const skillInput = skillRow.querySelector('input[data-role="skill"]');
            if (skillInput) {
              setSkillInputValue(skillInput, member.skill ? member.skill : "");
            }
          }
          // â˜… V17ï¼šé‚„åŸå‡ºå¸­ç‹€æ…‹
          // èˆŠè³‡æ–™æ²’æœ‰ status çš„è©±ï¼Œé è¨­è¦–ç‚ºã€Œæœªä¸Šç·šã€æˆ–ã€Œå·²å‡ºå¸­ã€éƒ½å¯ä»¥ï¼Œä½ è‡ªå·±é¸ï¼š
          const st = member.status || "absent";   // æ”¹æˆ "present" = èˆŠè³‡æ–™è¦–ç‚ºæœ‰å‡ºå¸­
          setCellStatus(inp, st);
        } else {
          // è©²æ ¼æ²’äºº â†’ æ¸…ç©ºåå­—èˆ‡æŠ€èƒ½ + æ¸…æ‰ç‹€æ…‹
          clearInputAndSkill(inp);
          resetCellStatus(inp);   // ç©ºæ ¼ï¼å®Œå…¨ç„¡ç‹€æ…‹
        }
      });
    });
    // é‡æ–°ç·¨è™Ÿå°éšŠï¼‹èª¿æ•´å¯¬åº¦
    renumberSquads(block);
    block.dataset.lastSquadCount = String(neededCount || 3);
    adjustSquadWidths(block);
  });
}


//V16æ–°å¢
// åªè¨˜éŒ„ã€Œå¹«çœ¾æ¬„ã€çš„ç‹€æ…‹ï¼Œå­¸å¾’æ¬„ä¸å…¥åº«
function getGuildPositionsData() {
  const battle = [];
  if (guildBattleBox) {
    guildBattleBox.querySelectorAll(".position-tag").forEach(tag => {
      const name = (tag.dataset.name || "").trim();
      if (!name) return;
      const job = tag.dataset.job || getJobByName(name) || "";
      battle.push({ name, job });
    });
  }
  return { battle };   // â˜… æ²’æœ‰ pending äº†
}




    function getSubsData(){
      const arr = [];
      subsList.querySelectorAll(".substitute-row").forEach(row=>{
        arr.push({ name: row.querySelector(".sub-name").value.trim(), skill: row.querySelector(".sub-skill").value.trim() });
      });
      return arr;
    }

    function saveState() {
    const state = {
    allMembers,
    thisWeek: getPanelData(thisWeekPanel),
    subs: getSubsData(),
    guildPositions: getGuildPositionsData()
  };
    try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {}
}



    function fetchWithTimeout(url, ms=3000){
      const ctrl = new AbortController();
      const id = setTimeout(()=>ctrl.abort(), ms);
      return fetch(url, {signal: ctrl.signal}).finally(()=>clearTimeout(id));
    }

    /* æœ¬é€±æ‰€æœ‰åå­— Setï¼ˆå«ç©ºç™½æ¿¾é™¤ï¼‰ */
    function getThisWeekNameSet(){
      const set = new Set();
      thisWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp=>{
        const v = inp.value.trim(); if(v) set.add(v);
      });
      return set;
    }

    function applyStateToPage(state, fromLocal){
      if (state.allMembers && Array.isArray(state.allMembers)) {
        allMembers = state.allMembers;
        const maxId = allMembers.reduce((m,c)=>Math.max(m,c.id||0),12);
        nextMemberId = maxId + 1;
      }
      renderMemberList();

      if (state.thisWeek) {
  setPanelData(thisWeekPanel, state.thisWeek, "this");
  thisWeekPanel.querySelectorAll(".team-block").forEach(adjustSquadWidths);
}

// V17.4æª¢æŸ¥å–®ä¸€ input æ˜¯å¦éœ€è¦è·‘é¦¬ç‡ˆ
function updateMarqueeForInput(input) {
  // å…ˆæš«æ™‚æ¸…æ‰ï¼Œé¿å…èˆŠçš„ text-indent å½±éŸ¿æ¸¬é‡
  input.classList.remove("marquee");
  // ä½¿ç”¨ scrollWidth vs clientWidth åˆ¤æ–·æ˜¯å¦æœ‰æº¢å‡º
  const need = input.scrollWidth > input.clientWidth + 1;
  if (need) {
    input.classList.add("marquee");
  }
}
// æª¢æŸ¥æœ¬é€±åå–®æ‰€æœ‰æ¬„ä½
function updateAllThisWeekMarquee() {
  document.querySelectorAll("#thisWeek .member-row input").forEach(updateMarqueeForInput);
}
// ä¸€é–‹å§‹è¼‰å…¥é é¢æ™‚æª¢æŸ¥ä¸€æ¬¡
window.addEventListener("load", updateAllThisWeekMarquee);
// è¦–çª—å¤§å°æ”¹è®Šæ™‚ä¹Ÿæª¢æŸ¥ä¸€æ¬¡
window.addEventListener("resize", updateAllThisWeekMarquee);
// ç•¶ä½¿ç”¨è€…è¼¸å…¥å…§å®¹æ™‚ï¼Œç«‹åˆ»æª¢æŸ¥è©²æ¬„ä½
document.addEventListener("input", (e) => {
  if (e.target.matches("#thisWeek .member-row input")) {
    updateMarqueeForInput(e.target);
  }
});



/* V16â˜… é‚„åŸå¹«æœƒè·ä½æ¬„ä½ï¼ˆåªé‚„åŸå¹«çœ¾ï¼‰ */
if (guildBattleBox) {
  guildBattleBox.innerHTML = "";
  guildBattleBox.classList.add("empty");
}
if (guildPendingBox) {
  // å­¸å¾’æ¬„æ¯æ¬¡éƒ½ç”±æ¯”å°é‡æ–°ç”¢ç”Ÿï¼Œä¸åšé‚„åŸ
  guildPendingBox.innerHTML = "";
  guildPendingBox.classList.add("empty");
}
if (state.guildPositions && guildBattleBox) {
  const gp = state.guildPositions;
  const battle = gp.battle || [];
  battle.forEach(m => {
    addGuildTag(
      guildBattleBox,
      { name: m.name, job: m.job },
      { bypassRules: true }   // é‚„åŸè³‡æ–™ï¼Œä¸åš 60 äººä¸Šé™ & å»é‡
    );
  });
  if (guildBattleBox.querySelector(".position-tag")) {
    guildBattleBox.classList.remove("empty");
  }
}// â˜… å­¸å¾’æ¬„ä¸é‚„åŸï¼Œç­‰ loadState() çµå°¾çš„ updateGuildBattleAndWeekComparison() //    ä¾æ“šã€Œå¹«çœ¾ã€ï¼‹ã€Œæœ¬é€±åå–®ã€é‡æ–°ç®—å‡ºå­¸å¾’åå–®


subsList.innerHTML = "";
if (state.subs && state.subs.length) {
  state.subs.forEach(su => createSubRow(su.name, su.skill, false));
}
refreshSubsView();
    }


    /*V16.1ä¿®æ”¹å¯ä»¥æ”¶optionsï¼Œå„²å­˜å¯ä»¥ä¸è·³çª—*/
function requestSave(options = {}){
  const { silent = false, onSuccess = null } = options;
  // æŠŠè¨­å®šæš«å­˜åˆ°å‡½å¼å±¬æ€§ä¸Šï¼Œçµ¦ doSaveToBackend ç”¨
  requestSave._silentOnce = silent;
  requestSave._onSuccess = onSuccess;
  const now = Date.now();
  if (currentUser && (now - lastLoginTime) < LOGIN_TTL) {
    doSaveToBackend();
  } else {
    showLogin();
  }
}


    function showLogin(){
      document.getElementById("loginMsg").textContent = "";
      document.getElementById("loginUser").value = "";
      document.getElementById("loginPass").value = "";
      document.getElementById("loginModal").style.display = "flex";
      document.getElementById("loginUser").focus();
    }
    function closeLogin(){ document.getElementById("loginModal").style.display = "none"; }

    function doLogin(){
      const u = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value.trim();
      fetch(REMOTE_API, {
        method: "POST",
        body: JSON.stringify({ action: "login", user: u, pass: p })
      })
      .then(r => r.json())
      .then(data => {
        if (data && data.success && data.user) {
          currentUser = data.user;
          lastLoginTime = Date.now();
          localStorage.setItem(LOGIN_STORAGE_KEY, JSON.stringify({user: currentUser, time: lastLoginTime}));
          closeLogin();
          doSaveToBackend();
        } else {
          document.getElementById("loginMsg").textContent = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
        }
      })
      .catch(err => {
        console.warn("login error", err);
        document.getElementById("loginMsg").textContent = "ç™»å…¥å¤±æ•—";
      });
    }

function doSaveToBackend() {
  // é€™è£¡çš„ state å°±æ˜¯è¦å­˜åˆ°é›²ç«¯çš„å®Œæ•´ç‹€æ…‹
  const state = {
    allMembers,
    thisWeek: getPanelData(thisWeekPanel),
    subs: getSubsData(),
    guildPositions: getGuildPositionsData(),  // â˜… æŠŠå¹«çœ¾ / å­¸å¾’ä¹Ÿå­˜é€²å»
    recentMarks: collectRecentMarks()  // ä½ æ–°ç‰ˆç”¨çš„æ¨™è¨˜è³‡æ–™
    // å¦‚æœä¹‹å¾Œè¦æŠŠå¹«çœ¾ / å­¸å¾’è·ä½ä¹Ÿå­˜é€²å»ï¼Œå¯ä»¥åœ¨é€™è£¡å†å¤šåŠ æ¬„ä½
    // guildBattle: serializeGuildBattleState() ä¹‹é¡çš„
  };
  // å…ˆå­˜ä¸€ä»½ localStorage å‚™ä»½ï¼ˆå»¶çºŒä½ ç¾åœ¨çš„åšæ³•ï¼‰
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {
    console.error(e);
  }
  // â˜… é‡é» 1ï¼šä¸è¦è‡ªå·±åŠ  Content-Typeï¼Œå¯«æ³•å›åˆ°èˆŠç‰ˆé‚£ç¨®
  fetch(REMOTE_API, {
    method: "POST",
    body: JSON.stringify({
      action: "save",
      payload: state  // â˜… é‡é» 2ï¼šæ¬„ä½åæ”¹å› payloadï¼Œå°æ‡‰ GAS
    })
  })
    .then(res => res.json())
    .then(data => {
      // â˜… é‡é» 3ï¼šæ”¹å›ç”¨ success åˆ¤æ–·
      if (data && data.success) {
        const silent = !!requestSave._silentOnce; //V16.1æ–°å¢
        const cb = requestSave._onSuccess; //V16.1æ–°å¢
        lastKnownUpdatedAt = data.updatedAt || null;
        if (!silent) {alert("å·²å„²å­˜åˆ°å¾Œå°");}
        // å¦‚æœä½ è¦é †ä¾¿æŠŠæœ€è¿‘ä¿®æ”¹æ¡†ç·šç•«å›ä¾†ï¼Œä¹Ÿå¯ä»¥åœ¨é€™è£¡åš
        // renderRecentMarks(state.recentMarks);
        // document.querySelectorAll("[data-dirty='1']").forEach(el => el.removeAttribute("data-dirty"));
        requestSave._silentOnce = false; //V16.1æ–°å¢
        requestSave._onSuccess = null; //V16.1æ–°å¢
        if (typeof cb === "function") cb(); //V16.1æ–°å¢
      } else {
        alert("å¾Œå°æœ‰å›æ‡‰ä½†ä¸æ˜¯ successï¼Œè«‹çœ‹ console");
        console.log(data);
      }
    })
    .catch(err => {
      // é€™è£¡å°±æ²¿ç”¨ä½ ä¸€é–‹å§‹ v15.3 çš„æé†’æ–‡å­—
      alert("ç„¡æ³•é€£åˆ°å¾Œå°ï¼Œè«‹æª¢æŸ¥ Apps Script éƒ¨ç½²æ¬Šé™");
      console.error(err);
    });
}


    function startVersionWatcher(){
      const INTERVAL = 4000;
      setInterval(async ()=>{
        try {
          const res = await fetch(REMOTE_API + "?action=version");
          const data = await res.json();
          if (data && data.success) {
            const serverUpdatedAt = data.updatedAt || null;
            if (!lastKnownUpdatedAt) { lastKnownUpdatedAt = serverUpdatedAt; return; }
            if (serverUpdatedAt && serverUpdatedAt !== lastKnownUpdatedAt) {
              const fullRes = await fetch(REMOTE_API + "?action=get");
              const fullData = await fullRes.json();
              if (fullData && fullData.success && fullData.payload) {
                applyStateToPage(fullData.payload, false);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData.payload));
                lastKnownUpdatedAt = serverUpdatedAt;
              }
            }
          }
        } catch(err){ console.warn("æª¢æŸ¥ç‰ˆæœ¬å¤±æ•—", err); }
      }, INTERVAL);
    }

    function fillRoundRect(ctx, x, y, w, h, r) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
      ctx.fill();
    }
  // åªæé‚Šåœ“è§’çŸ©å½¢ï¼ˆæ­é… fillRoundRect ä½¿ç”¨ï¼‰
function strokeRoundRect(ctx, x, y, w, h, r, color = "#B4BBC8") {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.stroke();
}

    /* V14.6å¯æŒ‡å®šå››å€‹è§’çš„åœ“è§’ path */
function roundRectPath(ctx, x, y, w, h, r, corners = {tl:true,tr:true,br:true,bl:true}) {
  const tl = corners.tl ? r : 0, tr = corners.tr ? r : 0, br = corners.br ? r : 0, bl = corners.bl ? r : 0;
  ctx.beginPath();
  ctx.moveTo(x + tl, y);
  ctx.lineTo(x + w - tr, y);
  if (tr) ctx.quadraticCurveTo(x + w, y, x + w, y + tr); else ctx.lineTo(x + w, y);
  ctx.lineTo(x + w, y + h - br);
  if (br) ctx.quadraticCurveTo(x + w, y + h, x + w - br, y + h); else ctx.lineTo(x + w, y + h);
  ctx.lineTo(x + bl, y + h);
  if (bl) ctx.quadraticCurveTo(x, y + h, x, y + h - bl); else ctx.lineTo(x, y + h);
  ctx.lineTo(x, y + tl);
  if (tl) ctx.quadraticCurveTo(x, y, x + tl, y); else ctx.lineTo(x, y);
  ctx.closePath();
}
function fillRoundRectCorners(ctx, x, y, w, h, r, corners) {
  roundRectPath(ctx, x, y, w, h, r, corners);
  ctx.fill();
}


    
/* 1px è¦–è¦ºç­‰å¯¬ï¼šåœ“è§’çŸ©å½¢æé‚Šï¼ˆåƒç´ å°é½Šï¼‰ */
function strokeRoundedCrisp(ctx, x, y, w, h, r, corners = {tl:true,tr:true,br:true,bl:true}, color = "#B4BBC8") {
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;           // å›ºå®šè¦–è¦º 1px
  ctx.lineJoin = "round";
  ctx.lineCap  = "round";
  // è®“æ•´å€‹å¤–æ¡†å¾€å³ä¸‹å„å°é½ŠåŠåƒç´ ï¼Œé¿å…æ›²ç·šè¢«æŠ—é‹¸é½’åƒå¯¬
  // åŒæ™‚ç¸®å° w/h 1pxï¼Œç¢ºä¿ç·šå¿ƒéƒ½è½åœ¨åƒç´ é‚Šç•Œ
  const tl = corners.tl ? r : 0, tr = corners.tr ? r : 0, br = corners.br ? r : 0, bl = corners.bl ? r : 0;
  const _x = x + 0.5, _y = y + 0.5, _w = Math.max(0, w - 1), _h = Math.max(0, h - 1);
  const _r = Math.max(0, r - 0.5);
  ctx.beginPath();
  ctx.moveTo(_x + (corners.tl ? _r : 0), _y);
  ctx.lineTo(_x + _w - (corners.tr ? _r : 0), _y);
  if (tr) ctx.arcTo(_x + _w, _y, _x + _w, _y + (tr ? _r : 0), _r); else ctx.lineTo(_x + _w, _y);
  ctx.lineTo(_x + _w, _y + _h - (corners.br ? _r : 0));
  if (br) ctx.arcTo(_x + _w, _y + _h, _x + _w - (br ? _r : 0), _y + _h, _r); else ctx.lineTo(_x + _w, _y + _h);
  ctx.lineTo(_x + (corners.bl ? _r : 0), _y + _h);
  if (bl) ctx.arcTo(_x, _y + _h, _x, _y + (bl ? _r : 0), _r); else ctx.lineTo(_x, _y + _h);
  ctx.lineTo(_x, _y + (corners.tl ? _r : 0));
  if (tl) ctx.arcTo(_x, _y, _x + (tl ? _r : 0), _y, _r); else ctx.lineTo(_x, _y);
  ctx.stroke();
  ctx.restore();
}


    

/* 1px è¦–è¦ºç­‰å¯¬ï¼šåªç•«æŒ‡å®šé‚Šï¼ˆåƒç´ å°é½Šç›´ç·šï¼‰ */
function strokeEdgesCrisp(ctx, x, y, w, h, edges, color = "#B4BBC8") {
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;           // å›ºå®šè¦–è¦º 1px
  ctx.beginPath();
  // ç›´ç·šéƒ½è½åœ¨ 0.5 offsetï¼Œç¢ºä¿éŠ³åˆ©
  if (edges.top)    { ctx.moveTo(x + 0.5, y + 0.5);         ctx.lineTo(x + w - 0.5, y + 0.5); }
  if (edges.right)  { ctx.moveTo(x + w - 0.5, y + 0.5);     ctx.lineTo(x + w - 0.5, y + h - 0.5); }
  if (edges.bottom) { ctx.moveTo(x + 0.5, y + h - 0.5);     ctx.lineTo(x + w - 0.5, y + h - 0.5); }
  if (edges.left)   { ctx.moveTo(x + 0.5, y + 0.5);         ctx.lineTo(x + 0.5, y + h - 0.5); }
  ctx.stroke();
  ctx.restore();
}

    
//ä»¥ä¸‹é€™æ®µ V14.7 ä¸‹è¼‰åœ–ç‰‡åŠŸèƒ½ï¼ˆå«åœ“è§’å‹å–„æé‚Š / è¦–è¦ºç­‰ç²—ï¼‰
// ================== 1) å·¥å…·ï¼šåƒç´ å°é½Šæé‚Š ==================
function strokeRoundedCrisp(ctx, x, y, w, h, r, corners = {tl:true,tr:true,br:true,bl:true}, color = "#B4BBC8") {
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.lineJoin = "round";
  ctx.lineCap  = "round";

  const tl = corners.tl ? r : 0, tr = corners.tr ? r : 0, br = corners.br ? r : 0, bl = corners.bl ? r : 0;
  const _x = x + 0.5, _y = y + 0.5, _w = Math.max(0, w - 1), _h = Math.max(0, h - 1);
  const _rtl = Math.max(0, tl - 0.5), _rtr = Math.max(0, tr - 0.5), _rbr = Math.max(0, br - 0.5), _rbl = Math.max(0, bl - 0.5);

  ctx.beginPath();
  // top
  ctx.moveTo(_x + (tl ? _rtl : 0), _y);
  ctx.lineTo(_x + _w - (tr ? _rtr : 0), _y);
  if (tr) ctx.arcTo(_x + _w, _y, _x + _w, _y + _rtr, _rtr); else ctx.lineTo(_x + _w, _y);
  // right
  ctx.lineTo(_x + _w, _y + _h - (br ? _rbr : 0));
  if (br) ctx.arcTo(_x + _w, _y + _h, _x + _w - _rbr, _y + _h, _rbr); else ctx.lineTo(_x + _w, _y + _h);
  // bottom
  ctx.lineTo(_x + (bl ? _rbl : 0), _y + _h);
  if (bl) ctx.arcTo(_x, _y + _h, _x, _y + _h - _rbl, _rbl); else ctx.lineTo(_x, _y + _h);
  // left
  ctx.lineTo(_x, _y + (tl ? _rtl : 0));
  if (tl) ctx.arcTo(_x, _y, _x + _rtl, _y, _rtl); else ctx.lineTo(_x, _y);
  ctx.stroke();
  ctx.restore();
}

function strokeEdgesCrisp(ctx, x, y, w, h, edges, color = "#B4BBC8") {
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1;
  ctx.beginPath();
  if (edges.top)    { ctx.moveTo(x + 0.5, y + 0.5);         ctx.lineTo(x + w - 0.5, y + 0.5); }
  if (edges.right)  { ctx.moveTo(x + w - 0.5, y + 0.5);     ctx.lineTo(x + w - 0.5, y + h - 0.5); }
  if (edges.bottom) { ctx.moveTo(x + 0.5, y + h - 0.5);     ctx.lineTo(x + w - 0.5, y + h - 0.5); }
  if (edges.left)   { ctx.moveTo(x + 0.5, y + 0.5);         ctx.lineTo(x + 0.5, y + h - 0.5); }
  ctx.stroke();
  ctx.restore();
}

// ä½ å·²ç¶“æœ‰çš„å››è§’åœ“å·¥å…·ï¼šroundRectPath / fillRoundRectCorners ï¼ˆæ²¿ç”¨ç¾æˆçš„ï¼‰
function roundRectPath(ctx, x, y, w, h, r, corners = {tl:true,tr:true,br:true,bl:true}) {
  const tl = corners.tl ? r : 0, tr = corners.tr ? r : 0, br = corners.br ? r : 0, bl = corners.bl ? r : 0;
  ctx.beginPath();
  ctx.moveTo(x + tl, y);
  ctx.lineTo(x + w - tr, y);
  if (tr) ctx.quadraticCurveTo(x + w, y, x + w, y + tr); else ctx.lineTo(x + w, y);
  ctx.lineTo(x + w, y + h - br);
  if (br) ctx.quadraticCurveTo(x + w, y + h, x + w - br, y + h); else ctx.lineTo(x + w, y + h);
  ctx.lineTo(x + bl, y + h);
  if (bl) ctx.quadraticCurveTo(x, y + h, x, y + h - bl); else ctx.lineTo(x, y + h);
  ctx.lineTo(x, y + tl);
  if (tl) ctx.quadraticCurveTo(x, y, x + tl, y); else ctx.lineTo(x, y);
  ctx.closePath();
}
function fillRoundRectCorners(ctx, x, y, w, h, r, corners) {
  roundRectPath(ctx, x, y, w, h, r, corners);
  ctx.fill();
}

// ================== 2) ç‰ˆé¢è¨ˆç®— ==================
function getTeamCanvasWidth(team) {
  const basePad = 8;
  const innerGap = 4;
  const squadCount = Math.max(1, (team.squads ? team.squads.length : 0) || 6);
  const squadWidth = 100;
  return basePad * 2 + squadCount * squadWidth + (squadCount - 1) * innerGap;
}

/* ğŸ”¹è¨ˆç®—åœ˜éšŠå¤–æ¡†çš„ã€Œéœ€è¦é«˜åº¦ã€ï¼Œç¢ºä¿èƒ½åŒ…è¦†æ‰€æœ‰å°éšŠ */
function getTeamCanvasHeight(team) {
  // èˆ‡ drawTeamBlockImage å…§éƒ¨æ•¸å€¼ä¿æŒä¸€è‡´
  const HEAD_H    = 30; // é ‚éƒ¨è‰²æ¢
  const INNER_PAD = 8;
  const TITLE_H   = 28; // å°éšŠæ¨™é¡Œå¡
  const NAME_H    = 28; // åç¨±å¡
  const SKILL_H   = 22; // æŠ€èƒ½å¡ï¼ˆä½ å‰›èª¿çš„ï¼‰
  const SP_TITLE  = 4;  // æ¨™é¡Œâ†’ç¬¬ä¸€ä½çš„è·é›¢
  const SPACER    = 4;  // æˆå“¡ä¹‹é–“è·
  const MEMBERS   = 6;

  // å…§éƒ¨å…§å®¹ç¸½é«˜ï¼ˆæ¨™é¡Œå¡ + é–“è· + 6*(åç¨±å¡+æŠ€èƒ½å¡) + 5*é–“è·ï¼‰
  const innerH =
    (2 + TITLE_H) + SP_TITLE +
    (MEMBERS * (NAME_H + SKILL_H)) +
    ((MEMBERS - 1) * SPACER);

  // å¤–æ¡† = é ‚éƒ¨è‰²æ¢ + å…§é‚Šè· + å…§å®¹ + å…§é‚Šè· + å¾®å° buffer
  return HEAD_H + INNER_PAD + innerH + INNER_PAD + 4;
}


function sortTeamsByPriority(teamsArr) {
  const order = { "é€²æ”»": 1, "æ‹†å¡”": 2, "æ©Ÿå‹•": 3, "é˜²å®ˆ": 4 };
  return [...teamsArr].sort((a, b) => (order[a.team] || 99) - (order[b.team] || 99));
}

// ================== 3) ä¸‹è¼‰åœ–ç‰‡ï¼ˆè¡Œå…§åœ˜éšŠç„¡æ°´å¹³é–“è· & å¤–æ¡†è‡ªå‹•åŒ…è¦†ï¼‰ ==================
function downloadThisWeekImage() {
  const data = getPanelData(thisWeekPanel);

  const tagOrder = ["ä¸€åœ˜","äºŒåœ˜","ä¸‰åœ˜","å››åœ˜"];
  const grouped = tagOrder
    .map(tag => ({ tag, teams: data.filter(t => (t.tag || "ä¸€åœ˜") === tag) }))
    .filter(g => g.teams.length > 0)
    .map(g => ({ tag: g.tag, teams: sortTeamsByPriority(g.teams) }));

  const rowHeaderH = 25;   // åœ˜è™Ÿç°åº•é«˜åº¦
  const rowGapY    = 12;   // åˆ—é–“è·
  const sidePad    = 20;   // ç•«å¸ƒå·¦å³é‚Šç•Œ
  const bottomPad  = 12;  // ç•«å¸ƒåº•éƒ¨ç•™ç™½ï¼ˆæ–°å¢ï¼‰
  const topPad     = 28;   // æ¨™é¡Œä¸Šæ–¹ç•™ç™½
  const titleH     = 15;   // æ¨™é¡Œé«˜åº¦

  // å…ˆé‡æ¯ä¸€åˆ—æ¯å€‹åœ˜çš„ w/hï¼Œå–å¾—åˆ—å¯¬èˆ‡åˆ—é«˜ï¼ˆå–è©²åˆ—æœ€å¤§åœ˜é«˜ï¼‰
  const rowMeasures = grouped.map(group => {
    const items = group.teams.map(team => ({
      team,
      w: getTeamCanvasWidth(team),
      h: getTeamCanvasHeight(team)
    }));
    const rowW = items.reduce((s, it) => s + it.w, 0);
    const rowH = Math.max(...items.map(it => it.h));
    return { tag: group.tag, items, rowW, rowH };
  });

  const canvasWidth  = Math.max(...rowMeasures.map(r => r.rowW + sidePad * 2), 420);
  const contentTotalH = rowMeasures.reduce((s, r) => s + (rowHeaderH + r.rowH), 0) + (rowMeasures.length - 1) * rowGapY;
  const canvasHeight = topPad + titleH + contentTotalH + sidePad;

  const SCALE = 3;
  const canvas = document.createElement("canvas");
  canvas.width = canvasWidth * SCALE;
  canvas.height = canvasHeight * SCALE;
  const ctx = canvas.getContext("2d");
  ctx.scale(SCALE, SCALE);

  // èƒŒæ™¯èˆ‡æ¨™é¡Œ
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvasWidth, canvasHeight);
  ctx.fillStyle = "#0f172a";
  ctx.font = "bold 18px system-ui";
  ctx.fillText("æœ¬é€±åå–®", sidePad, topPad);

  // é€åˆ—ç¹ªè£½
  let currentY = topPad + titleH;
  rowMeasures.forEach(row => {
    // åœ˜è™Ÿç°åº•ï¼ˆå¯¬åº¦ = è©²åˆ—æ‰€æœ‰åœ˜çš„ç¸½å¯¬ï¼‰
    const headerX = sidePad, headerW = row.rowW, headerH = rowHeaderH;
    ctx.fillStyle = "#B4BBC8";
    fillRoundRectCorners(ctx, headerX, currentY, headerW, headerH, 8, { tl:true, tr:true, br:false, bl:false });

    // åœ˜è™Ÿæ–‡å­—
    ctx.fillStyle = "#0f172a";
    ctx.font = "bold 14px system-ui";
    const tagTextW = ctx.measureText(row.tag).width;
    ctx.fillText(row.tag, headerX + (headerW - tagTextW) / 2, currentY + headerH / 2 + 5);

    // åŒè¡Œåœ˜éšŠç·Šè²¼æ’åˆ—ï¼ˆæ¯å€‹åœ˜ç”¨å„è‡ªçš„ hï¼‰
    let x = sidePad;
    const teamTopY = currentY + headerH;
    // åŒä¸€å€‹ã€Œåœ˜è™Ÿã€ï¼ˆä¸€åœ˜ / äºŒåœ˜ / ä¸‰åœ˜ï¼‰è£¡çš„å°éšŠè¦é€£è™Ÿ
let squadOffset = 1;  // é€™ä¸€åˆ—å¾ç¬¬1å°éšŠé–‹å§‹

row.items.forEach(item => {
  const team = item.team;
  const squadCount = (team.squads && team.squads.length) ? team.squads.length : 0;

  // æŠŠç›®å‰çš„èµ·å§‹å°éšŠç·¨è™Ÿä¸Ÿçµ¦é€™å€‹åœ˜
  drawTeamBlockImage(ctx, team, x, teamTopY, item.w, item.h, squadOffset);

  // ä¸‹ä¸€å€‹åœ˜çš„å°éšŠç·¨è™Ÿæ¥çºŒå¾€ä¸‹æ’
  squadOffset += squadCount;

  x += item.w;
});


    currentY += headerH + row.rowH + rowGapY;
  });

  // ä¸‹è¼‰
  const link = document.createElement("a");
  link.download = "this-week.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}

// ================== 4) å–®ä¸€å¡ç‰‡ç¹ªè£½ï¼ˆåç¨±å¡ï¼‹æŠ€èƒ½å¡åˆ†é›¢ï¼Œçš†ç”¨ crisp é‚Šç·šï¼‰ ==================
function drawTeamBlockImage(ctx, team, x, y, w, h, startIndex) {
  // å¤–æ¡†ç™½å¡ç‰‡ï¼ˆå››è§’åœ“ï¼‰
  ctx.fillStyle = "#ffffff";
  fillRoundRectCorners(ctx, x, y, w, h, 12, {tl:true,tr:true,br:true,bl:true});
  strokeRoundedCrisp(ctx, x, y, w, h, 12, {tl:true,tr:true,br:true,bl:true}, "#B4BBC8");

  // é ‚éƒ¨åœ˜éšŠè‰²æ¢ï¼ˆç„¡åœ“è§’ï¼‰
  const headColor = teamColorByName(team.team);
  const HEAD_H = 30;
  ctx.fillStyle = headColor;
  ctx.fillRect(x, y, w, HEAD_H);

  // åœ˜éšŠåç¨±
  ctx.fillStyle = "#ffffff";
  ctx.font = "bold 15px system-ui";
  const textW = ctx.measureText(team.team).width;
  ctx.fillText(team.team, x + (w - textW) / 2, y + Math.round(HEAD_H * 0.7));

  // å…§éƒ¨å°ºå¯¸
  const INNER_PAD = 8;
  const gap = 4;
  const squads = team.squads || [];
  const squadCount = Math.max(1, (squads.length || 6));
  const availW = w - INNER_PAD * 2 - gap * (squadCount - 1);
  const squadW  = availW / squadCount;
  const availH  = h - HEAD_H - INNER_PAD * 2;

  // é«˜åº¦é…ç½®ï¼ˆå¯è‡ªé©æ‡‰ï¼‰
  let TITLE_H  = 28; // å°éšŠæ¨™é¡Œï¼ˆå››è§’åœ“ç¨ç«‹å¡ï¼‰
  let NAME_H   = 28; // åç¨±å¡é«˜åº¦ï¼ˆä¸ŠåŠåœ“è§’ï¼‰
  let SKILL_H  = 22; // æŠ€èƒ½å¡é«˜åº¦ï¼ˆä¸‹åŠåœ“è§’ï¼‰
  let SP_TITLE = 4;       // æ¨™é¡Œèˆ‡ç¬¬ä¸€ä½ä¹‹é–“çš„è·é›¢
  let SPACER   = 4;       // æˆå“¡èˆ‡æˆå“¡ä¹‹é–“è·

  const totalNeed = TITLE_H + SP_TITLE + 6*(TITLE_H * 2) + 5*SPACER;
  if (totalNeed > availH) {
    const s = availH / totalNeed;
    TITLE_H  = Math.max(22, Math.floor(TITLE_H * s));
    NAME_H   = 28;
    SKILL_H  = 22;
  }

  for (let i = 0; i < squadCount; i++) {
    const sx = x + INNER_PAD + i * (squadW + gap);
    const sy = y + HEAD_H + INNER_PAD;

    // â‘  å°éšŠæ¨™é¡Œï¼ˆå››è§’åœ“ï¼Œç¨ç«‹å¡ï¼‰
const titleX = sx + 2, titleY = sy + 2, titleW = squadW - 4;
ctx.fillStyle = "#D6DDF0";
fillRoundRectCorners(ctx, titleX, titleY, titleW, TITLE_H, 8, {tl:true,tr:true,br:true,bl:true});
strokeRoundedCrisp(ctx, titleX, titleY, titleW, TITLE_H, 8, {tl:true,tr:true,br:true,bl:true}, "#B4BBC8");

// å°éšŠæ¨™é¡Œæ–‡å­—ï¼ˆæ°´å¹³ç½®ä¸­ï¼‰
ctx.fillStyle = "#0f172a";
ctx.font = "bold 13px system-ui";
const squadTitle = `ç¬¬${startIndex + i}å°éšŠ`;
const textW = ctx.measureText(squadTitle).width;
ctx.fillText(squadTitle, titleX + (titleW - textW) / 2, titleY + Math.round(TITLE_H * 0.7));


    // æ¨™é¡Œèˆ‡ç¬¬ä¸€ä½æˆå“¡ä¹‹é–“çš„ç©ºéš™ï¼ˆé¿å…æ®˜ç·šï¼‰
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(sx - 1, titleY + TITLE_H, squadW + 2, SP_TITLE);

    // â‘¡ æˆå“¡åˆ—ï¼ˆåç¨±å¡ï¼‹æŠ€èƒ½å¡åˆ†é›¢ï¼‰
    const squad = squads[i];
    let rowY = titleY + TITLE_H + SP_TITLE;

    for (let m = 0; m < 6; m++) {
      const nameBoxX = sx + 2;
      const nameBoxY = rowY;
      const nameBoxW = squadW - 4;
      const mem = (squad && squad.members[m]) ? squad.members[m] : null;

      // åç¨±å¡ï¼ˆä¸ŠåŠåœ“è§’ï¼Œç¨ç«‹å¡ï¼‰
      ctx.fillStyle = "#ffffff";
      fillRoundRectCorners(ctx, nameBoxX, nameBoxY, nameBoxW, NAME_H, 6, { tl:true, tr:true, br:false, bl:false });
      strokeRoundedCrisp(ctx, nameBoxX, nameBoxY, nameBoxW, NAME_H, 6, { tl:true, tr:true, br:false, bl:false }, "#D8E2F2");

      // å·¦å´è·æ¥­è‰²æ¢ + åç¨±æ–‡å­—
if (mem && mem.name) {
  const jobColor =
    mem.job && roleColors[mem.job]
      ? darkenHex(roleColors[mem.job], 0.25)
      : "#0f172a";

  // å·¦å´è·æ¥­è‰²æ¢ï¼ˆä¸Šåœ“ä¸‹ç›´ï¼‰
  ctx.fillStyle = jobColor;
  ctx.beginPath();
  ctx.moveTo(nameBoxX, nameBoxY + 2); // ç¨å¾®ä¸‹ç§»ä¸€é»ï¼Œé¿å…è§’å¤ªå°–
  ctx.quadraticCurveTo(nameBoxX, nameBoxY, nameBoxX + 2, nameBoxY); // å·¦ä¸Šåœ“è§’åŠå¾‘ 2
  ctx.lineTo(nameBoxX + 5, nameBoxY); // ä¸Šé‚Š
  ctx.lineTo(nameBoxX + 5, nameBoxY + NAME_H); // å³é‚Š
  ctx.lineTo(nameBoxX, nameBoxY + NAME_H); // å·¦ä¸‹ç›´è§’
  ctx.closePath();
  ctx.fill();

 // åç¨±æ–‡å­—ï¼ˆè‡ªå‹•ç¸®æ”¾ + æŸ”åšå¹³è¡¡ç‰ˆï¼‰
ctx.fillStyle = jobColor;
let fontSize = 15;
ctx.font = `bold ${fontSize}px system-ui`;
let textWidth = ctx.measureText(mem.name).width;

// è‹¥æ–‡å­—è¶…å‡ºå¡ç‰‡å¯¬åº¦ï¼ˆæ‰£æ‰å·¦å³é‚Šè·ï¼‰
const maxWidth = nameBoxW - 12;
while (textWidth > maxWidth && fontSize > 10) {
  fontSize -= 0.5;
  ctx.font = `bold ${fontSize}px system-ui`;
  textWidth = ctx.measureText(mem.name).width;
}

// æ¨¡æ“¬åŠ ç²—ï¼šè¼•é‡é›™å±¤ shadow ç–Šæé‚Šï¼ˆæŸ”åšä¸ç³Šï¼‰
ctx.shadowColor = jobColor;
ctx.shadowBlur = 0;
ctx.shadowOffsetX = 0.6;  // â† æ°´å¹³é™°å½±ç•¥å¢
ctx.shadowOffsetY = 0.6;  // â† å‚ç›´é™°å½±ç•¥å¢
ctx.fillText(mem.name, nameBoxX + 7, nameBoxY + Math.round(NAME_H * 0.75));

// åå‘å†ç–Šä¸€æ¬¡ï¼Œè®“ç­†ç•«åšåº¦æ›´å‡å‹»
ctx.shadowOffsetX = -0.4;
ctx.shadowOffsetY = -0.4;
ctx.fillText(mem.name, nameBoxX + 7, nameBoxY + Math.round(NAME_H * 0.75));

// æœ€ä¸Šå±¤ä¸»å­—ï¼šéŠ³åˆ©ä¹¾æ·¨æ”¶é‚Š
ctx.shadowColor = "transparent";
ctx.fillText(mem.name, nameBoxX + 7, nameBoxY + Math.round(NAME_H * 0.75));



}


      rowY += NAME_H; // æ¥è‘—ç•«æŠ€èƒ½å¡

      // æŠ€èƒ½å¡ï¼ˆä¸‹åŠåœ“è§’ï¼Œç¨ç«‹å¡ï¼‰
      const skillBoxX = sx + 2;
      const skillBoxY = rowY;
      const skillBoxW = squadW - 4;
      const hasSkill = !!(mem && mem.skill && mem.skill.trim());

      ctx.fillStyle = hasSkill ? "#FFFFDB" : "#ffffff";
      fillRoundRectCorners(ctx, skillBoxX, skillBoxY, skillBoxW, SKILL_H, 6, { tl:false, tr:false, br:true, bl:true });
      strokeRoundedCrisp(ctx, skillBoxX, skillBoxY, skillBoxW, SKILL_H, 6, { tl:false, tr:false, br:true, bl:true }, "#D8E2F2");

      if (hasSkill) {
        ctx.fillStyle = "#0f172a";
        ctx.font = "bold 12px system-ui";
        ctx.fillText(mem.skill, skillBoxX + 8, skillBoxY + Math.round(SKILL_H * 0.75));
      }
      rowY += SKILL_H;
      // æˆå“¡ä¹‹é–“çš„é–“è·
      if (m !== 5) {
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(sx - 1, rowY, squadW + 2, SPACER);
        rowY += SPACER;
      }
    }
  }
}
// ä»¥ä¸Šé€™æ®µ V14.7 å®Œæ•´ä¸‹è¼‰åœ–ç‰‡åŠŸèƒ½ï¼ˆåç¨±/æŠ€èƒ½å…©å¼µç¨ç«‹å¡ï¼‰

/*V17.2 æ”¹æˆå·¦éµåˆ‡æ›ç‹€æ…‹ */
function onNameCellClick(e, input) {
  if (!input) return;
  const isThisWeekName =
    input.dataset.side === "this" && input.dataset.role === "name";
  const hasValue = (input.value || "").trim() !== "";
  // æœ¬é€±åå–® + æœ‰åå­—ï¼šå·¦éµç›´æ¥åˆ‡æ›å‡ºå¸­ç‹€æ…‹
  if (isThisWeekName && hasValue) {
    if (e) {
      e.preventDefault();
      e.stopPropagation();
    }
    cycleCellStatus(input);  // present / late / unsure / absent è¼ªæµ
    return;
  }
  // å…¶ä»–æƒ…æ³ï¼ˆæˆ–æ˜¯ç©ºç™½æ ¼ï¼‰ç¶­æŒåŸæœ¬ï¼šé»ç©ºæ ¼æ‰é–‹æœå°‹
  maybeOpenMemberPicker(e, input);
}

/* V15 ä¿®æ­£æœ¬é€±æˆå“¡é»æ“Šå•é¡Œ */
function maybeOpenMemberPicker(e, input) {
  // ç¾åœ¨åªæœ‰æœ¬é€±æ¬„ä½ï¼Œç›´æ¥ä¾ç…§ã€Œæ˜¯å¦åªè®€ / æ˜¯å¦æœ‰å€¼ã€æ±ºå®šè¡Œç‚º
  if (input.readOnly) return;
  const hasValue = (input.value || "").trim() !== "";
  // å…ˆæ“‹æ‰ç€è¦½å™¨é è¨­è¡Œç‚ºï¼ˆé¿å…åˆé–‹éµç›¤ï¼‰
  if (e) {
    e.preventDefault();
    e.stopPropagation();
  }
  // å·²ç¶“æœ‰åå­—çš„æ ¼å­ï¼šä»€éº¼éƒ½ä¸åšï¼Œåªæ˜¯ç•¶ã€Œé»ä¸åˆ°ã€
  if (hasValue) {
    input.blur();  // ä¿éšªå†æ”¶ä¸€æ¬¡æ¸¸æ¨™
    return;
  }
  // ç©ºç™½æ ¼å­ï¼šé–‹æˆå“¡æœå°‹æµ®å±¤
  input.blur();    // ç¢ºä¿ä¸ç•™ä¸‹æ¸¸æ¨™
  openMemberPicker(input);
}



  /* V14.9ï¼šæœå°‹æ¡†è²¼é½Šæ¬„ä½ä¸‹ç·£ï¼Œå·¦å³ä¾è¦å‰‡è‡ªå‹•å°é½Š */
function openMemberPicker(input){
  pickerTargetInput = input;
  const rect = input.getBoundingClientRect();
  // ä»¥æ‰€åœ¨çš„ .panel ç‚ºé‚Šç•Œï¼Œæ²’æ‰¾åˆ°å°±ç”¨æœ¬é€±åå–®
  const panel = input.closest(".panel") || thisWeekPanel;
  const panelRect = panel.getBoundingClientRect();
  const pickerWidth = 260; // æœå°‹æµ®å±¤å¯¬åº¦
  // â‘  é è¨­ï¼šæœå°‹æ¡†ã€Œå·¦é‚Šã€ = æ¬„ä½å·¦é‚Š
  //    â†’ æœ€å·¦åˆ—çš„å°éšŠæœƒé½Šå·¦å°é½Šæˆå“¡
  let left = rect.left + window.scrollX;
  // â‘¡ é™åˆ¶åœ¨ panel å…§ï¼šè¶…å‡ºæ‰è¢«ã€Œæ“ å›ä¾†ã€
  //    â†’ æœ€å³åˆ—æœƒé½Šå³ï¼Œå…¶é¤˜ä¸­é–“åªåœ¨è¶…å‡ºæ™‚å¾®èª¿
  const minLeft = panelRect.left + window.scrollX + 4;
  const maxLeft = panelRect.right + window.scrollX - pickerWidth - 4;
  if (left < minLeft) left = minLeft;
  if (left > maxLeft) left = maxLeft;
  // â‘¢ å‚ç›´ä½ç½®ï¼šç›´æ¥è²¼åœ¨æ¬„ä½åº•éƒ¨ï¼Œ**ä¸è¦ç©ºéš™**
  memberPicker.style.left = left + "px";
  memberPicker.style.top  = (rect.bottom + window.scrollY) + "px";
  memberPicker.style.display = "block";
  pickerSearch.value = "";
  renderPickerList(allMembers);
  pickerSearch.focus();
}



    function renderPickerList(list){
      pickerList.innerHTML = "";
      list.forEach(m=>{
        const item = document.createElement("div");
        item.className = "picker-item";
        item.textContent = m.name + (m.job? " ("+m.job+")": "");
        item.onclick = ()=>selectMemberFromPicker(m);
        pickerList.appendChild(item);
      });
    }
    function filterPickerList(){
      const kw = pickerSearch.value.trim();
      const list = allMembers.filter(m=>!kw || m.name.includes(kw) || (m.skill && m.skill.includes(kw)));
      renderPickerList(list);
    }


    /*V15.3æ›¿è£œåˆ—ç©ºç™½æœå°‹*/
    function selectMemberFromPicker(m){
      // â˜… 1. è‹¥æ˜¯ã€Œå¹«çœ¾ï¼‹ã€æ¨¡å¼ï¼šç›´æ¥åŠ åˆ°å¹«çœ¾æ¬„ä½ï¼Œå®Œå…¨ä¸ç¢° pickerTargetInput
  if (window.guildAddMode) {
    window.guildAddMode = false;
    addGuildTag(
      guildBattleBox,
      { name: m.name, job: m.job || getJobByName(m.name) || "" },
      { bypassRules: false }
    );
    closeMemberPicker();
    saveState();
    updateGuildBattleAndWeekComparison();
    return;
  }

  // â˜… 2. ä¸€èˆ¬æƒ…æ³ï¼šåŸæœ¬çš„æµç¨‹ï¼ˆæœ¬é€±åå–® or æ›¿è£œï¼‰ç¶­æŒä¸å‹•
  if (!pickerTargetInput) return;
  // å…ˆæ¸…æ‰ã€Œæœ¬é€±ã€è£¡åŒåçš„é‡è¤‡æˆå“¡ï¼ˆç¶­æŒä½ åŸæœ¬é‚è¼¯ï¼‰
  thisWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp => {
    if (inp !== pickerTargetInput && inp.value.trim() === m.name) {
      clearInputAndSkill(inp);
    }
  });
  pickerTargetInput.value = m.name;
  applyJobColor(pickerTargetInput, m.job);
  pickerTargetInput.dataset.dirty = "1";
  fitNameFont(pickerTargetInput);
  // â­ å€åˆ†ï¼šæœ¬é€±æ¬„ä½ vs æ›¿è£œæ¬„ä½
  if (pickerTargetInput.matches('#thisWeek input[data-role="name"]')) {
    // æœ¬é€±ï¼šç¶­æŒåŸæœ¬ skillRow çš„å¯«æ³•
    const skillRow = pickerTargetInput.parentElement.nextElementSibling;
    if (skillRow && skillRow.querySelector("input[data-role='skill']")) {
      setSkillInputValue(
        skillRow.querySelector("input[data-role='skill']"),
        m.skill || ""
      );
    }
  } else if (pickerTargetInput.matches('#subsList .sub-name')) {
    // æ›¿è£œï¼šåœ¨åŒä¸€åˆ—æ‰¾ .sub-skill
    const row = pickerTargetInput.closest('.substitute-row');
    if (row) {
      const subSkill = row.querySelector('.sub-skill');
      if (subSkill) {
        subSkill.value = m.skill || "";
      }
    }
  }
  saveState();
  // â˜… è‹¥é€™æ¬¡é¸çš„æ˜¯ã€Œæœ¬é€±åå–®ã€çš„æˆå“¡æ¬„ä½ â†’ é‡æ–°æ¯”å°
  if (pickerTargetInput &&
      pickerTargetInput.matches('#thisWeek input[data-role="name"]')) {
    updateGuildBattleAndWeekComparison();
  }
  closeMemberPicker();
}

  
    
    function closeMemberPicker(){ memberPicker.style.display = "none"; pickerTargetInput = null; }
    document.addEventListener("click", function(e){ if (!memberPicker.contains(e.target) && e.target !== pickerTargetInput) { closeMemberPicker(); } });

    function updateSkillColor(cell) {
      const skill = cell.querySelector(".skill");
      if (!skill) return;
      const text = (skill.textContent || "").trim();
      if (text) skill.style.background = "#fef9c3";
      else skill.style.background = "transparent";
    }

    async function loadState(){
      renderRoleTabs();
      renderMemberList();


      const loginStr = localStorage.getItem(LOGIN_STORAGE_KEY);
      if (loginStr) {
        try { const obj = JSON.parse(loginStr); currentUser = obj.user || null; lastLoginTime = obj.time || 0; } catch(e){}
      }

      const s = localStorage.getItem(STORAGE_KEY);
      if (s) {
        try { const localState = JSON.parse(s); applyStateToPage(localState, true); } catch(e){}
      }

      try {
        const res = await fetchWithTimeout(REMOTE_API + "?action=get", 3000);
        const data = await res.json();
        if (data && data.success && data.payload) {
          const currentLocal = localStorage.getItem(STORAGE_KEY);
          if (!currentLocal || !sameJSON(JSON.parse(currentLocal), data.payload)) {
            applyStateToPage(data.payload, false);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data.payload));
          }
          if (data.updatedAt) lastKnownUpdatedAt = data.updatedAt;
        }
      } catch(err){ console.warn("é›²ç«¯è®€å–é€¾æ™‚æˆ–å¤±æ•—", err); }

      startVersionWatcher();
      // â˜… ä¸€é–‹é é¢å°±è‡ªå‹•æ¯”å°ï¼‹è£œå¹«çœ¾ç©ºä½
  updateGuildBattleAndWeekComparison();
  maintainGuildBattlePlaceholders();
    }

    // V14.9æ ¹æ“šåå­—é•·åº¦è‡ªå‹•ç¸®æ”¾å­—é«”å¤§å°ï¼ˆåªç®¡æœ¬é€±åå–® + æ›¿è£œåå­—ï¼‰
function fitNameFont(input) {
  if (!input) return;
  const len = (input.value || "").length;
  // åŸºæœ¬é‚è¼¯ï¼š7 å­—ä»¥å…§ç¶­æŒåŸä¾†ï¼Œè¶Šé•·å°±è¶Šå°ä¸€é»
  let size = 13;        // é è¨­ï¼ˆå°æ‡‰ä½ æ‰‹æ©Ÿç‰ˆ CSS çš„ 13pxï¼‰
  if (len > 7 && len <= 9)  size = 12;
  else if (len > 9 && len <= 11) size = 11;
  else if (len > 11)         size = 10;
  input.style.fontSize = size + "px";
}
// ä¸€æ¬¡æƒææ•´å€‹ç•«é¢ä¸Šçš„åå­—æ¬„ä½ï¼Œå…¨éƒ¨å¥—ä¸€æ¬¡
function refreshAllNameFonts() {
  document
    .querySelectorAll('#thisWeek input[data-role="name"], #subsList .sub-name')
    .forEach(fitNameFont);
}


    loadState();
    // é¢æ¿èˆ‡æ›¿è£œå€ï¼šä»»ä½• input/change çš†è¦–ç‚ºç·¨è¼¯
    ["input","change"].forEach(evt=>{
    thisWeekPanel.addEventListener(evt, suppressOutlinesOnEdit, true);
    subsList.addEventListener(evt, suppressOutlinesOnEdit, true);
    });
    // æ‹–æ›³é–‹å§‹ä¹Ÿè¦–ç‚ºç·¨è¼¯ï¼ˆå³ä½¿å°šæœªæ”¾ä¸‹ï¼‰
    document.addEventListener("dragstart", suppressOutlinesOnEdit, true);
    // ä½¿ç”¨è€…åœ¨ã€Œæœ¬é€±åå–® / æ›¿è£œã€è¼¸å…¥åå­—æ™‚ï¼Œç«‹å³é‡æ–°ç®—å­—é«”å¤§å°
    
    attachIOSZoomFix();

 // V15.1ä¿®æ­£ç‰ˆâœ… åªè¦ã€Œæœ¬é€±åå–®ã€æˆ–ã€Œæ›¿è£œåå–®ã€çš„æˆå“¡æ¬„ä½è¢« focusï¼Œå°±ç«‹åˆ» blur æ‰
document.addEventListener("focusin", function (e) {
  const t = e.target;
  if (!t || !t.matches) return;

  // æœ¬é€±åå–®åå­—æ¬„ä½ ï¼‹ æ›¿è£œåˆ—åå­—æ¬„ä½ éƒ½å¥—ç”¨
  if (t.matches('#thisWeek input[data-role="name"], #subsList .sub-name')) {
    // iOS/Safari æœ‰æ™‚å€™è¦æ™šä¸€æ‹ blurï¼Œæ‰€ä»¥ç”¨ setTimeout 0
    setTimeout(() => {
      if (document.activeElement === t) {
        t.blur();        // æŠŠæ¸¸æ¨™æ”¶æ‰ï¼Œä¸è®“éµç›¤è·³å‡º
      }
    }, 0);
  }
});

    
    // âœ… iOSï¼šé¿å…æœ¬é€± / æ›¿è£œåå­—æ¬„ä½è¢«é»æ“Šæ™‚æ•´é  ZOOM IN
function attachIOSZoomFix() {
  if (!isIOS) return; // åªæœ‰ iPhone / iPad æ‰å•Ÿå‹•
  // focusinï¼šåªæœ‰ã€Œç©ºçš„æ¬„ä½ã€æ‰å¥—ä¸Š ios-zoom-fixï¼Œé¿å…å·²å¡«å¥½çš„äººåæ”¾å¤§
  document.addEventListener("focusin", function (e) {
    const t = e.target;
    if (!t || !t.matches) return;
    // åªé‡å°ã€Œæœ¬é€±åå–®çš„åå­—æ¬„ä½ã€ï¼‹ã€Œæ›¿è£œåå­—æ¬„ä½ã€
    if (t.matches('#thisWeek input[data-role="name"], #subsList .substitute-row .sub-name')) {
      // âœ… è‹¥æ¬„ä½å·²æœ‰æ–‡å­—ï¼Œå°±ä¸è¦æ”¾å¤§å­—é«”
      if ((t.value || "").trim() !== "") return;
      t.classList.add("ios-zoom-fix");
    }
  });
  // focusoutï¼šé›¢é–‹è¼¸å…¥æ¡†æ™‚ï¼ŒæŠŠ class æ‹¿æ‰ï¼Œäº¤å›çµ¦ fitNameFont æ§åˆ¶å¤§å°
  document.addEventListener("focusout", function (e) {
    const t = e.target;
    if (!t || !t.classList) return;
    if (t.classList.contains("ios-zoom-fix")) {
      t.classList.remove("ios-zoom-fix");
    }
  });
}

// V18æ‰‹æ©Ÿç‰ˆï¼šå¹«æœƒè·ä½æŠ½å±œé–‹é—œ
(function () {
  const guildSection = document.getElementById("guildSection");
  const guildToggleBtn = document.getElementById("guildToggleBtn");
  let guildBackdrop = null;
  if (!guildSection || !guildToggleBtn) return;

   // æ‰‹æ©Ÿï¼šåœ¨æŠ½å±œä¸Šç·£å¾€ä¸‹æ»‘å³å¯é—œé–‰
  let swipeStartY = null;
  guildSection.addEventListener(
    "touchstart",
    (e) => {
      if (!e.touches || e.touches.length !== 1) return;
      const rect = guildSection.getBoundingClientRect();
      const y = e.touches[0].clientY;
      // åªåœ¨ã€ŒæŠ½å±œä¸Šç·£ 60px é«˜åº¦å…§ã€å•Ÿå‹•æ‰‹å‹¢ï¼Œé¿å…å…§éƒ¨æ²å‹•æ™‚èª¤è§¸
      if (y - rect.top <= 60) {
        swipeStartY = y;
      } else {
        swipeStartY = null;
      }
    },
    { passive: true }
  );
  guildSection.addEventListener(
    "touchmove",
    (e) => {
      if (swipeStartY == null) return;
      const y = e.touches[0].clientY;
      const deltaY = y - swipeStartY;

      // å¾€ä¸‹æ»‘è¶…é 60px å°±é—œé–‰æŠ½å±œ
      if (deltaY > 60) {
        closeGuildPanel();
        swipeStartY = null;
      }
    },
    { passive: true }
  );
  guildSection.addEventListener(
    "touchend",
    () => {swipeStartY = null;},
    { passive: true }
  );
    // ğŸ”½ V18æ–°å¢æŠ½å±œä¸Šæ–¹æ‹‰æ¢ï¼šé»ä¸€ä¸‹æˆ–å¾€ä¸‹æ»‘å³å¯é—œé–‰
  const guildDrawerHeader = guildSection.querySelector(".guild-drawer-header");
  if (guildDrawerHeader) {
    // é»ä¸€ä¸‹ bar ç›´æ¥æ”¶èµ·
    guildDrawerHeader.addEventListener("click", () => {
      closeGuildPanel();
    });
    // æ‰‹æ©Ÿå¾€ä¸‹æ»‘é—œé–‰æ•ˆæœ
    let startY = null;
    guildDrawerHeader.addEventListener(
      "touchstart",
      (e) => {
        if (e.touches && e.touches.length > 0) {
          startY = e.touches[0].clientY;
        }
      },
      { passive: true }
    );
    guildDrawerHeader.addEventListener(
      "touchend",
      (e) => {
        if (startY == null) return;
        const endY = e.changedTouches[0].clientY;
        const deltaY = endY - startY;
        // æ‰‹æŒ‡å¾€ä¸‹æ»‘è¶…é 40px å°±é—œé–‰
        if (deltaY > 40) {
          closeGuildPanel();
        }
        startY = null;
      },
      { passive: true }
    );
  }


  function closeGuildPanel() {
    guildSection.classList.remove("is-open");
    if (guildBackdrop) {
      guildBackdrop.remove();
      guildBackdrop = null;
    }
  }
  guildToggleBtn.addEventListener("click", () => {
    const willOpen = !guildSection.classList.contains("is-open");
    if (willOpen) {
      guildSection.classList.add("is-open");
      // å»ºç«‹åŠé€æ˜èƒŒæ™¯ï¼Œé»èƒŒæ™¯ä¹Ÿèƒ½é—œé–‰
      guildBackdrop = document.createElement("div");
      guildBackdrop.className = "guild-backdrop";
      guildBackdrop.addEventListener("click", closeGuildPanel);
      document.body.appendChild(guildBackdrop);
    } else {
      closeGuildPanel();
    }
  });
})();

  </script>
</body>
</html>

