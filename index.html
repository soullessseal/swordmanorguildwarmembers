<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>幫戰名單比對工具 v13</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #ffffff;
      --line: #e2e8f0;
      --text: #0f172a;
      --radius: 0.75rem;
    }
    body {
      background: var(--bg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1.25rem;
      font-size: 16px;
    }
    h1 { color: #fff; margin: 0 0 .75rem; }
    .layout {
      display: grid;
      grid-template-columns: 0.65fr 1.45fr 1.45fr 0.65fr;
      gap: 1rem;
      align-items: flex-start;
    }
    .panel {
      background: var(--card);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid rgba(15, 23, 42, 0.05);
      box-shadow: 0 10px 30px rgba(0,0,0,.04);
    }
    #allMembersPanel { position: sticky; top: 1rem; z-index: 5; }
    .right-sticky-wrap {
      position: sticky; top: 1rem; z-index: 6;
      display: flex; flex-direction: column; gap: .6rem;
    }
    .right-actions-bar { display: flex; gap: .4rem; justify-content: flex-end; }
    .float-btn {
      background: #0ea5e9; border: none; color: #fff;
      padding: 0.35rem 0.75rem; border-radius: 999px;
      font-weight: 600; font-size: 0.78rem;
      cursor: pointer; white-space: nowrap;
    }
    .float-btn.secondary { background: #1f2937; }
    .float-btn.danger { background: #ef4444; }

    .member-search {
      width: 100%; padding: 0.4rem 0.5rem;
      border: 1px solid #cbd5e1; border-radius: 0.4rem;
      margin-bottom: 0.5rem; font-size: 0.85rem;
      box-sizing: border-box;
    }
    .role-tabs { display: flex; flex-wrap: wrap; gap: .35rem; margin-bottom: .5rem; }
    .role-tab {
      padding: 0.25rem 0.6rem; border-radius: 999px;
      color: #0f172a; font-size: 0.73rem; cursor: pointer;
      border: 1px solid transparent; user-select: none; white-space: nowrap;
    }
    .role-tab.active { border: 1px solid #0f172a44; }
    .member-list { border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.4rem; background: #f8fafc; }
    .member-item {
      display: flex; justify-content: space-between; gap: .35rem; align-items: center;
      background: #fff; border-radius: .35rem; padding: .3rem .35rem;
      margin-bottom: .3rem; border: 1px solid #e2e8f0; cursor: grab;
    }

    /* ================== 主體區 ================== */
    .team-block {
      border: 1px solid var(--line);
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .team-head {
      color: #fff;
      padding: 0.4rem 0.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      gap: .5rem;
    }
    .team-head-left { display:flex; align-items:center; gap:.4rem; }
    .team-tag-select {
      font-size: .78rem; font-weight: 700; border-radius: .35rem; border: none;
      padding: .2rem .45rem; background: rgba(255,255,255,0.95); color: #0f172a;
      line-height: 1.2; cursor: pointer;
    }
    .team-tag-label {
      background: rgba(255,255,255,0.95);
      color: #0f172a;
      font-size: .78rem;
      font-weight: 700;
      border-radius: .35rem;
      padding: .2rem .55rem;
    }
    .head-add-btn {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
      font-size: .65rem;
      border-radius: .35rem;
      padding: .2rem .45rem;
      cursor: pointer;
    }
    .squads { display: flex; flex-wrap: nowrap; border-top: 1px solid var(--line); width: 100%; }
    .squad { border-left: 1px solid var(--line); padding: 0.4rem 0.4rem 0.75rem; position: relative; flex: 1 1 auto; min-width: 0; }
    .squad:first-child { border-left: none; }
    .squad-title {
      background: #f8fafc;
      text-align: center;
      font-weight: 700;
      padding: 0.3rem;
      border-radius: 0.25rem;
      margin-bottom: 0.4rem;
      border: 1px solid #e2e8f0;
      font-size: 0.78rem;
    }
    /* 垃圾桶 */
    .squad-del-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      border: none;
      border-radius: 999px;
      background: #ef4444;
      color: #fff;
      font-size: 14px;
      line-height: 22px;
      text-align: center;
      cursor: pointer;
      padding: 0;
    }

    .member-row { display:flex; gap:.25rem; margin-bottom:.3rem; }
    .member-row input {
      width: 100%; font-size: 0.78rem; padding: 0.3rem 0.35rem;
      border: 1px solid #cbd5f5; border-radius: 0.25rem;
      box-sizing: border-box; font-weight: 700;
    }

    /* 高亮 */
    .highlight-new {
      background:#bbf7d0 !important;
      border:1px solid #166534 !important;
      color:#064e3b !important;
    }
    .highlight-missing {
      background:#fca5a5 !important;
      border:1px solid #b91c1c !important;
      color:#7f1d1d !important;
    }
    .outline-dabai { outline: 2px solid #a855f7; outline-offset: 2px; }
    .outline-baoan { outline: 2px solid #ef4444; outline-offset: 2px; }
    .outline-stitch { outline: 2px solid #38bdf8; outline-offset: 2px; }

    /* 成員搜尋浮層 */
    #memberPicker {
      position: absolute;
      background: #fff;
      border: 1px solid #cbd5e1;
      border-radius: .5rem;
      box-shadow: 0 15px 30px rgba(15,23,42,.12);
      width: 220px;
      display: none;
      z-index: 9999;
      padding: .4rem;
      overflow: hidden;
    }

    /* ====== 手機專用 ====== */
    @media (max-width: 1300px) {
      .layout { grid-template-columns: 1fr; }
      #allMembersPanel, .right-sticky-wrap { position: static; }
    }

    /* V13 手機：本週/上週的團改成橫向滑、一團一頁＋圓點 */
    @media (max-width: 900px) {
      /* 讓 panel 裡面真正滑的是這個 wrap */
      #thisWeekTeams,
      #lastWeekTeams {
        display: flex;
        gap: .75rem;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }
      #thisWeekTeams .team-block,
      #lastWeekTeams .team-block {
        flex: 0 0 92vw;
        min-width: 320px;
        scroll-snap-align: start;
      }
      .mobile-dots {
        display: flex;
        gap: .35rem;
        justify-content: center;
        margin-top: .4rem;
      }
      .mobile-dots .dot {
        width: 8px; height: 8px; border-radius: 999px;
        background: #cbd5e1;
      }
      .mobile-dots .dot.active {
        background: #0f172a;
      }

      /* 原本右邊那整排在手機就藏起來 */
      .right-sticky-wrap { display: none; }

      /* 手機底部固定操作列 */
      #mobileBottomBar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #0f172a;
        display: flex;
        gap: .5rem;
        justify-content: center;
        padding: .45rem .7rem .6rem;
        z-index: 9990;
      }
      #mobileBottomBar .float-btn {
        flex: 1 1 auto;
        text-align: center;
      }
      body {
        padding-bottom: 70px; /* 預留給底部列 */
      }

      /* 手機下方彈出層（替補／待處理） */
      #subs,
      #comparePanel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 65px;          /* 在底部列上面 */
        height: 33vh;
        background: #fff;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -10px 30px rgba(0,0,0,.12);
        transform: translateY(110%);
        transition: transform .25s ease-out;
        z-index: 9994;
        overflow-y: auto;
      }
      #subs.show,
      #comparePanel.show {
        transform: translateY(0);
      }

      /* 右下圓鈕 */
      #mobileFloatButtons {
        position: fixed;
        right: 12px;
        bottom: 80px;
        display: flex;
        flex-direction: column;
        gap: .5rem;
        z-index: 9995;
      }
      .circle-btn {
        width: 42px; height: 42px; border-radius: 999px;
        background: #0ea5e9;
        color: #fff;
        border: none;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 10px 25px rgba(14,165,233,.35);
      }

      /* 手機的垃圾桶再小一點 */
      .squad-del-btn {
        width: 20px;
        height: 20px;
        line-height: 20px;
        font-size: 13px;
        top: 4px;
        right: 4px;
      }
    }

    /* 手機不要讓每個小隊再自己橫向滑，交給上面整團滑 */
    @media (max-width: 900px) {
      .team-block { overflow-x: hidden; }
      .squads { overflow-x: hidden; width: 100%; }
    }
  </style>
</head>
<body>
  <h1>幫戰名單比對工具 v13</h1>

  <div class="layout">
    <!-- 左：全部成員 -->
    <div class="panel" id="allMembersPanel">
      <h3>全部成員名單</h3>
      <input id="memberSearch" class="member-search" placeholder="搜尋成員名或技能..." oninput="renderMemberList(); saveState();" />
      <div class="role-tabs" id="roleTabs"></div>
      <div class="member-list" id="memberList"></div>
      <div class="pagination">
        <button onclick="prevPage()">◀</button>
        <select id="pageSelect" onchange="jumpPage(this.value)"></select>
        <button onclick="nextPage()">▶</button>
      </div>
      <div style="margin-top:.5rem;">
        <button class="float-btn secondary" style="background:#475569;" onclick="toggleAddMember()">＋ 新增成員</button>
        <div class="add-member-form" id="addMemberForm">
          <input id="newName" placeholder="成員名稱" />
          <select id="newJob">
            <option value="">選擇職業</option>
            <option value="九靈">九靈</option>
            <option value="鐵衣">鐵衣</option>
            <option value="素問">素問</option>
            <option value="龍吟">龍吟</option>
            <option value="神相">神相</option>
            <option value="碎夢">碎夢</option>
            <option value="血河">血河</option>
          </select>
          <input id="newSkill" placeholder="成員技能（可不填）" />
          <button class="float-btn" style="width:100%;text-align:center;" onclick="addMember()">確認新增</button>
        </div>
      </div>
    </div>

    <!-- 上週 -->
    <div class="panel" id="lastWeek">
      <h3>上週名單（只讀）</h3>
      <small style="font-size:.7rem;color:#64748b;">只能透過「本週名單覆蓋上週」更新，不可手動編輯。</small>
      <!-- V13: 專門裝各團 -->
      <div id="lastWeekTeams"></div>
      <div id="lastWeekDots" class="mobile-dots" style="display:none;"></div>
    </div>

    <!-- 本週 -->
    <div class="panel" id="thisWeek">
      <h3>本週名單</h3>
      <button id="downloadBtn" class="float-btn secondary" onclick="downloadThisWeekImage()">下載圖片</button>
      <small style="font-size:.7rem;color:#64748b;">同側互拖；拖到空白視為移除；重複成員以新位置為主。</small>
      <!-- V13: 專門裝各團 -->
      <div id="thisWeekTeams"></div>
      <div id="thisWeekDots" class="mobile-dots" style="display:none;"></div>
    </div>

    <!-- 右側（桌機） -->
    <div class="right-sticky-wrap">
      <div class="right-actions-bar">
        <button class="float-btn danger" onclick="requestSave()">儲存</button>
        <button class="float-btn" onclick="compare()">比對</button>
        <button class="float-btn secondary" onclick="copyThisToLast()">本週名單覆蓋上週</button>
        <button class="float-btn secondary" onclick="undoCopy()">還原</button>
      </div>
      <div class="panel" id="subs">
        <h3>替補名單</h3>
        <p style="font-size:0.7rem;margin-top:0;">可拖進本週；拖進已有成員欄位會交換。</p>
        <div id="subsList"></div>
        <button class="float-btn secondary" style="margin-top:.5rem;" onclick="addSub()">新增替補列</button>
      </div>
      <div class="panel" id="comparePanel">
        <h3>待處理成員</h3>
        <p style="font-size:0.7rem;margin-top:0;">點一下隱藏/恢復那個人的紅綠標示</p>
        <div id="compareTags" class="compare-tags"></div>
      </div>
    </div>
  </div>

  <!-- 手機版底部操作列 -->
  <div id="mobileBottomBar" style="display:none;">
    <button class="float-btn danger" onclick="requestSave()">儲存</button>
    <button class="float-btn" onclick="compare()">比對</button>
    <button class="float-btn secondary" onclick="copyThisToLast()">本週名單覆蓋上週</button>
    <button class="float-btn secondary" onclick="undoCopy()">還原</button>
  </div>

  <!-- 手機版右下圓鈕 -->
  <div id="mobileFloatButtons" style="display:none;">
    <button class="circle-btn" onclick="toggleMobilePanel('subs')">替</button>
    <button class="circle-btn" onclick="toggleMobilePanel('comparePanel')">待</button>
  </div>

  <!-- 成員搜尋浮層 -->
  <div id="memberPicker">
    <input id="pickerSearch" placeholder="搜尋成員..." oninput="filterPickerList()" />
    <div class="picker-list" id="pickerList"></div>
  </div>

  <!-- 登入 modal 同你原本的，略 -->
  <div id="loginModal" style="display:none;">
    <!-- ... 原本的登入內容沿用 ... -->
  </div>

  <script>
// ========== V13 + 保留 V12.2 全部功能 ==========

// 先把 V13 要用到的手機樣式塞進去，這樣你不用去改 <style> 了
(function injectMobileV13Styles() {
  const css = `
  @media (max-width: 900px) {
    /* 面板裡面真正滑的容器 */
    .mobile-team-wrap {
      width: 100%;
      overflow: hidden;
    }
    .mobile-team-track {
      display: flex;
      transition: transform .28s ease;
      width: 100%;
    }
    .mobile-team-track .team-block {
      width: 100%;
      flex: 0 0 100%;
      margin-right: 0;
    }
    .mobile-dots {
      display:flex;
      justify-content:center;
      gap:6px;
      margin-top:.4rem;
    }
    .mobile-dot {
      width:8px;
      height:8px;
      border-radius:999px;
      background:#cbd5e1;
    }
    .mobile-dot.active {
      background:#0f172a;
    }

    /* 手機底部四顆主按鈕 */
    .mobile-bottom-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      gap: .35rem;
      background: rgba(15,23,42,.95);
      padding: .45rem .6rem calc(env(safe-area-inset-bottom,0) + .4rem);
      z-index: 9997;
    }
    .mobile-bottom-actions button {
      flex: 1 1 25%;
      background: #fff;
      border: none;
      border-radius: .5rem;
      font-size: .72rem;
      font-weight: 600;
      color: #0f172a;
      padding: .35rem .3rem;
    }
    body {
      padding-bottom: 4.4rem !important;
    }

    /* 右下角兩顆圓按鈕 */
    .mobile-circle-btn {
      position: fixed;
      right: .65rem;
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: #0ea5e9;
      color: #fff;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      box-shadow: 0 10px 25px rgba(15,23,42,.2);
      cursor: pointer;
    }
    #mobileSubsBtn { bottom: 4.25rem; }
    #mobileCompareBtn { bottom: 8.1rem; }

    /* 將右側原本的 panel 隱藏，改用浮出的 */
    #subs,
    #comparePanel {
      display: none;
    }
    #subs.mobile-sheet-open,
    #comparePanel.mobile-sheet-open {
      display: block;
      position: fixed;
      left: 0;
      right: 0;
      bottom: 3.2rem;
      max-height: 33vh;
      background: #fff;
      border-radius: 1rem 1rem 0 0;
      box-shadow: 0 -10px 30px rgba(15,23,42,.25);
      overflow-y: auto;
      z-index: 9999;
      margin: 0;
    }
    #mobileSheetMask {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.35);
      z-index: 9996;
      display: none;
    }

    /* 手機上小隊取消橫滑，改成跟網頁版一樣寬度，但寬度規則微調 */
    .team-block .squads {
      display: flex;
      flex-wrap: nowrap;
      overflow: hidden;
      width: 100%;
    }
    .team-block .squad {
      border-left: 1px solid var(--line);
    }
  }
  `;
  const styleEl = document.createElement('style');
  styleEl.innerHTML = css;
  document.head.appendChild(styleEl);
})();

// ===== 變數設定區（跟你原本 V12.2 完全一致） =====
const STORAGE_KEY = "guildCompareV12State";
const LOGIN_STORAGE_KEY = "guildCompareLogin";
const REMOTE_API = "https://script.google.com/macros/s/AKfycbxI39kkO1P02H-ozH3r8zD1m13ACuzcKY1db3f0wSssrooNeYLcNADntmvglirjz6Al/exec";
const LOGIN_TTL = 60 * 60 * 1000;

let currentUser = null;
let lastLoginTime = 0;
const OUTLINE_CLASS = {
  dabai: "outline-dabai",
  baoan: "outline-baoan",
  stitch: "outline-stitch",
  unknown: "outline-dabai"
};
let lastKnownUpdatedAt = null;

const teams = ["進攻","拆塔","機動","防守"];
const roleColors = {
  "九靈": "#d8b4fe",
  "鐵衣": "#fdba74",
  "素問": "#f9a8d4",
  "龍吟": "#92d46d",
  "神相": "#3b82f6",
  "碎夢": "#7dd3fc",
  "血河": "#f43f5e"
};

// ===== 這裡開始就是你原本 script 的邏輯 =====
let allMembers = [
  {id:1, name: "四季春曉川", job: "九靈", skill: "左鈎天浩意"},
  {id:2, name: "狐戀雪", job: "素問", skill: "太極圖"},
  {id:3, name: "翼歌", job: "龍吟", skill: "太極圖"},
  {id:4, name: "木子維", job: "鐵衣", skill: ""},
  {id:5, name: "給雀心裹", job: "神相", skill: ""},
  {id:6, name: "玖靨", job: "血河", skill: ""},
  {id:7, name: "阿妙", job: "素問", skill: ""},
  {id:8, name: "小葉青", job: "碎夢", skill: ""},
  {id:9, name: "破風", job: "血河", skill: "爆發"},
  {id:10, name: "青珂", job: "龍吟", skill: ""},
  {id:11, name: "煙雨", job: "九靈", skill: ""}
];
let nextMemberId = 12;
let activeRoleFilter = "";
let lastSnapshot = null;
let memberPage = 1;
const pageSize = 8;
let subCounter = 0;

const lastWeekPanel = document.getElementById("lastWeek");
const thisWeekPanel = document.getElementById("thisWeek");
const subsList = document.getElementById("subsList");
const memberList = document.getElementById("memberList");
const searchInput = document.getElementById("memberSearch");
const roleTabs = document.getElementById("roleTabs");
const compareTagsEl = document.getElementById("compareTags");

let draggingPanelInput = null;
let draggingPanelSide = null;
let dragSuccess = false;
let dragPreviewEl = null;

// 比對後可個別隱藏的人
const compareIgnore = new Set();

// 搜尋浮層用
let pickerTargetInput = null;
const memberPicker = document.getElementById("memberPicker");
const pickerList = document.getElementById("pickerList");
const pickerSearch = document.getElementById("pickerSearch");

// ========== V13 手機底部按鈕 + 浮出面板 ==========
// 這段只在手機寬度時生效
function setupMobileFloatingUI() {
  if (window.innerWidth > 900) return;

  // 建立遮罩
  let mask = document.getElementById("mobileSheetMask");
  if (!mask) {
    mask = document.createElement("div");
    mask.id = "mobileSheetMask";
    document.body.appendChild(mask);
  }

  // 建立右下角兩顆圓按鈕
  let subsBtn = document.getElementById("mobileSubsBtn");
  if (!subsBtn) {
    subsBtn = document.createElement("div");
    subsBtn.id = "mobileSubsBtn";
    subsBtn.className = "mobile-circle-btn";
    subsBtn.textContent = "替";
    subsBtn.onclick = () => toggleMobileSheet("subs");
    document.body.appendChild(subsBtn);
  }
  let cpBtn = document.getElementById("mobileCompareBtn");
  if (!cpBtn) {
    cpBtn = document.createElement("div");
    cpBtn.id = "mobileCompareBtn";
    cpBtn.className = "mobile-circle-btn";
    cpBtn.textContent = "待";
    cpBtn.onclick = () => toggleMobileSheet("compare");
    document.body.appendChild(cpBtn);
  }

  // 建立底部四顆主按鈕
  let bottomBar = document.getElementById("mobileBottomActions");
  if (!bottomBar) {
    bottomBar = document.createElement("div");
    bottomBar.id = "mobileBottomActions";
    bottomBar.className = "mobile-bottom-actions";
    bottomBar.innerHTML = `
      <button onclick="requestSave()">儲存</button>
      <button onclick="compare()">比對</button>
      <button onclick="copyThisToLast()">覆蓋上週</button>
      <button onclick="undoCopy()">還原</button>
    `;
    document.body.appendChild(bottomBar);
  }

  // 點遮罩關閉
  mask.onclick = () => {
    closeMobileSheets();
  };
}

function toggleMobileSheet(which) {
  const subsPanel = document.getElementById("subs");
  const cpPanel = document.getElementById("comparePanel");
  const mask = document.getElementById("mobileSheetMask");
  if (!subsPanel || !cpPanel) return;

  closeMobileSheets(); // 先關掉全部

  if (which === "subs") {
    subsPanel.classList.add("mobile-sheet-open");
  } else if (which === "compare") {
    cpPanel.classList.add("mobile-sheet-open");
  }
  mask.style.display = "block";
}

function closeMobileSheets() {
  const subsPanel = document.getElementById("subs");
  const cpPanel = document.getElementById("comparePanel");
  const mask = document.getElementById("mobileSheetMask");
  if (subsPanel) subsPanel.classList.remove("mobile-sheet-open");
  if (cpPanel) cpPanel.classList.remove("mobile-sheet-open");
  if (mask) mask.style.display = "none";
}

// 拖替補時如果是從浮窗拖出，要把浮窗關掉但拖曳要能繼續
function closeSubsSheetSilently() {
  const subsPanel = document.getElementById("subs");
  const mask = document.getElementById("mobileSheetMask");
  if (window.innerWidth <= 900) {
    if (subsPanel) subsPanel.classList.remove("mobile-sheet-open");
    if (mask) mask.style.display = "none";
  }
}

// ========== V13 手機滑動一團一團 ==========
function setupMobileSliders() {
  if (window.innerWidth > 900) return; // 只做手機

  makePanelSlider(thisWeekPanel, "this");
  makePanelSlider(lastWeekPanel, "last");
}

// 把 panel 底下的 team-block 包成一個可左右滑的 track
function makePanelSlider(panelEl, key) {
  if (!panelEl) return;
  // 避免重複包
  if (panelEl.querySelector(".mobile-team-wrap")) return;

  const teamBlocks = [...panelEl.querySelectorAll(".team-block")];
  if (!teamBlocks.length) return;

  const wrap = document.createElement("div");
  wrap.className = "mobile-team-wrap";

  const track = document.createElement("div");
  track.className = "mobile-team-track";

  teamBlocks.forEach(tb => {
    track.appendChild(tb);
  });

  wrap.appendChild(track);
  panelEl.appendChild(wrap);

  // dots
  const dots = document.createElement("div");
  dots.className = "mobile-dots";
  teamBlocks.forEach((_, idx) => {
    const d = document.createElement("div");
    d.className = "mobile-dot" + (idx === 0 ? " active" : "");
    d.dataset.idx = idx;
    d.onclick = () => setSliderIndex(panelEl, idx);
    dots.appendChild(d);
  });
  panelEl.appendChild(dots);

  // 滑動狀態存在 panelEl 上
  panelEl.dataset.currentIdx = "0";

  // touch 滑動
  let startX = 0;
  let current = 0;
  let isDown = false;

  track.addEventListener("touchstart", e => {
    isDown = true;
    startX = e.touches[0].clientX;
    current = parseInt(panelEl.dataset.currentIdx || "0", 10);
  });

  track.addEventListener("touchmove", e => {
    if (!isDown) return;
    const diff = e.touches[0].clientX - startX;
    // 不即時跟著移，滑完再判斷
  });

  track.addEventListener("touchend", e => {
    if (!isDown) return;
    isDown = false;
    const endX = e.changedTouches[0].clientX;
    const diff = endX - startX;
    const threshold = 40;
    let target = current;
    if (diff < -threshold) {
      target = Math.min(teamBlocks.length - 1, current + 1);
    } else if (diff > threshold) {
      target = Math.max(0, current - 1);
    }
    setSliderIndex(panelEl, target);
  });
}

function setSliderIndex(panelEl, idx) {
  const track = panelEl.querySelector(".mobile-team-track");
  const dots = panelEl.querySelectorAll(".mobile-dot");
  if (!track) return;
  panelEl.dataset.currentIdx = String(idx);
  track.style.transform = `translateX(-${idx * 100}%)`;
  dots.forEach((d,i) => {
    d.classList.toggle("active", i === idx);
  });
}

// ====== 下面開始是你原本 V12.2 的邏輯（建立團、建立小隊等等） ======
function sameJSON(a,b){return JSON.stringify(a)===JSON.stringify(b);}

function teamColorByName(name){
  if(name==="拆塔") return "#7f1d1d";
  if(name==="機動") return "#4c1d95";
  if(name==="防守") return "#1e3a8a";
  return "#0f172a";
}
function hexToRgb(hex){const s=hex.replace('#','');const n=parseInt(s,16);return {r:(n>>16)&255,g:(n>>8)&255,b:n&255};}
function rgbToHsl(r,g,b){
  r/=255; g/=255; b/=255;
  const max=Math.max(r,g,b),min=Math.min(r,g,b);
  let h,s,l=(max+min)/2;
  if(max===min){h=s=0;}
  else{
    const d=max-min;
    s = l>0.5 ? d/(2-max-min) : d/(max+min);
    switch(max){
      case r: h=(g-b)/d+(g<b?6:0); break;
      case g: h=(b-r)/d+2; break;
      case b: h=(r-g)/d+4; break;
    }
    h/=6;
  }
  return {h,s,l};
}
function hslToHex(h,s,l){
  function f(n){
    const k=(n+h*12)%12;
    const a=s*Math.min(l,1-l);
    const c=l-a*Math.max(-1, Math.min(k-3, Math.min(9-k,1)));
    return Math.round(255*c).toString(16).padStart(2,'0');
  }
  return "#"+f(0)+f(8)+f(4);
}
function darkenHex(hex, amt=0.25){
  const {r,g,b} = hexToRgb(hex);
  const {h,s,l} = rgbToHsl(r,g,b);
  const nl = Math.max(0, l - amt);
  return hslToHex(h,s,nl);
}

// 調整小隊寬度：V13 手機版要求的 22% 與 pct-2.5
function adjustSquadWidths(block) {
  const squadsContainer = block.querySelector('.squads');
  if (!squadsContainer) return;
  const squads = squadsContainer.querySelectorAll('.squad');
  const count = squads.length || 1;

  // 手機寬度
  if (window.innerWidth <= 900) {
    if (count <= 4) {
      squads.forEach(sq => { sq.style.flex = "0 0 calc(22% - 6px)"; });
    } else {
      const pct = 100 / count;
      squads.forEach(sq => { sq.style.flex = "0 0 calc(" + (pct - 2.5) + "%)"; });
    }
    return;
  }

  // 桌機版維持原本
  if (count <= 4) {
    squads.forEach(sq => { sq.style.flex = "0 0 calc(23.5% - 6px)"; });
  } else {
    const pct = 100 / count;
    squads.forEach(sq => { sq.style.flex = "0 0 calc(" + (pct - 2.3) + "%)"; });
  }
}

function handlePanelInputChange(input){
  input.dataset.dirty = "1";
  clearHighlightOnEdit(input);
  saveState();
}
function markDirty(el){ if (el) el.dataset.dirty = "1"; }

function createMemberInputs(side){
  let html = "";
  for(let i=1;i<=6;i++){
    if(side === "last"){
      html += `
        <div class="member-row">
          <input data-role="name" data-side="last" class="locked-input" placeholder="成員${i}" onclick="maybeOpenMemberPicker(event, this)" readonly>
        </div>
        <div class="member-row">
          <input data-role="skill" class="readonly-skill locked-input" placeholder="" readonly>
        </div>
      `;
    } else {
      html += `
        <div class="member-row">
          <input data-role="name" data-side="${side}" draggable="true"
            ondragstart="dragFromPanel(event)" ondragover="allowDrop(event)" ondrop="dropMember(event)"
            oncontextmenu="clearPanelCell(event)" oninput="handlePanelInputChange(this)" onclick="maybeOpenMemberPicker(event, this)" placeholder="成員${i}">
        </div>
        <div class="member-row">
          <input data-role="skill" class="readonly-skill" placeholder="" readonly>
        </div>
      `;
    }
  }
  return html;
}

function createGroupTagSelect(selected="一團") {
  const opts = ["一團","二團","三團","四團"];
  return `
    <select class="team-tag-select" onchange="markDirty(this); saveState()">
      ${opts.map(o => `<option value="${o}" ${o===selected?'selected':''}>${o}</option>`).join("")}
    </select>
  `;
}

function createSquad(idx, side, teamName){
  const sq = document.createElement("div");
  sq.className = "squad";
  sq.dataset.squad = idx;
  sq.innerHTML = `
    <div class="squad-title">第${idx}小隊</div>
    ${side==="this" ? `<button class="squad-del-btn" onclick="deleteThisSquad(this)">×</button>` : ""}
    ${createMemberInputs(side)}
  `;
  return sq;
}

function createTeamBlock(side, teamName, tag="一團"){
  const block = document.createElement("div");
  block.className = "team-block";
  block.dataset.team = teamName;
  block.dataset.side = side;
  const headColor = teamColorByName(teamName);
  block.innerHTML = `
    <div class="team-head" style="background:${headColor}">
      <div class="team-head-left">
        <span class="th-title">${side==="last"?"上週－":"本週－"}${teamName}</span>
        ${side==="last"
          ? `<span class="team-tag-label">${tag}</span>`
          : createGroupTagSelect(tag)
        }
      </div>
      <div class="head-actions">
        ${side==="this"
          ? `<button class="head-add-btn" onclick="addSquadToTeamFromHead(this)">＋ 新增小隊</button>`
          : `<button class="head-add-btn disabled" disabled>＋ 新增小隊</button>`
        }
      </div>
    </div>
    <div class="squads"></div>
  `;
  const sqs = block.querySelector(".squads");
  for(let s=1;s<=3;s++){
    sqs.appendChild(createSquad(s, side, teamName));
  }
  block.dataset.lastSquadCount = "3";
  adjustSquadWidths(block);
  return block;
}

// 建立四個團
teams.forEach(t => {
  lastWeekPanel.appendChild(createTeamBlock("last", t));
  thisWeekPanel.appendChild(createTeamBlock("this", t));
});

// 手機 UI 初始化
setupMobileFloatingUI();
setupMobileSliders();
function renumberSquads(block){
  const sqs = block.querySelectorAll(".squad");
  sqs.forEach((sq,idx)=>{
    sq.dataset.squad = idx+1;
    const title = sq.querySelector(".squad-title");
    if(title) title.textContent = `第${idx+1}小隊`;
  });
}

/* 新增小隊（保留 V12.2 的標記） */
function addSquadToTeamFromHead(btn){
  const block = btn.closest(".team-block");
  const sqs = block.querySelector(".squads");
  const side = block.dataset.side;
  const teamName = block.dataset.team;
  const count = sqs.children.length;
  const newSq = createSquad(count + 1, side, teamName);

  // 標記這是這次新增的
  newSq.dataset.newlyAdded = "1";

  sqs.appendChild(newSq);
  adjustSquadWidths(block);
  markDirty(block);
  // 不在這裡動 lastSquadCount，讓儲存時才記
  saveState();
}

function deleteThisSquad(btn){
  const squad = btn.closest(".squad");
  const block = btn.closest(".team-block");
  const parent = squad.parentElement;
  if(confirm("確定要刪除這個小隊嗎？")){
    parent.removeChild(squad);
    renumberSquads(block);
    adjustSquadWidths(block);
    markDirty(block);
    block.dataset.lastSquadCount = String(parent.children.length);
    saveState();
  }
}

function clearPanelCell(e){
  e.preventDefault();
  const input = e.target;
  if(input.dataset.role === "name" && input.dataset.side !== "last"){
    clearInputAndSkill(input);
    markDirty(input);
    saveState();
  }
}
function clearInputAndSkill(input){
  input.value = "";
  input.style.borderLeft = "";
  input.style.color = "";
  input.dataset.job = "";
  const skillRow = input.parentElement.nextElementSibling;
  if(skillRow && skillRow.querySelector("input[data-role='skill']")){
    skillRow.querySelector("input[data-role='skill']").value = "";
  }
  input.classList.remove("highlight-new","highlight-missing");
}
function clearHighlightOnEdit(input){
  input.classList.remove("highlight-new","highlight-missing");
}

/* 替補列：記得拖曳要能關掉浮窗但拖曳繼續 */
function createSubRow(name="", skill="", markDirtyFlag=false){
  const row = document.createElement("div");
  row.className = "substitute-row";
  row.draggable = true;
  row.dataset.subIndex = subCounter++;
  if (markDirtyFlag) {
    row.dataset.dirty = "1";
  }
  row.ondragstart = dragFromSub;
  row.innerHTML = `
    <input class="sub-name" placeholder="替補成員" value="${name}"
      ondragover="allowDrop(event)" ondrop="dropMember(event)" onblur="applyColorByName(this); markDirty(this); saveState();">
    <input class="sub-skill" placeholder="技能" value="${skill}" oninput="markDirty(this); saveState()">
    <button class="del-btn" onclick="deleteSub(this)">刪</button>
    <span class="sub-status"></span>
  `;
  applyColorByName(row.querySelector(".sub-name"));
  subsList.appendChild(row);
}

function addSub(){
  createSubRow("", "", true);
  saveState();
}
function deleteSub(btn){
  subsList.removeChild(btn.parentElement);
  saveState();
}
// 初始 4 列
for (let i = 0; i < 4; i++) createSubRow("", "", false);

/* 角色篩選 + 列表 */
function renderRoleTabs(){
  roleTabs.innerHTML = "";
  const allTab = document.createElement("div");
  allTab.className = "role-tab" + (activeRoleFilter==="" ? " active" : "");
  allTab.textContent = "全部";
  allTab.style.background = "#e2e8f0";
  allTab.onclick = ()=>{activeRoleFilter=""; memberPage=1; renderMemberList();};
  roleTabs.appendChild(allTab);
  Object.keys(roleColors).forEach(r=>{
    const tab = document.createElement("div");
    tab.className = "role-tab" + (activeRoleFilter===r ? " active" : "");
    tab.textContent = r;
    tab.style.background = roleColors[r];
    tab.onclick = ()=>{activeRoleFilter=r; memberPage=1; renderMemberList();};
    roleTabs.appendChild(tab);
  });
}
function getFilteredMembers(){
  const keyword = searchInput.value.trim();
  return allMembers.filter(m=>{
    const matchRole = !activeRoleFilter || m.job===activeRoleFilter;
    const matchText = !keyword || m.name.includes(keyword) || (m.skill && m.skill.includes(keyword));
    return matchRole && matchText;
  });
}
function renderMemberList(){
  const filtered = getFilteredMembers();
  const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
  if(memberPage>totalPages) memberPage = totalPages;
  const start = (memberPage-1)*pageSize;
  const pageItems = filtered.slice(start, start+pageSize);

  memberList.innerHTML = "";
  pageItems.forEach(m=>{
    const item = document.createElement("div");
    item.className = "member-item";
    item.draggable = true;
    item.ondragstart = e => dragFromMemberList(e, m);
    const darkColor = m.job && roleColors[m.job] ? darkenHex(roleColors[m.job],0.25) : "#e2e8f0";
    item.style.borderLeft = "4px solid " + darkColor;
    item.innerHTML = `
      <div class="member-left" data-id="${m.id}">
        <div class="member-name" style="color:${darkColor}">${m.name}</div>
        <div class="member-skill">${m.skill || ""}</div>
      </div>
      <div class="member-actions" id="member-actions-${m.id}">
        <button onclick="startInlineEdit(${m.id})">編</button>
        <button onclick="deleteMember(${m.id})">刪</button>
      </div>
    `;
    memberList.appendChild(item);
  });

  const sel = document.getElementById("pageSelect");
  sel.innerHTML = "";
  for(let p=1;p<=totalPages && p<=8;p++){
    const opt = document.createElement("option");
    opt.value = p;
    opt.textContent = "第 " + p + " 頁";
    if(p===memberPage) opt.selected = true;
    sel.appendChild(opt);
  }
}
function prevPage(){ if(memberPage>1){ memberPage--; renderMemberList(); } }
function nextPage(){
  const totalPages = Math.max(1, Math.ceil(getFilteredMembers().length / pageSize));
  if(memberPage<totalPages){ memberPage++; renderMemberList(); }
}
function jumpPage(p){ memberPage = parseInt(p,10); renderMemberList(); }

function toggleAddMember(){
  const form = document.getElementById("addMemberForm");
  form.style.display = form.style.display==="flex" ? "none" : "flex";
}
function addMember(){
  const name = document.getElementById("newName").value.trim();
  const job = document.getElementById("newJob").value;
  const skill = document.getElementById("newSkill").value.trim();
  if(!name || !job){ alert("成員名稱與職業必填"); return; }
  allMembers.push({id: ++nextMemberId, name, job, skill});
  document.getElementById("newName").value = "";
  document.getElementById("newJob").value = "";
  document.getElementById("newSkill").value = "";
  renderMemberList();
  document.getElementById("addMemberForm").style.display = "none";
  saveState();
}

/* 成員 inline 編輯 */
function startInlineEdit(id){
  const item = [...memberList.querySelectorAll(".member-left")].find(div=>parseInt(div.dataset.id,10)===id);
  if(!item) return;
  const m = allMembers.find(x=>x.id===id);
  const actionArea = document.getElementById(`member-actions-${id}`);
  if(actionArea) actionArea.style.display = "none";
  item.innerHTML = `
    <input class="edit-input" id="edit-name-${id}" value="${m.name}">
    <select class="edit-input" id="edit-job-${id}">
      <option value="九靈" ${m.job==="九靈"?"selected":""}>九靈</option>
      <option value="鐵衣" ${m.job==="鐵衣"?"selected":""}>鐵衣</option>
      <option value="素問" ${m.job==="素問"?"selected":""}>素問</option>
      <option value="龍吟" ${m.job==="龍吟"?"selected":""}>龍吟</option>
      <option value="神相" ${m.job==="神相"?"selected":""}>神相</option>
      <option value="碎夢" ${m.job==="碎夢"?"selected":""}>碎夢</option>
      <option value="血河" ${m.job==="血河"?"selected":""}>血河</option>
    </select>
    <input class="edit-input" id="edit-skill-${id}" value="${m.skill||""}">
    <div style="display:flex;gap:.3rem;">
      <button class="float-btn" style="font-size:.65rem;padding:.2rem .4rem;" onclick="saveInlineEdit(${id})">儲存</button>
      <button class="float-btn secondary" style="font-size:.65rem;padding:.2rem .4rem;" onclick="renderMemberList()">取消</button>
    </div>
  `;
}
function saveInlineEdit(id){
  const name = document.getElementById("edit-name-"+id).value.trim();
  const job = document.getElementById("edit-job-"+id).value.trim();
  const skill = document.getElementById("edit-skill-"+id).value.trim();
  const idx = allMembers.findIndex(x=>x.id===id);
  if(idx>-1){
    allMembers[idx] = {id, name, job, skill};
    renderMemberList();
    saveState();
  }
}
function deleteMember(id){
  const idx = allMembers.findIndex(x=>x.id===id);
  if(idx>-1){ allMembers.splice(idx,1); renderMemberList(); saveState(); }
}

/* 拖曳預覽 */
function showDragPreview(text, color){
  dragPreviewEl = document.createElement("div");
  dragPreviewEl.className = "drag-preview";
  dragPreviewEl.textContent = text;
  dragPreviewEl.style.background = color || "#0f172a";
  document.body.appendChild(dragPreviewEl);
  document.addEventListener("dragover", movePreview);
}
function movePreview(e){
  if(dragPreviewEl){
    dragPreviewEl.style.left = e.pageX + 10 + "px";
    dragPreviewEl.style.top = e.pageY + 10 + "px";
  }
}
function hideDragPreview(){
  if(dragPreviewEl){
    document.body.removeChild(dragPreviewEl);
    dragPreviewEl = null;
    document.removeEventListener("dragover", movePreview);
  }
}

function dragFromMemberList(e, m){
  e.dataTransfer.setData("text/plain", JSON.stringify(m));
  const color = m.job && roleColors[m.job] ? darkenHex(roleColors[m.job],0.25) : "#0f172a";
  showDragPreview(`${m.name} (${m.job||""})`, color);
}
function dragFromSub(e){
  const row = e.currentTarget;
  const name = row.querySelector(".sub-name").value.trim();
  const skill = row.querySelector(".sub-skill").value.trim();
  if(!name){ e.preventDefault(); return; }
  const job = getJobByName(name) || row.querySelector(".sub-name").dataset.job || "";
  // 手機版：拖出視窗就收起來
  closeSubsSheetSilently();
  e.dataTransfer.setData("text/plain", JSON.stringify({name, skill, job, fromSub: row.dataset.subIndex}));
  const color = job && roleColors[job] ? darkenHex(roleColors[job],0.25) : "#0f172a";
  showDragPreview(`${name} (${job||""})`, color);
}
function dragFromPanel(e){
  const input = e.target;
  if(input.dataset.side === "last") {
    e.preventDefault();
    return;
  }
  const side = input.dataset.side;
  const name = input.value.trim();
  let skill = "";
  const skillRow = input.parentElement.nextElementSibling;
  if(skillRow && skillRow.querySelector('input[data-role="skill"]')){
    skill = skillRow.querySelector('input[data-role="skill"]').value;
  }
  const job = input.dataset.job || getJobByName(name) || "";
  draggingPanelInput = input;
  draggingPanelSide = side;
  dragSuccess = false;
  e.dataTransfer.setData("text/plain", JSON.stringify({name, skill, job, fromPanel: true, side}));
  const color = job && roleColors[job] ? darkenHex(roleColors[job],0.25) : "#0f172a";
  showDragPreview(`${name || "空欄位"} ${job? "(" + job + ")":""}`, color);
}
document.addEventListener("dragend", function(){
  hideDragPreview();
  if(draggingPanelInput && !dragSuccess){
    clearInputAndSkill(draggingPanelInput);
    saveState();
  }
  draggingPanelInput = null;
  draggingPanelSide = null;
});

function allowDrop(ev){ ev.preventDefault(); }

function getJobByName(name){
  const m = allMembers.find(x=>x.name===name);
  return m ? m.job : "";
}
function applyJobColor(input, job){
  if(!input) return;
  if(job && roleColors[job]){
    const dark = darkenHex(roleColors[job],0.25);
    input.style.borderLeft = "6px solid " + dark;
    input.style.color = dark;
    input.style.fontWeight = "700";
    input.dataset.job = job;
  } else {
    input.style.borderLeft = "";
    input.style.color = "";
    input.dataset.job = "";
    input.style.fontWeight = "700";
  }
}
function applyColorByName(input){
  const name = input.value.trim();
  const job = getJobByName(name);
  applyJobColor(input, job);
}
function clearDuplicateInPanel(panelEl, name, exceptInput){
  panelEl.querySelectorAll("input[data-role='name']").forEach(inp=>{
    if(inp !== exceptInput && inp.value.trim() === name){
      clearInputAndSkill(inp);
    }
  });
}

/* 儲存標記收集：小隊新增 → 只圈小隊標題 */
function collectDirtyMarks() {
  const marks = [];

  // 本週面板的格子
  thisWeekPanel.querySelectorAll("[data-dirty='1']").forEach(el => {
    const teamBlock = el.closest(".team-block");
    if (teamBlock) {
      const team = teamBlock.dataset.team;
      if (el.classList.contains("team-tag-select")) {
        marks.push({type:"team-tag", team});
      } else {
        const squadEl = el.closest(".squad");
        if (squadEl) {
          const squadIdx = Array.from(squadEl.parentElement.children).indexOf(squadEl);
          const nameInputs = squadEl.querySelectorAll("input[data-role='name']");
          const memberIdx = Array.from(nameInputs).indexOf(el);
          if (memberIdx !== -1) {
            marks.push({type:"member", team, squad: squadIdx, member: memberIdx});
          }
        }
      }
    }
  });

  // 檢查小隊數量變化 → 只框有 newlyAdded 的
  thisWeekPanel.querySelectorAll(".team-block").forEach(block => {
    const team = block.dataset.team;
    const squads = block.querySelectorAll(".squad");
    const squ = squads.length;
    const orig = block.dataset.lastSquadCount ? parseInt(block.dataset.lastSquadCount) : squ;

    squads.forEach((sqEl, idx) => {
      if (sqEl.dataset.newlyAdded === "1") {
        marks.push({ type: "squadNew", team, squad: idx });
        delete sqEl.dataset.newlyAdded;
      }
    });

    block.dataset.lastSquadCount = String(squ);
  });

  // 替補
  subsList.querySelectorAll("[data-dirty='1']").forEach(el => {
    const row = el.closest(".substitute-row");
    if (row) {
      const idx = Array.from(subsList.children).indexOf(row);
      marks.push({type:"sub", index: idx});
    }
  });

  return marks;
}

function renderRecentMarks(recentMarks) {
  clearAllOutlines();
  if (!recentMarks || !recentMarks.user || !recentMarks.marks) return;
  const cls = OUTLINE_CLASS[recentMarks.user] || "outline-dabai";

  recentMarks.marks.forEach(m => {
    if (m.type === "member") {
      const block = thisWeekPanel.querySelector(`.team-block[data-team="${m.team}"]`);
      if (!block) return;
      const squads = block.querySelectorAll(".squads .squad");
      const sq = squads[m.squad];
      if (!sq) return;
      const names = sq.querySelectorAll("input[data-role='name']");
      const inp = names[m.member];
      if (inp) inp.classList.add(cls);
    } 
    else if (m.type === "team-tag") {
      const block = thisWeekPanel.querySelector(`.team-block[data-team="${m.team}"]`);
      if (block) {
        const sel = block.querySelector(".team-tag-select");
        if (sel) sel.classList.add(cls);
      }
    } 
    else if (m.type === "sub") {
      const row = subsList.children[m.index];
      if (row) row.classList.add(cls);
    }
    else if (m.type === "squadNew") {
      const block = thisWeekPanel.querySelector(`.team-block[data-team="${m.team}"]`);
      if (!block) return;
      const squads = block.querySelectorAll(".squad");
      const newsq = squads[m.squad];
      if (newsq) {
        const title = newsq.querySelector(".squad-title");
        if (title) title.classList.add(cls);  // 只圈第X小隊
      }
    }
  });
}
function clearAllOutlines(){
  document.querySelectorAll(".outline-dabai, .outline-baoan, .outline-stitch").forEach(el=>{
    el.classList.remove("outline-dabai","outline-baoan","outline-stitch");
  });
}

/* drop */
function dropMember(ev){
  ev.preventDefault();
  dragSuccess = true;
  const data = ev.dataTransfer.getData("text/plain");
  if(!data) return;
  const member = JSON.parse(data);
  const target = ev.target;

  // 替補 ← 面板
  if(target.classList.contains("sub-name")){
    if (member.fromPanel && draggingPanelInput) {
      const oldName = target.value.trim();
      const oldSkill = target.parentElement.querySelector(".sub-skill").value.trim();
      const oldJob = getJobByName(oldName) || target.dataset.job || "";

      target.value = member.name;
      applyJobColor(target, member.job);
      target.parentElement.querySelector(".sub-skill").value = member.skill || "";
      markDirty(target);

      draggingPanelInput.value = oldName;
      applyJobColor(draggingPanelInput, oldJob);
      const panelSkillRow = draggingPanelInput.parentElement.nextElementSibling;
      if (panelSkillRow && panelSkillRow.querySelector('input[data-role="skill"]')) {
        panelSkillRow.querySelector('input[data-role="skill"]').value = oldSkill;
      }
      markDirty(draggingPanelInput);
      saveState();
      return;
    } else {
      target.value = member.name;
      applyJobColor(target, member.job);
      const sk = target.parentElement.querySelector(".sub-skill");
      if(sk) sk.value = member.skill ? member.skill : "";
      markDirty(target);
      saveState();
      return;
    }
  }

  if(target.dataset && target.dataset.role === "name"){
    const targetSide = target.dataset.side;
    if(targetSide === "last") {
      return;
    }
    const targetPanel = targetSide === "this" ? thisWeekPanel : lastWeekPanel;

    // 同面板互換
    if(member.fromPanel && member.side === targetSide && draggingPanelInput){
      const src = draggingPanelInput;
      if(src === target) return;
      const srcName = src.value.trim();
      const srcJob = src.dataset.job || getJobByName(srcName) || "";
      let srcSkill = "";
      const srcSkillRow = src.parentElement.nextElementSibling;
      if(srcSkillRow && srcSkillRow.querySelector('input[data-role="skill"]')){
        srcSkill = srcSkillRow.querySelector('input[data-role="skill"]').value;
      }

      const tgtName = target.value.trim();
      const tgtJob = target.dataset.job || getJobByName(tgtName) || "";
      let tgtSkill = "";
      const tgtSkillRow = target.parentElement.nextElementSibling;
      if(tgtSkillRow && tgtSkillRow.querySelector('input[data-role="skill"]')){
        tgtSkill = tgtSkillRow.querySelector('input[data-role="skill"]').value;
      }

      src.value = tgtName;
      applyJobColor(src, tgtJob);
      if(srcSkillRow) srcSkillRow.querySelector('input[data-role="skill"]').value = tgtSkill || "";
      src.classList.remove("highlight-new","highlight-missing");

      target.value = srcName;
      applyJobColor(target, srcJob);
      if(tgtSkillRow) tgtSkillRow.querySelector('input[data-role="skill"]').value = srcSkill || "";
      target.classList.remove("highlight-new","highlight-missing");
      markDirty(src);
      markDirty(target);
      saveState();
      return;
    }

    // 替補 → 面板 且面板原本有值 → 替補被換回去
    if(member.fromSub !== undefined && target.value.trim() !== ""){
      const oldName = target.value.trim();
      const oldJob = target.dataset.job || getJobByName(oldName) || "";
      let oldSkill = "";
      const skillRow = target.parentElement.nextElementSibling;
      if(skillRow && skillRow.querySelector('input[data-role="skill"]')){
        oldSkill = skillRow.querySelector('input[data-role="skill"]').value;
      }
      const subRow = subsList.querySelector(`[data-sub-index="${member.fromSub}"]`);
      if(subRow){
        subRow.querySelector(".sub-name").value = oldName;
        applyJobColor(subRow.querySelector(".sub-name"), oldJob);
        subRow.querySelector(".sub-skill").value = oldSkill;
        markDirty(subRow.querySelector(".sub-name"));
      }
    }

    // 不同面板不交換
    if(member.fromPanel && member.side !== targetSide){
      return;
    }

    target.value = member.name;
    applyJobColor(target, member.job);
    const srow = target.parentElement.nextElementSibling;
    if(srow && srow.querySelector('input[data-role="skill"]')){
      srow.querySelector('input[data-role="skill"]').value = member.skill ? member.skill : "";
    }
    target.classList.remove("highlight-new","highlight-missing");
    clearDuplicateInPanel(targetPanel, member.name, target);
    markDirty(target);
    saveState();
  }
}

/* 把畫面資料收回 JSON */
function getPanelData(panelEl){
  const data = [];
  panelEl.querySelectorAll(".team-block").forEach(block=>{
    const team = block.dataset.team;
    const tagSelect = block.querySelector(".team-tag-select");
    const label = block.querySelector(".team-tag-label");
    const groupTag = tagSelect ? tagSelect.value : (label ? label.textContent.trim() : "一團");
    const squads = [];
    block.querySelectorAll(".squads .squad").forEach(sq=>{
      const members = [];
      sq.querySelectorAll("input[data-role='name']").forEach(nameInput=>{
        const skillRow = nameInput.parentElement.nextElementSibling;
        const skillInput = skillRow ? skillRow.querySelector("input[data-role='skill']") : null;
        members.push({
          name: nameInput.value.trim(),
          job: nameInput.dataset.job || "",
          skill: skillInput ? (skillInput.value.trim() || "") : ""
        });
      });
      squads.push({members});
    });
    data.push({team, tag: groupTag, squads});
  });
  return data;
}
function setPanelData(panelEl, data, side){
  data.forEach(teamData=>{
    const block = panelEl.querySelector(`.team-block[data-team="${teamData.team}"]`);
    if(!block) return;
    if (side === "this") {
      const tagSelect = block.querySelector(".team-tag-select");
      if (tagSelect && teamData.tag) tagSelect.value = teamData.tag;
    } else {
      const label = block.querySelector(".team-tag-label");
      if (label && teamData.tag) label.textContent = teamData.tag;
    }
    const squadsContainer = block.querySelector(".squads");
    let currentCount = squadsContainer.children.length;
    const neededCount = teamData.squads.length;
    while(currentCount < neededCount){
      squadsContainer.appendChild(createSquad(currentCount+1, side, teamData.team));
      currentCount++;
    }
    while(squadsContainer.children.length > neededCount){
      squadsContainer.removeChild(squadsContainer.lastElementChild);
    }
    teamData.squads.forEach((sqData, idx)=>{
      const sqEl = squadsContainer.children[idx];
      const nameInputs = sqEl.querySelectorAll("input[data-role='name']");
      nameInputs.forEach((inp, mIdx)=>{
        const member = sqData.members[mIdx];
        if(member){
          inp.value = member.name || "";
          if(side==="last"){
            inp.classList.add("locked-input");
            inp.readOnly = true;
          }
          if(member.job){
            applyJobColor(inp, member.job);
          } else {
            applyColorByName(inp);
          }
          const skillRow = inp.parentElement.nextElementSibling;
          if(skillRow && skillRow.querySelector("input[data-role='skill']")){
            skillRow.querySelector("input[data-role='skill']").value = member.skill ? member.skill : "";
            if(side==="last"){
              const si = skillRow.querySelector("input[data-role='skill']");
              si.readOnly = true;
              si.classList.add("locked-input");
            }
          }
        } else {
          clearInputAndSkill(inp);
        }
      });
    });
    renumberSquads(block);
    block.dataset.lastSquadCount = String(neededCount || 3);
    adjustSquadWidths(block);
  });
}

/* 替補資料 */
function getSubsData(){
  const arr = [];
  subsList.querySelectorAll(".substitute-row").forEach(row=>{
    arr.push({
      name: row.querySelector(".sub-name").value.trim(),
      skill: row.querySelector(".sub-skill").value.trim()
    });
  });
  return arr;
}

/* 存 localStorage */
function saveState(){
  const state = {
    allMembers,
    lastWeek: getPanelData(lastWeekPanel),
    thisWeek: getPanelData(thisWeekPanel),
    subs: getSubsData()
  };
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}
}
function fetchWithTimeout(url, ms=3000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), ms);
  return fetch(url, {signal: ctrl.signal}).finally(()=>clearTimeout(id));
}
async function loadState(){
  renderRoleTabs();
  renderMemberList();

  // 讀登入
  const loginStr = localStorage.getItem(LOGIN_STORAGE_KEY);
  if (loginStr) {
    try {
      const obj = JSON.parse(loginStr);
      currentUser = obj.user || null;
      lastLoginTime = obj.time || 0;
    } catch(e){}
  }

  const s = localStorage.getItem(STORAGE_KEY);
  if (s) {
    try {
      const localState = JSON.parse(s);
      applyStateToPage(localState, true);
    } catch(e){}
  }

  try {
    const res = await fetchWithTimeout(REMOTE_API + "?action=get", 3000);
    const data = await res.json();
    if (data && data.success && data.payload) {
      const currentLocal = localStorage.getItem(STORAGE_KEY);
      if (!currentLocal || !sameJSON(JSON.parse(currentLocal), data.payload)) {
        applyStateToPage(data.payload, false);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data.payload));
      }
      if (data.updatedAt) lastKnownUpdatedAt = data.updatedAt;
    }
  } catch(err){ console.warn("雲端讀取逾時或失敗", err); }

  startVersionWatcher();
}
function applyStateToPage(state, fromLocal){
  if (state.allMembers && Array.isArray(state.allMembers)) {
    allMembers = state.allMembers;
    const maxId = allMembers.reduce((m,c)=>Math.max(m,c.id||0),12);
    nextMemberId = maxId + 1;
  }
  renderMemberList();

  if (state.lastWeek) {
    setPanelData(lastWeekPanel, state.lastWeek, "last");
    lastWeekPanel.querySelectorAll(".team-block").forEach(adjustSquadWidths);
  }
  if (state.thisWeek) {
    setPanelData(thisWeekPanel, state.thisWeek, "this");
    thisWeekPanel.querySelectorAll(".team-block").forEach(adjustSquadWidths);
  }
  if (state.subs) {
    subsList.innerHTML = "";
    state.subs.forEach(su => createSubRow(su.name, su.skill, false));
  }

  if (state.recentMarks) {
    renderRecentMarks(state.recentMarks);
  } else {
    clearAllOutlines();
  }

  // 手機重新包一次滑動（避免雲端抓回來後結構變了）
  if (window.innerWidth <= 900) {
    setupMobileSliders();
  }
}

/* 登入 + 儲存到後端 */
function requestSave(){
  const now = Date.now();
  if (currentUser && (now - lastLoginTime) < LOGIN_TTL) {
    doSaveToBackend();
  } else {
    showLogin();
  }
}
function showLogin(){
  document.getElementById("loginMsg").textContent = "";
  document.getElementById("loginUser").value = "";
  document.getElementById("loginPass").value = "";
  document.getElementById("loginModal").style.display = "flex";
  document.getElementById("loginUser").focus();
}
function closeLogin(){ document.getElementById("loginModal").style.display = "none"; }
function doLogin(){
  const u = document.getElementById("loginUser").value.trim();
  const p = document.getElementById("loginPass").value.trim();

  fetch(REMOTE_API, {
    method: "POST",
    body: JSON.stringify({
      action: "login",
      user: u,
      pass: p
    })
  })
  .then(r => r.json())
  .then(data => {
    if (data && data.success && data.user) {
      currentUser = data.user;
      lastLoginTime = Date.now();
      localStorage.setItem(LOGIN_STORAGE_KEY, JSON.stringify({user: currentUser, time: lastLoginTime}));
      closeLogin();
      doSaveToBackend();
    } else {
      document.getElementById("loginMsg").textContent = "帳號或密碼錯誤";
    }
  })
  .catch(err => {
    console.warn("login error", err);
    document.getElementById("loginMsg").textContent = "登入失敗";
  });
}
function doSaveToBackend(){
  const state = {
    allMembers,
    lastWeek: getPanelData(lastWeekPanel),
    thisWeek: getPanelData(thisWeekPanel),
    subs: getSubsData()
  };

  const marks = collectDirtyMarks();
  state.recentMarks = {
    user: currentUser || "unknown",
    marks
  };

  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){}

  fetch(REMOTE_API, {
    method: "POST",
    body: JSON.stringify({
      action: "save",
      payload: state
    })
  })
  .then(res=>res.json())
  .then(data=>{
    if (data && data.success) {
      alert("已儲存到後台");
      renderRecentMarks(state.recentMarks);
      document.querySelectorAll("[data-dirty='1']").forEach(el=>el.removeAttribute("data-dirty"));
    } else {
      alert("後台有回應但不是 success，請看 console");
      console.log(data);
    }
  })
  .catch(err=>{
    alert("無法連到後台，請檢查 Apps Script 部署權限");
    console.error(err);
  });
}

/* 比對 */
function compare(){
  document.querySelectorAll("input[data-role='name']").forEach(inp=>{
    inp.classList.remove("highlight-new","highlight-missing");
  });

  const lastNames = [];
  lastWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp=>{
    const v = inp.value.trim();
    if(v) lastNames.push(v);
  });
  const lastSet = new Set(lastNames);

  const thisNames = [];
  thisWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp=>{
    const v = inp.value.trim();
    if(v) thisNames.push({val:v, el:inp});
  });
  const thisSet = new Set(thisNames.map(x=>x.val));

  const newOnes = [];
  const missingOnes = [];

  thisNames.forEach(obj=>{
    if (obj.val && !lastSet.has(obj.val)) {
      if (!compareIgnore.has(obj.val)) {
        obj.el.classList.add("highlight-new");
      }
      newOnes.push(obj.val);
    }
  });

  lastWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp=>{
    const v = inp.value.trim();
    if (v && !thisSet.has(v)) {
      if (!compareIgnore.has(v)) {
        inp.classList.add("highlight-missing");
      }
      missingOnes.push(v);
    }
  });

  subsList.querySelectorAll(".substitute-row").forEach(row=>{
    const name = row.querySelector(".sub-name").value.trim();
    const status = row.querySelector(".sub-status");
    if(!name){ status.textContent = ""; return; }
    if(thisSet.has(name)){
      status.textContent = "本週已上場 ✅";
      status.style.color = "#16a34a";
    } else {
      status.textContent = "本週未上場";
      status.style.color = "#b91c1c";
    }
  });

  renderCompareTags(newOnes, missingOnes);
}
function renderCompareTags(newList, missingList){
  compareTagsEl.innerHTML = "";
  newList.forEach(name => {
    const tag = document.createElement("div");
    tag.className = "compare-tag new-tag" + (compareIgnore.has(name) ? " muted" : "");
    tag.textContent = name;
    tag.onclick = () => toggleCompareIgnore(name);
    compareTagsEl.appendChild(tag);
  });
  missingList.forEach(name => {
    const tag = document.createElement("div");
    tag.className = "compare-tag missing-tag" + (compareIgnore.has(name) ? " muted" : "");
    tag.textContent = name;
    tag.onclick = () => toggleCompareIgnore(name);
    compareTagsEl.appendChild(tag);
  });
}
function toggleCompareIgnore(name){
  if (compareIgnore.has(name)) {
    compareIgnore.delete(name);
  } else {
    compareIgnore.add(name);
    document.querySelectorAll("input[data-role='name']").forEach(inp=>{
      if (inp.value.trim() === name) {
        inp.classList.remove("highlight-new","highlight-missing");
      }
    });
  }
  compare();
}

/* 覆蓋 / 還原 */
function copyThisToLast(){
  if(!confirm("確定要用『本週名單』覆蓋『上週名單』嗎？")) return;
  lastSnapshot = JSON.stringify(getPanelData(lastWeekPanel));
  const thisData = getPanelData(thisWeekPanel);
  setPanelData(lastWeekPanel, thisData, "last");
  saveState();
  alert("已將本週名單的內容覆蓋到上週。");
}
function undoCopy(){
  if(!lastSnapshot){
    alert("沒有可還原的內容。");
    return;
  }
  const data = JSON.parse(lastSnapshot);
  setPanelData(lastWeekPanel, data, "last");
  saveState();
  alert("已還原到覆蓋前的上週名單。");
}

/* 後端版本偵測 */
function startVersionWatcher(){
  const INTERVAL = 4000;
  setInterval(async ()=>{
    try {
      const res = await fetch(REMOTE_API + "?action=version");
      const data = await res.json();
      if (data && data.success) {
        const serverUpdatedAt = data.updatedAt || null;
        if (!lastKnownUpdatedAt) {
          lastKnownUpdatedAt = serverUpdatedAt;
          return;
        }
        if (serverUpdatedAt && serverUpdatedAt !== lastKnownUpdatedAt) {
          const fullRes = await fetch(REMOTE_API + "?action=get");
          const fullData = await fullRes.json();
          if (fullData && fullData.success && fullData.payload) {
            applyStateToPage(fullData.payload, false);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(fullData.payload));
            lastKnownUpdatedAt = serverUpdatedAt;
          }
        }
      }
    } catch(err){
      console.warn("檢查版本失敗", err);
    }
  }, INTERVAL);
}

/* 下載圖片（V12.2 修正版） */
function fillRoundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  ctx.fill();
}
function getTeamCanvasWidth(team) {
  const basePad = 8;
  const gap = 4;
  const squadCount = Math.min(6, team.squads ? team.squads.length : 0) || 6;
  const squadWidth = 100;
  return basePad * 2 + squadCount * squadWidth + (squadCount - 1) * gap;
}
function downloadThisWeekImage() {
  const data = getPanelData(thisWeekPanel);
  const tagOrder = ["一團","二團","三團","四團"];
  const teamHeight = 272;
  const gapX = 20;
  const gapY = 30;

  const grouped = tagOrder.map(tag => ({
    tag,
    teams: data.filter(t => (t.tag || "一團") === tag)
  })).filter(g => g.teams.length > 0);

  let neededWidths = [];
  grouped.forEach(group => {
    let rowWidth = gapX;
    group.teams.forEach(team => {
      const w = getTeamCanvasWidth(team);
      rowWidth += w + gapX;
    });
    neededWidths.push(rowWidth);
  });

  const maxWidth = Math.max(820, ...neededWidths);

  let totalHeight = 50;
  grouped.forEach(() => {
    totalHeight += teamHeight + gapY;
  });

  const SCALE = 2;
  const canvas = document.createElement("canvas");
  canvas.width = maxWidth * SCALE;
  canvas.height = totalHeight * SCALE;
  const ctx = canvas.getContext("2d");
  ctx.scale(SCALE, SCALE);

  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, maxWidth, totalHeight);

  ctx.fillStyle = "#0f172a";
  ctx.font = "bold 22px system-ui";
  ctx.fillText("本週名單", 20, 32);

  let currentY = 50;
  grouped.forEach(group => {
    let x = gapX;
    group.teams.forEach(team => {
      const w = getTeamCanvasWidth(team);
      drawTeamBlockImage(ctx, team, x, currentY, w, teamHeight);
      x += w + gapX;
    });
    currentY += teamHeight + gapY;
  });

  const link = document.createElement("a");
  link.download = "this-week.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
}
function drawTeamBlockImage(ctx, team, x, y, w, h) {
  ctx.fillStyle = "#ffffff";
  fillRoundRect(ctx, x, y, w, h, 12);
  ctx.strokeStyle = "#e2e8f0";
  ctx.lineWidth = 1;
  ctx.strokeRect(x, y, w, h);

  const headColor = teamColorByName(team.team);
  ctx.fillStyle = headColor;
  ctx.beginPath();
  ctx.moveTo(x+12, y);
  ctx.lineTo(x+w-12, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+12);
  ctx.lineTo(x+w, y+30);
  ctx.lineTo(x, y+30);
  ctx.lineTo(x, y+12);
  ctx.quadraticCurveTo(x, y, x+12, y);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "#ffffff";
  ctx.font = "bold 15px system-ui";
  ctx.fillText("本週－" + team.team + "　(" + (team.tag || "一團") + ")", x + 12, y + 21);

  const contentY = y + 30;
  const innerPad = 8;
  const squads = team.squads || [];
  const gap = 4;
  const squadCount = Math.min(6, squads.length || 6);
  const squadWidth = (w - innerPad * 2 - gap * (squadCount - 1)) / squadCount;
  const squadHeight = h - 30 - innerPad * 2;

  for (let i = 0; i < squadCount; i++) {
    const sx = x + innerPad + i * (squadWidth + gap);
    const sy = contentY + innerPad;

    ctx.fillStyle = "#ffffff";
    fillRoundRect(ctx, sx, sy, squadWidth, squadHeight, 6);
    ctx.strokeStyle = "#e2e8f0";
    ctx.strokeRect(sx, sy, squadWidth, squadHeight);

    ctx.fillStyle = "#f8fafc";
    ctx.fillRect(sx, sy, squadWidth, 22);
    ctx.strokeStyle = "#e2e8f0";
    ctx.strokeRect(sx, sy, squadWidth, 22);
    ctx.fillStyle = "#0f172a";
    ctx.font = "bold 12px system-ui";
    ctx.fillText("第" + (i + 1) + "小隊", sx + 6, sy + 15);

    const squad = squads[i];
    let rowY = sy + 26;
    for (let m = 0; m < 6; m++) {
      ctx.fillStyle = "#e2e8f0";
      ctx.fillRect(sx, rowY, squadWidth, 18);

      if (squad && squad.members[m] && squad.members[m].name) {
        const mem = squad.members[m];
        const jobColor = mem.job && roleColors[mem.job] ? darkenHex(roleColors[mem.job], 0.25) : "#0f172a";
        ctx.fillStyle = jobColor;
        ctx.fillRect(sx, rowY, 4, 18);
        ctx.fillStyle = jobColor;
        ctx.font = "bold 11px system-ui";
        ctx.fillText(mem.name, sx + 6, rowY + 13);
      }

      rowY += 18;

      ctx.fillStyle = "#f8fafc";
      ctx.fillRect(sx, rowY, squadWidth, 14);
      ctx.strokeStyle = "#e2e8f0";
      ctx.strokeRect(sx, rowY, squadWidth, 14);
      if (squad && squad.members[m] && squad.members[m].skill) {
        ctx.fillStyle = "#0f172a";
        ctx.font = "bold 10px system-ui";
        ctx.fillText(squad.members[m].skill, sx + 4, rowY + 11);
      }
      rowY += 16;
    }
  }
}

/* 成員搜尋浮層 */
function maybeOpenMemberPicker(e, input){
  if (input.value.trim() === "") {
    openMemberPicker(input);
  }
}
function openMemberPicker(input){
  pickerTargetInput = input;
  const rect = input.getBoundingClientRect();
  memberPicker.style.left = (rect.left + window.scrollX) + "px";
  memberPicker.style.top = (rect.bottom + window.scrollY + 4) + "px";
  memberPicker.style.display = "block";
  pickerSearch.value = "";
  renderPickerList(allMembers);
  pickerSearch.focus();
}
function renderPickerList(list){
  pickerList.innerHTML = "";
  list.forEach(m=>{
    const item = document.createElement("div");
    item.className = "picker-item";
    item.textContent = m.name + (m.job? " ("+m.job+")": "");
    item.onclick = ()=>selectMemberFromPicker(m);
    pickerList.appendChild(item);
  });
}
function filterPickerList(){
  const kw = pickerSearch.value.trim();
  const list = allMembers.filter(m=>!kw || m.name.includes(kw) || (m.skill && m.skill.includes(kw)));
  renderPickerList(list);
}
function selectMemberFromPicker(m){
  if (!pickerTargetInput) return;

  thisWeekPanel.querySelectorAll("input[data-role='name']").forEach(inp => {
    if (inp !== pickerTargetInput && inp.value.trim() === m.name) {
      clearInputAndSkill(inp);
    }
  });

  pickerTargetInput.value = m.name;
  applyJobColor(pickerTargetInput, m.job);
  const skillRow = pickerTargetInput.parentElement.nextElementSibling;
  if (skillRow && skillRow.querySelector("input[data-role='skill']")) {
    skillRow.querySelector("input[data-role='skill']").value = m.skill || "";
  }
  pickerTargetInput.dataset.dirty = "1";
  saveState();
  closeMemberPicker();
}
function closeMemberPicker(){
  memberPicker.style.display = "none";
  pickerTargetInput = null;
}
document.addEventListener("click", function(e){
  if (!memberPicker.contains(e.target) && e.target !== pickerTargetInput) {
    closeMemberPicker();
  }
});

// 初始化
loadState();

</script>

</body>
</html>
